<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PERSONAL BEST TRACKER</title>

  <!-- SheetJS for Excel import/export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg1:#07162f;
      --bg2:#041022;

      --accent:#2f6bff;
      --accent2:#2bb7ff;

      /* ‚úÖ text on page background (dark blue) */
      --pageText: rgba(255,255,255,.92);
      --pageMuted: rgba(255,255,255,.70);
      --pageMuted2: rgba(255,255,255,.55);

      /* ‚úÖ text on surfaces (cards/tables/white panels) */
      --surfaceText:#0f1526;
      --surfaceMuted:rgba(15,21,38,.62);
      --surfaceMuted2:rgba(15,21,38,.46);

      --danger:#e23b57;
      --ok:#18a965;
      --warn:#c88b00;

      --radius: 22px;
      --shadow: 0 18px 60px rgba(0,0,0,.18);
      --shadow2: 0 10px 26px rgba(0,0,0,.14);

      --w: 1180px;
      --appbarH: 84px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html[data-theme="light"]{
      --bg1:#eef4ff;
      --bg2:#f6fbff;

      --pageText:#0f1526;
      --pageMuted:rgba(15,21,38,.62);
      --pageMuted2:rgba(15,21,38,.46);

      --surfaceText:#0f1526;
      --surfaceMuted:rgba(15,21,38,.62);
      --surfaceMuted2:rgba(15,21,38,.46);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      font-family: var(--font);
      color: var(--pageText);
      background:
        radial-gradient(1200px 800px at 12% 8%, rgba(47,107,255,.22), transparent 60%),
        radial-gradient(1000px 700px at 86% 18%, rgba(43,183,255,.16), transparent 58%),
        radial-gradient(900px 650px at 38% 92%, rgba(11,42,111,.32), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    button, input, select{ font-family:inherit; }

    .wrap{
      max-width: var(--w);
      margin: 0 auto;
      padding: calc(var(--appbarH) + 18px) 18px 26px;
    }

    .appbar{
      position:fixed;
      top:0; left:0; right:0;
      z-index:50;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(255,255,255,.80);
      border-bottom:1px solid rgba(15,21,38,.10);
      color: var(--surfaceText);
    }
    html[data-theme="light"] .appbar{ background: rgba(255,255,255,.88); }

    .appbarInner{
      max-width: var(--w);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 18px;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 210px;
      flex: 1 1 auto;
    }

    .avatar{
      width: 42px; height: 42px;
      border-radius: 16px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(135deg, rgba(47,107,255,.18), rgba(43,183,255,.18));
      border: 1px solid rgba(15,21,38,.10);
      box-shadow: 0 14px 30px rgba(47,107,255,.12);
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatar .emoji{ font-size: 20px; font-weight: 900; line-height: 1; }

    .brandText{ display:flex; flex-direction:column; line-height:1.12; min-width: 160px; }
    .brandText strong{ font-size: 18px; letter-spacing:.2px; font-weight: 950; }
    .brandText span{ font-size: 13px; color: var(--surfaceMuted); font-weight: 800; }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 6px;
      border:1px solid rgba(15,21,38,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      flex: 0 0 auto;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      align-items:center;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tabBtn{
      border:0;
      padding: 9px 14px;
      border-radius: 999px;
      background: transparent;
      color: rgba(15,21,38,.62);
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      transition: .18s ease;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tabBtn:hover{ color: var(--surfaceText); background: rgba(15,21,38,.05); }
    .tabBtn.active{
      color: var(--surfaceText);
      background: rgba(47,107,255,.10);
      border: 1px solid rgba(47,107,255,.18);
    }

    .giftBtn{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.82);
      width: 38px;
      height: 38px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition: .18s ease;
      flex: 0 0 auto;
    }
    .giftBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.96); }

    .rightTools{
      display:flex;
      align-items:center;
      gap: 8px;
      justify-content:flex-end;
      flex-wrap: wrap;
      flex: 1 1 520px;
      color: var(--surfaceText);
    }

    .selectWrap{ position:relative; flex: 1 1 220px; min-width: 220px; }
    .selectWrap:after{
      content:"‚ñæ";
      position:absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-52%);
      color: var(--surfaceMuted);
      pointer-events:none;
      font-size: 12px;
    }

    .select{
      width:100%;
      appearance:none;
      -webkit-appearance:none;
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--surfaceText);
      padding: 10px 34px 10px 12px;
      border-radius: 14px;
      font-weight:900;
      outline:none;
      cursor:pointer;
    }

    select, option{ color: var(--surfaceText); background-color: #ffffff; }

    .btn{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.86);
      color: var(--surfaceText);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      transition: .18s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      box-shadow: none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.96); }
    .btnPrimary{
      border: none;
      background: linear-gradient(135deg, rgba(47,107,255,.98), rgba(43,183,255,.92));
      color: white;
      box-shadow: 0 14px 34px rgba(47,107,255,.18);
    }
    .btnDanger{
      border: 1px solid rgba(226,59,87,.22);
      background: rgba(226,59,87,.10);
      color: var(--surfaceText);
    }

    /* ‚úÖ MAIN GLASS PANEL */
    .card{
      border: 1px solid rgba(255,255,255,.16);
      background:
        linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.12));
      border-radius: var(--radius);
      box-shadow:
        0 24px 70px rgba(0,0,0,.22),
        0 1px 0 rgba(255,255,255,.12) inset;
      padding: 16px;
      backdrop-filter: blur(18px) saturate(120%);
      -webkit-backdrop-filter: blur(18px) saturate(120%);
      position: relative;
      overflow: hidden;

      /* ‚úÖ text inside card should be dark (readable on translucent white surface) */
      color: var(--surfaceText);
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(900px 420px at 18% 10%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(800px 380px at 82% 12%, rgba(43,183,255,.10), transparent 60%),
        radial-gradient(900px 520px at 50% 120%, rgba(47,107,255,.12), transparent 60%);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity: .85;
    }
    .card > *{ position: relative; z-index: 1; }

    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    .title{ font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .sub{ color: var(--surfaceMuted); font-size: 13px; margin-top: 3px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,21,38,.12);
      background: rgba(15,21,38,.04);
      color: rgba(15,21,38,.70);
      font-size: 12px;
      font-weight:900;
      white-space:nowrap;
    }

    .field{ display:flex; flex-direction:column; gap: 6px; }
    .field label{ font-size: 12px; font-weight: 900; color: var(--surfaceMuted); letter-spacing:.2px; }
    .input, .select2{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--surfaceText);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight: 900;
    }
    .input:focus, .select:focus, .select2:focus{
      outline:none;
      border-color: rgba(47,107,255,.35);
      box-shadow: 0 0 0 4px rgba(47,107,255,.12);
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.80);
      color: var(--surfaceText);
    }
    .table th, .table td{
      padding: 10px 10px;
      font-size: 13px;
      border-bottom:1px solid rgba(15,21,38,.06);
      text-align:left;
      vertical-align:top;
      color: var(--surfaceText);
    }
    .table th{
      color: rgba(15,21,38,.65);
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.3px;
      background: rgba(15,21,38,.03);
    }
    .table tr:hover td{ background: rgba(47,107,255,.04); cursor:pointer; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      white-space:nowrap;
      color: rgba(15,21,38,.78);
    }
    .badgeOK{ border-color: rgba(24,169,101,.22); background: rgba(24,169,101,.10); }
    .badgePB{ border-color: rgba(200,139,0,.22); background: rgba(200,139,0,.10); }

    .iconBtn{
      border:1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      color: var(--surfaceText);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:.18s ease;
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(15,21,38,.06); }
    .iconBtnDanger{ background: rgba(226,59,87,.10); border: 1px solid rgba(226,59,87,.22); }

    .chart{
      width:100%;
      height: 260px;
      border-radius: 16px;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.78);
      overflow:hidden;
      margin-top: 12px;
      position:relative;
      color: var(--surfaceText);
    }
    .chart canvas{ width:100%; height:100%; display:block; }
    .chartHint{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 10px;
      font-size: 13px;
      color: rgba(15,21,38,.70);
      font-weight: 900;
      letter-spacing:.2px;
      text-align:center;
      white-space:nowrap;
      pointer-events:none;
    }

    .empty{
      border:1px dashed rgba(15,21,38,.18);
      border-radius: 18px;
      padding: 18px;
      color: var(--surfaceMuted);
      background: rgba(255,255,255,.60);
      margin-top: 10px;
    }
    .empty strong{ color: var(--surfaceText); }
    .empty p{ margin: 8px 0 0; font-size: 13px; line-height:1.45; }

    .banner{
      display:none;
      margin: 0 0 14px;
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(47,107,255,.18);
      background: rgba(255,255,255,.72);
      box-shadow: 0 18px 50px rgba(0,0,0,.10);
      color: var(--surfaceText);
    }
    .banner.show{ display:block; }
    .banner strong{ font-weight: 900; }
    .banner .small{ color: var(--surfaceMuted); font-size: 12px; margin-top: 3px; }

    .handWrap{
      margin-top: 12px;
      padding: 6px 2px 12px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-snap-type: x mandatory;
      display:flex;
      gap: 12px;
      align-items: stretch;
      flex-wrap: nowrap;
      width: 100%;
    }
    .handWrap::-webkit-scrollbar{ display:none; }

    .distCard{
      flex: 0 0 clamp(300px, 86vw, 380px);
      scroll-snap-align: start;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.54));
      box-shadow: var(--shadow2);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
      min-width: 300px;
      color: var(--surfaceText);
    }

    .distTop{ display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; }
    .distTitle{ display:flex; flex-direction:column; gap: 4px; min-width: 0; }
    .distTitle .big{
      font-weight: 950;
      font-size: 16px;
      line-height: 1.1;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .distTitle .small{
      font-size: 12px;
      color: var(--surfaceMuted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }
    .distStats{ display:flex; flex-direction:column; align-items:flex-end; gap: 4px; flex: 0 0 auto; }
    .distStats .pb{
      font-weight: 950;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(47,107,255,.08);
      border: 1px solid rgba(47,107,255,.16);
      white-space:nowrap;
    }
    .distStats .count{ font-size: 12px; color: var(--surfaceMuted); font-weight: 900; white-space:nowrap; }

    .distList{
      border-radius: 14px;
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.78);
      padding: 8px;
      overflow-y: auto;
      max-height: 320px;
      -webkit-overflow-scrolling: touch;
    }

    .entryItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,21,38,.08);
      background: rgba(255,255,255,.86);
      margin-bottom: 8px;
    }
    .entryItem:last-child{ margin-bottom: 0; }

    .entryMain{ display:flex; flex-direction:column; gap: 4px; min-width: 0; }
    .entryMain .line1{ display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }
    .entryMain .time{
      font-weight: 950;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,21,38,.04);
      border: 1px solid rgba(15,21,38,.08);
      white-space:nowrap;
    }
    .entryMain .meta{
      font-size: 12px;
      color: var(--surfaceMuted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }
    .entryMain .notes{
      font-size: 12px;
      color: var(--surfaceMuted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 280px;
    }

    .entryActions{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:flex-end;
      justify-content:flex-start;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 100;
      align-items:center;
      justify-content:center;
      padding: 20px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      max-height: calc(100vh - 70px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 20px;
      border: 1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      padding: 16px;
      position: relative;
      z-index: 2;
      color: var(--surfaceText);
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      background: rgba(255,255,255,.92);
      padding-bottom: 10px;
      z-index: 3;
    }
    .modalTop h3{ margin:0; font-size: 16px; font-weight: 900; color: var(--surfaceText); }
    .modalTop p{ margin:4px 0 0; color: var(--surfaceMuted); font-size: 13px; line-height:1.4; }
    .xbtn{
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      color: var(--surfaceText);
      border-radius: 12px;
      width: 38px; height: 38px;
      cursor:pointer;
      font-weight: 900;
      flex: 0 0 auto;
    }

    .error{
      display:none;
      color: #7d1424;
      background: rgba(226,59,87,.12);
      border: 1px solid rgba(226,59,87,.25);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      margin-top: 10px;
    }
    .error.show{ display:block; }

    .modalActions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 12px;
      flex-wrap:wrap;
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.92);
      padding-top: 10px;
      z-index: 3;
    }

    .entryRows{ display:flex; flex-direction:column; gap: 10px; margin-top: 8px; }
    .entryRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items:end;
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding: 10px;
    }
    .miniBtn{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.88);
      color: var(--surfaceText);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      transition:.18s ease;
      white-space:nowrap;
    }
    .miniBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.96); }
    .miniBtnDanger{ border:1px solid rgba(226,59,87,.22); background: rgba(226,59,87,.10); }

    .foot{
      margin-top: 14px;
      color: var(--surfaceMuted2);
      font-size: 12px;
      line-height:1.45;
    }

    .focusWrap{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .focusSelect{ min-width: 180px; }

    @media (min-width: 980px){
      .appbarInner{ flex-wrap: nowrap; padding: 10px 18px; }
      .rightTools{ flex-wrap: nowrap; }
      .tabs{ padding: 4px; gap: 6px; }
      .tabBtn{ padding: 8px 12px; font-size: 13px; }
      .btn{ padding: 9px 11px; border-radius: 13px; }
      .select{ padding: 9px 34px 9px 12px; border-radius: 13px; }
    }

    @media (max-width: 560px){
      /* (Will be overridden by the scrollable appbar patch below) */
      .brandText span{ display:none; }
      .rightTools{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 100%;
        justify-content:flex-start;
      }
      .selectWrap{ grid-column: 1 / -1; min-width: 100%; }
      .btn{ width: 100%; justify-content:center; }
      .entryRow{ grid-template-columns: 1fr; }
      .modal{ max-height: calc(100vh - 40px); }
      .chartHint{ white-space:normal; width: 90%; text-align:center; }
      .distList{ max-height: 52vh; }
      .focusWrap{ justify-content:flex-start; }
      .focusSelect{ min-width: 100%; }
    }

    /* =========================================================
       DARK THEME: Make key tab headings/subtexts WHITE
       (and keep LIGHT theme BLACK)
    ========================================================= */

    html[data-theme="dark"] .card{
      background: linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.18));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 24px 70px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.10) inset;
      color: var(--pageText);
    }

    html[data-theme="dark"] .card .title{
      color: rgba(255,255,255,.95) !important;
    }
    html[data-theme="dark"] .card .sub{
      color: rgba(255,255,255,.78) !important;
    }

    html[data-theme="dark"] .card .pill{
      color: rgba(255,255,255,.90) !important;
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
    }

    html[data-theme="dark"] .card .field label{
      color: rgba(255,255,255,.78) !important;
    }

    html[data-theme="dark"] .card .help,
    html[data-theme="dark"] .card #anCount{
      color: rgba(255,255,255,.78) !important;
    }

    html[data-theme="dark"] .table,
    html[data-theme="dark"] .distCard,
    html[data-theme="dark"] .empty,
    html[data-theme="dark"] .chart{
      color: var(--surfaceText);
    }

    /* =========================================================
       APPBAR PATCH (keep brand prominent; Tabs + Tools scrollable)
       ‚úÖ This OVERRIDES the grid stacking that made appbar too tall
    ========================================================= */

    @media (max-width: 760px){
      .appbarInner{
        padding: 10px 12px;
        gap: 10px;
      }
      .brand{
        min-width: unset;
      }
      .brandText strong{ font-size: 16px; }
      .brandText span{ font-size: 12px; }
    }

    @media (max-width: 560px){
      .brandText span{ display:block; }

      .tabs{
        width: 100%;
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
      }
      .tabBtn, .giftBtn{
        flex: 0 0 auto;
        scroll-snap-align: start;
      }

      .rightTools{
        width: 100%;
        display:flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 8px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding-bottom: 2px;
      }
      .rightTools::-webkit-scrollbar{ display:none; }

      .rightTools > *{
        flex: 0 0 auto !important;
      }

      .selectWrap{
        min-width: 220px !important;
        width: 220px !important;
        grid-column: unset !important;
      }
      #athleteSelect{
        width: 220px !important;
      }

      .btn{
        width: auto !important;
        justify-content:center;
        padding: 9px 10px;
      }
    }

    @media (max-width: 560px){
      .brand{
        padding-bottom: 2px;
        border-bottom: 1px solid rgba(255,255,255,.10);
      }
      html[data-theme="light"] .brand{
        border-bottom: 1px solid rgba(15,21,38,.10);
      }
    }
  </style>
</head>

<body>
  <div class="appbar">
    <div class="appbarInner">
      <div class="brand">
        <div class="avatar" id="avatarBtn" title="Click to set athlete avatar"></div>
        <div class="brandText">
          <strong>PERSONAL BEST TRACKER</strong>
          <span>Track ‚Ä¢ Improve ‚Ä¢ Celebrate</span>
        </div>
      </div>

      <!-- ‚úÖ EXPORT TAB REMOVED -->
      <div class="tabs" role="tablist" aria-label="PERSONAL BEST TRACKER Tabs">
        <button class="tabBtn active" data-tab="home">Home</button>
        <button class="tabBtn" data-tab="analytics">Analytics</button>
        <button class="tabBtn" data-tab="settings">Settings</button>
        <button class="giftBtn" id="btnHelp" title="Help / Instructions">‚ùì</button>
        <button class="giftBtn" id="btnDonate" title="Donate / Support">üéÅ</button>
      </div>

      <div class="rightTools">
        <div class="selectWrap">
          <select id="athleteSelect" class="select" title="Select Athlete"></select>
        </div>
        <button class="btn" id="btnEditAthlete">Edit</button>
        <button class="btn btnPrimary" id="btnAddAthlete">+ Add Athlete</button>
        <button class="btn" id="btnAddEntry">+ Add Race</button>
        <button class="btn btnDanger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="pbBanner" class="banner">
      <strong>üéâ New PB!</strong>
      <div class="small" id="pbBannerText">Saved.</div>
    </div>

    <section id="screenHome" class="screen active">
      <div class="card">
        <div class="cardHeader" style="margin-bottom:6px;">
          <div>
            <div class="title">PB Summary</div>
            <div class="sub">Best time for each distance.</div>
          </div>
          <div class="pill" id="pillAthlete">No athlete selected</div>
        </div>

        <div class="cardHeader" style="margin-top:10px;">
          <div class="pill" id="pillPBCount">0 PBs</div>
        </div>

        <div id="pbSummaryWrap"></div>

        <div style="height:12px;"></div>

        <div class="cardHeader" style="align-items:center;">
          <div>
            <div class="title" style="font-size:16px;">Race Cards (by distance)</div>
            <div class="sub">Swipe cards left/right</div>
          </div>

          <div class="focusWrap">
            <div class="pill" id="pillCount">0 races</div>

            <div class="field" style="min-width: 220px; margin:0;">
              <label style="margin:0; font-size:11px; font-weight:950; color:rgba(15,21,38,.66);">
                Distance Focus (for cards)
              </label>
              <select id="distanceFilter" class="select2 focusSelect"></select>
            </div>
          </div>
        </div>

        <div id="cardsWrap" class="handWrap"></div>

        <div class="foot">
          Tip: Everything is saved on this device (local storage). To view on another device, download the Excel for the selected athlete and upload it on the other device.
        </div>
      </div>
    </section>

    <section id="screenAnalytics" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Performance Snapshot</div>
            <div class="sub">Trend (Time vs Race Date) for the selected athlete and distance focus</div>
          </div>
          <div class="pill" id="pillAnalytics">‚Äî</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;" class="formGrid">
          <div class="field">
            <label>Distance Focus (for chart)</label>
            <select id="analyticsDistance" class="select2"></select>
            <div class="help" id="anCount" style="margin-top:6px; color:var(--surfaceMuted); font-weight:900;">‚Äî</div>
          </div>

          <div class="field">
            <label>PB (Selected Distance)</label>
            <div class="input" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <div style="font-weight:950;" id="anPB">‚Äî</div>
              <div style="font-size:12px; color:var(--surfaceMuted); font-weight:900;" id="anPBMeta">Select a distance to display PB</div>
            </div>
          </div>
        </div>

        <div class="chart">
          <div class="chartHint">Trend (Time vs Race Date)</div>
          <canvas id="trendCanvas" width="1200" height="420"></canvas>
          <div id="chartTip"
            style="position:fixed;display:none;pointer-events:none;
            background:rgba(255,255,255,.92);
            border-radius:14px;padding:10px 12px;
            font-weight:900;font-size:12px;
            box-shadow:0 18px 40px rgba(0,0,0,.18)">
            </div>
        </div>
      </div>
    </section>

    <!-- ‚úÖ SETTINGS now contains 2 glass panels: Preferences + Excel Import/Export -->
    <section id="screenSettings" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Settings</div>
            <div class="sub">Preferences.</div>
          </div>
          <div class="pill">Local Storage</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;" class="formGrid">
          <div class="field">
            <label>Theme</label>
            <select id="themeSelect" class="select2">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>

          <div class="field">
            <label>Time placeholder</label>
            <input id="timeHint" class="input" value="00:52.300" />
          </div>
        </div>

        <div class="empty" style="margin-top:12px;">
          <strong>Storage note</strong>
          <p>All data is stored on this device. To start fresh: Reset.</p>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Excel Import / Template</div>
            <div class="sub">Download the Excel template, fill it, and upload to import into the selected athlete.</div>
          </div>
          <div class="pill" id="pillExport">‚Äî</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="btnExportXLSX">Download Excel (selected athlete)</button>
          <button class="btn" id="btnDownloadTemplateXLSX">‚¨áÔ∏è Download Excel Template</button>
        </div>

        <div class="empty" style="margin-top:12px;">
          <strong>Upload Excel</strong>
          <p>Data from this file will be added to the currently selected athlete.</p>
          <div class="field" style="margin-top:10px;">
            <label>Choose Excel file</label>
            <input class="input" id="excelFile" type="file" accept=".xlsx,.xls" />
          </div>
          <div style="margin-top:10px;">
            <button class="btn btnPrimary" id="btnImportXLSX">Upload data to selected athlete</button>
          </div>
          <div id="importMsg" class="error"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Distance list for typing suggestions -->
  <datalist id="distanceList"></datalist>

  <!-- MODALS -->
  <div class="modalOverlay" id="modalAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Athlete</h3>
          <p>Create an athlete profile (with an avatar).</p>
        </div>
        <button class="xbtn" data-close="modalAthlete">‚úï</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" class="modalGrid">
        <div class="field">
          <label>Name</label>
          <input id="athName" class="input" placeholder="e.g., Samarveer" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="athYear" class="input" inputmode="numeric" placeholder="e.g., 2015" />
        </div>

        <div class="field" style="grid-column:1 / -1;">
          <label>Avatar Emoji (optional)</label>
          <input id="athEmoji" class="input" placeholder="Default ‚ùÑÔ∏è (example: ‚õ∏Ô∏è üèÅ ‚≠ê)" />
        </div>
      </div>

      <div id="athleteErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthlete">Save Athlete</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="modalEditAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Edit Athlete</h3>
          <p>Update athlete name (and birth year).</p>
        </div>
        <button class="xbtn" data-close="modalEditAthlete">‚úï</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" class="modalGrid">
        <div class="field">
          <label>Name</label>
          <input id="editAthName" class="input" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="editAthYear" class="input" inputmode="numeric" />
        </div>
      </div>

      <div id="editAthErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEditAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthleteEdits">Save Changes</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="modalEntry">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Race Entry</h3>
          <p>Same date + location can include multiple distances.</p>
        </div>
        <button class="xbtn" data-close="modalEntry">‚úï</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" class="modalGrid">
        <div class="field">
          <label>Date</label>
          <input id="enDate" class="input" type="date" />
        </div>

        <div class="field">
          <label>Location</label>
          <input id="enLocation" class="input" placeholder="e.g., Scarborough" />
        </div>

        <div class="field" style="grid-column:1 / -1;">
          <label>Notes (optional)</label>
          <input id="enNotes" class="input" placeholder="e.g., Meet name, lane, fall, etc." />
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>Distances & Times</label>
        <div class="entryRows" id="entryRows"></div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="miniBtn" id="btnAddRow">+ Add another distance</button>
        </div>
      </div>

      <div id="entryErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEntry">Cancel</button>
        <button class="btn btnPrimary" id="saveEntry">Save Entry</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="modalEditEntry">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Edit Entry</h3>
          <p>Fix time, distance, date, location, notes.</p>
        </div>
        <button class="xbtn" data-close="modalEditEntry">‚úï</button>
      </div>

      <input type="hidden" id="editEntryId" />

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" class="modalGrid">
        <div class="field">
          <label>Date</label>
          <input id="editEnDate" class="input" type="date" />
        </div>

        <div class="field">
          <label>Location</label>
          <input id="editEnLocation" class="input" placeholder="e.g., Scarborough" />
        </div>

        <div class="field" style="grid-column:1 / -1;">
          <label>Notes (optional)</label>
          <input id="editEnNotes" class="input" placeholder="e.g., Meet name, lane, fall, etc." />
        </div>

        <div class="field">
          <label>Distance</label>
          <input id="editEnDistance" class="input" list="distanceList" placeholder="e.g., 500m" />
        </div>

        <div class="field">
          <label>Time (mm:ss.mmm or HH:MM:SS)</label>
          <input id="editEnTime" class="input" placeholder="00:52.300 or 00:01:00" />
        </div>
      </div>

      <div id="editEntryErr" class="error"></div>

      <div class="modalActions">
        <button class="btn btnDanger" id="btnDeleteEntry">Delete</button>
        <button class="btn" data-close="modalEditEntry">Cancel</button>
        <button class="btn btnPrimary" id="btnSaveEntryEdits">Save Changes</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="modalReset">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Reset</h3>
          <p>This removes stored data on this device. Type <strong>RESET</strong> to confirm.</p>
        </div>
        <button class="xbtn" data-close="modalReset">‚úï</button>
      </div>

      <div class="field">
        <label>Type RESET</label>
        <input id="resetConfirm" class="input" placeholder="RESET" />
      </div>

      <div id="resetErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalReset">Cancel</button>
        <button class="btn btnDanger" id="doReset">Reset Everything</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="modalDonate">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>üéÅ Support / Donate</h3>
          <p>If this tracker helped you, you can support it with a small donation (PayPal).</p>
        </div>
        <button class="xbtn" data-close="modalDonate">‚úï</button>
      </div>

      <div class="empty" style="margin-top:0;">
        <strong>Choose an amount</strong>
        <p>Pick a quick amount or enter a custom value.</p>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn" data-donate="2">$2</button>
          <button class="btn" data-donate="5">$5</button>
          <button class="btn" data-donate="10">$10</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; margin-top:12px;">
          <input id="donateCustom" class="input" placeholder="Custom amount (e.g., 3.50)" inputmode="decimal" />
          <button class="btn btnPrimary" id="btnDonateCustom">Donate</button>
        </div>

        <div id="donateErr" class="error"></div>
      </div>

      <div class="foot">Thank you for your kindness üíô</div>
    </div>
  </div>

  <script>
    const PAYPAL_ME = "https://paypal.me/MandeepSardarni";

    const LS_KEY  = "pb_velocityboard_v12";
    const LS_PREF = "pb_velocityboard_prefs_v12";

    const defaultState = { athletes: [], activeAthleteId: null };
    const defaultPrefs = { defaultDistance: "ALL", timeHint: "00:52.300", theme: "dark" };

    // ‚úÖ Default distances requested
    const DEFAULT_DISTANCES = ["100m","200m","300m","400m","500m","800m","1000m","1200m","1500m"];

    let state = loadState();
    let prefs = loadPrefs();

    const tabBtns = [...document.querySelectorAll(".tabBtn")];
    const screens = {
      home: document.getElementById("screenHome"),
      analytics: document.getElementById("screenAnalytics"),
      settings: document.getElementById("screenSettings")
    };

    const athleteSelect = document.getElementById("athleteSelect");
    const distanceFilter    = document.getElementById("distanceFilter");
    const analyticsDistance = document.getElementById("analyticsDistance");
    const distanceList = document.getElementById("distanceList");

    const pbBanner = document.getElementById("pbBanner");
    const pbBannerText = document.getElementById("pbBannerText");

    const pillAthlete = document.getElementById("pillAthlete");
    const pillCount = document.getElementById("pillCount");
    const pillPBCount = document.getElementById("pillPBCount");
    const pbSummaryWrap = document.getElementById("pbSummaryWrap");
    const cardsWrap = document.getElementById("cardsWrap");

    const pillAnalytics = document.getElementById("pillAnalytics");
    const anPB = document.getElementById("anPB");
    const anPBMeta = document.getElementById("anPBMeta");
    const anCount = document.getElementById("anCount");

    // ‚úÖ now lives in Settings (Excel panel)
    const pillExport = document.getElementById("pillExport");
    const excelFile = document.getElementById("excelFile");
    const importMsg = document.getElementById("importMsg");

    const timeHint = document.getElementById("timeHint");
    const themeSelect = document.getElementById("themeSelect");

    const avatarBtn = document.getElementById("avatarBtn");

    const canvas = document.getElementById("trendCanvas");
    const ctx = canvas.getContext("2d");
    let chartLast = null;   // ‚úÖ store plotted points for click/hover


    // -----------------------------
    // Events
    // -----------------------------
    document.getElementById("btnAddAthlete").addEventListener("click", () => openModal("modalAthlete"));
    document.getElementById("btnEditAthlete").addEventListener("click", openEditAthlete);

    document.getElementById("btnAddEntry").addEventListener("click", () => {
      if(!getActiveAthlete()){
        flashBanner("Please add/select an athlete first.", false);
        openModal("modalAthlete");
        return;
      }
      openEntryModal();
    });

    document.getElementById("btnReset").addEventListener("click", () => openModal("modalReset"));
// ‚ùì Help button
    document.getElementById("btnHelp").addEventListener("click", () => {openModal("modalHelp");});
    document.getElementById("btnDonate").addEventListener("click", () => openModal("modalDonate"));
    
    document.getElementById("btnDonateCustom").addEventListener("click", ()=>{
      const v = document.getElementById("donateCustom").value.trim();
      donateAmount(v);
    });

    avatarBtn.addEventListener("click", ()=>{
      if(!getActiveAthlete()){
        flashBanner("Please add/select an athlete first.", false);
        openModal("modalAthlete");
        return;
      }
      openAvatarQuick();
    });

    document.getElementById("btnSaveEntryEdits").addEventListener("click", saveEntryEdits);
    document.getElementById("btnDeleteEntry").addEventListener("click", deleteEntryFromEditModal)
    document.getElementById("saveAthlete").addEventListener("click", saveAthlete);
    document.getElementById("saveAthleteEdits").addEventListener("click", saveAthleteEdits);
    document.getElementById("saveEntry").addEventListener("click", saveEntryMulti);
    document.getElementById("doReset").addEventListener("click", doResetAll);

    // ‚úÖ Excel buttons now in Settings (same IDs kept)
    document.getElementById("btnExportXLSX").addEventListener("click", exportXLSX);
    document.getElementById("btnDownloadTemplateXLSX").addEventListener("click", downloadTemplateXLSX);
    document.getElementById("btnImportXLSX").addEventListener("click", importXLSXIntoSelectedAthlete);

    tabBtns.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

    athleteSelect.addEventListener("change", () => {
      state.activeAthleteId = athleteSelect.value || null;
      saveState();
      renderAll(true);
    });

    distanceFilter.addEventListener("change", () => {
      analyticsDistance.value = distanceFilter.value;
      prefs.defaultDistance = distanceFilter.value;
      savePrefs();
      renderAll(true);
    });
    analyticsDistance.addEventListener("change", () => {
      distanceFilter.value = analyticsDistance.value;
      prefs.defaultDistance = analyticsDistance.value;
      savePrefs();
      renderAll(true);
    });

    themeSelect.addEventListener("change", ()=>{
      prefs.theme = themeSelect.value;
      savePrefs();
      applyTheme();
    });
    timeHint.addEventListener("input", () => {
      prefs.timeHint = timeHint.value.trim() || "00:52.300";
      savePrefs();
    });

    const entryRowsEl = document.getElementById("entryRows");
    document.getElementById("btnAddRow").addEventListener("click", () => addEntryRow());

    cardsWrap.addEventListener("click", (e) => {
      const del = e.target.closest("[data-del-entry-id]");
      if(del) return deleteEntry(del.getAttribute("data-del-entry-id"));

      const edit = e.target.closest("[data-edit-entry-id]");
      if(edit) return openEditEntryModal(edit.getAttribute("data-edit-entry-id"));
    });

    pbSummaryWrap.addEventListener("click", (e)=>{
      const tr = e.target.closest("tr[data-entry-id]");
      if(!tr) return;
      openEditEntryModal(tr.getAttribute("data-entry-id"));
    });

    // -----------------------------
// Init
// -----------------------------
init();

function init(){
  if(!state.athletes) state = structuredClone(defaultState);
  if(!prefs) prefs = structuredClone(defaultPrefs);

  applyTheme();

  timeHint.value = prefs.timeHint || "00:52.300";
  themeSelect.value = prefs.theme || "dark";

  renderAll(true);
  syncAppbarHeight();
  window.addEventListener("resize", syncAppbarHeight);
}

function applyTheme(){
  const t = prefs.theme || "dark";
  document.documentElement.setAttribute("data-theme", t);
  syncAppbarHeight();
}

function syncAppbarHeight(){
  const appbar = document.querySelector(".appbar");
  if(!appbar) return;
  const h = appbar.offsetHeight || 84;
  document.documentElement.style.setProperty("--appbarH", h + "px");
}

function switchTab(tab){
  tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
  Object.keys(screens).forEach(k => screens[k].classList.toggle("active", k === tab));
  renderAll(false);
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function openModal(id){
  clearErrors();
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.add("show");
  document.body.style.overflow = "hidden";
  syncAppbarHeight();
}

function closeModal(id){
  const el = document.getElementById(id);
  if(!el) return;

  el.classList.remove("show");

  const anyOpen = [...document.querySelectorAll(".modalOverlay")]
    .some(x => x.classList.contains("show"));

  if(!anyOpen) document.body.style.overflow = "";
  syncAppbarHeight();
}

/* =========================================================
   ‚úÖ GLOBAL MODAL CLOSE HANDLER (FIXES ‚ùì + üéÅ ISSUE)
   ========================================================= */

// Close button + backdrop (works even if modal HTML is added later)
document.addEventListener("click", (e) => {

  // 1) Close buttons (‚úï / Close / any element with data-close)
  const closeBtn = e.target.closest("[data-close]");
  if (closeBtn) {
    const id = closeBtn.getAttribute("data-close");
    if (id) closeModal(id);
    return;
  }

  // 2) Click on dark overlay closes modal
  const overlay = e.target.classList.contains("modalOverlay") ? e.target : null;
  if (overlay?.id) closeModal(overlay.id);
});

// 3) ESC closes the top-most open modal
document.addEventListener("keydown", (e) => {
  if (e.key !== "Escape") return;
  const open = [...document.querySelectorAll(".modalOverlay.show")];
  const top = open[open.length - 1];
  if (top?.id) closeModal(top.id);
});

function clearErrors(){
  ["athleteErr","entryErr","resetErr","importMsg","editAthErr","donateErr","editEntryErr"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.classList.remove("show"); el.textContent=""; }
  });
}

    // -----------------------------
    // Storage
    // -----------------------------
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : structuredClone(defaultState);
      }catch(e){
        return structuredClone(defaultState);
      }
    }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function loadPrefs(){
      try{
        const raw = localStorage.getItem(LS_PREF);
        return raw ? JSON.parse(raw) : structuredClone(defaultPrefs);
      }catch(e){
        return structuredClone(defaultPrefs);
      }
    }
    function savePrefs(){ localStorage.setItem(LS_PREF, JSON.stringify(prefs)); }

    // -----------------------------
    // Helpers
    // -----------------------------
    function getActiveAthlete(){
      return state.athletes.find(a => a.id === state.activeAthleteId) || null;
    }
    function uid(){ return "a_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ‚úÖ distance normalization + dynamic options
    function normalizeDistance(d){
      let s = String(d || "").trim();
      if(!s) return "";
      s = s.replace(/\s+/g,"");
      if(/^\d+$/i.test(s)) return `${s}m`;
      const m = s.match(/^(\d+)([a-zA-Z]+)$/);
      if(m){
        const num = m[1];
        const unit = m[2].toLowerCase();
        if(unit === "m") return `${num}m`;
        return `${num}${unit}`;
      }
      return s;
    }

    function getDistanceOptionsForActive(){
      const ath = getActiveAthlete();
      const set = new Set(DEFAULT_DISTANCES);

      if(ath && Array.isArray(ath.entries)){
        for(const e of ath.entries){
          const nd = normalizeDistance(e.distance);
          if(nd) set.add(nd);
        }
      }

      const arr = [...set];
      arr.sort((a,b)=>{
        const na = a.match(/^(\d+)\s*m$/i);
        const nb = b.match(/^(\d+)\s*m$/i);
        if(na && nb) return Number(na[1]) - Number(nb[1]);
        if(na && !nb) return -1;
        if(!na && nb) return 1;
        return a.localeCompare(b, undefined, {numeric:true});
      });
      return arr;
    }

    function refreshDistanceUI(){
      const list = getDistanceOptionsForActive();

      distanceList.innerHTML = list.map(d => `<option value="${escapeHtml(d)}"></option>`).join("");

      const currentHome = distanceFilter.value || prefs.defaultDistance || "ALL";
      const currentAn   = analyticsDistance.value || prefs.defaultDistance || "ALL";

      const optHtml = `<option value="ALL">All distances</option>` +
        list.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d.replace(/m$/i,""))}</option>`).join("");

      distanceFilter.innerHTML = optHtml;
      analyticsDistance.innerHTML = optHtml;

      distanceFilter.value = (currentHome === "ALL" || list.includes(currentHome)) ? currentHome : "ALL";
      analyticsDistance.value = (currentAn === "ALL" || list.includes(currentAn)) ? currentAn : "ALL";

      prefs.defaultDistance = distanceFilter.value;
      savePrefs();
    }

    // ‚úÖ TIME PARSER FIXED (supports HH:MM:SS like 00:01:00)
    function parseTimeSmart(t){
      if(t == null) return { ms:null, normalized:null, note:null };

      // Excel numeric time (fraction of day)
      if(typeof t === "number" && isFinite(t)){
        const totalMs = Math.round(t * 24 * 60 * 60 * 1000);
        if(totalMs >= 0 && totalMs < 24*60*60*1000){
          return { ms: totalMs, normalized: msToTime(totalMs), note: null };
        }
      }

      let raw = String(t).trim();
      if(!raw) return { ms:null, normalized:null, note:null };
      raw = raw.replace(/\s+/g,"");

      // HH:MM:SS
      let m = raw.match(/^(\d{1,2}):([0-5]\d):([0-5]\d)$/);
      if(m){
        const hh = Number(m[1]);
        const mm = Number(m[2]);
        const ss = Number(m[3]);
        const total = ((hh*3600) + (mm*60) + ss) * 1000;
        return { ms: total, normalized: msToTime(total), note: null };
      }

      // MM:SS(.ms)
      m = raw.match(/^(\d{1,2}):([0-5]\d)(?:\.(\d+))?$/);
      if(m){
        const mm = Number(m[1]);
        const ss = Number(m[2]);
        const ms = Number((m[3]||"0").slice(0,3).padEnd(3,"0"));
        const total = (mm*60 + ss)*1000 + ms;
        return { ms: total, normalized: msToTime(total), note: null };
      }

      // m.ss (minutes.seconds)
      m = raw.match(/^(\d{1,2})\.(\d{1,2})$/);
      if(m){
        const mm = Number(m[1]);
        const ss = Number(m[2]);
        if(ss < 60){
          const total = (mm*60 + ss)*1000;
          return { ms: total, normalized: msToTime(total), note: `Interpreted ${raw} as ${msToTime(total)}` };
        }
      }

      // seconds(.ms)
      m = raw.match(/^(\d{1,4})(?:\.(\d+))?$/);
      if(m){
        const sec = Number(m[1]);
        const ms = Number((m[2]||"0").slice(0,3).padEnd(3,"0"));
        if(isFinite(sec) && sec >= 0){
          const total = sec*1000 + ms;
          return { ms: total, normalized: msToTime(total), note: `Interpreted ${raw}s as ${msToTime(total)}` };
        }
      }

      return { ms:null, normalized:null, note:null };
    }

    function msToTime(ms){
      if(ms == null || isNaN(ms)) return "‚Äî";
      ms = Math.max(0, Math.round(ms)); // ‚úÖ prevents long decimal milliseconds
      const totalSec = Math.floor(ms/1000);
      const mm = Math.floor(totalSec/60);
      const ss = totalSec % 60;
      const msec = ms % 1000;
      return String(mm).padStart(2,"0")+":"+String(ss).padStart(2,"0")+"."+String(msec).padStart(3,"0")
    }


    function fmtDate(iso){
      if(!iso) return "‚Äî";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      }catch(e){ return iso; }
    }
    function fmtDateAxis(iso){
      const d=new Date(iso);
      return d.toLocaleDateString(undefined,{
        day:"2-digit",
        month:"short",
        year:"2-digit"
      });
    }



    // ‚úÖ DD-MON-YY (for X-axis)
    function fmtDateAxis(iso){
      if(!iso) return "‚Äî";
      const d = new Date(iso);
      if(isNaN(d)) return "‚Äî";
      const dd = String(d.getDate()).padStart(2,"0");
      const mons = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const mon = mons[d.getMonth()] || "‚Äî";
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}-${mon}-${yy}`;
    }

    function sortByDateDesc(entries){
      return [...entries].sort((a,b)=> new Date(b.date) - new Date(a.date));
    }

    function computePBMap(entries){
      const pb = {};
      for(const e of entries){
        const parsed = parseTimeSmart(e.time);
        if(parsed.ms == null) continue;
        const dist = normalizeDistance(e.distance);
        if(!dist) continue;
        if(!pb[dist] || parsed.ms < pb[dist].ms){
          pb[dist] = { ...e, distance: dist, ms: parsed.ms };
        }
      }
      return pb;
    }

    function showError(id, msg){
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add("show");
    }

    function flashBanner(msg, isPB){
      pbBannerText.textContent = msg;
      pbBanner.style.borderColor = isPB ? "rgba(200,139,0,.22)" : "rgba(47,107,255,.18)";
      pbBanner.style.background = "rgba(255,255,255,.72)";
      pbBanner.classList.add("show");
      clearTimeout(flashBanner._t);
      flashBanner._t = setTimeout(()=> pbBanner.classList.remove("show"), 4200);
    }

    // -----------------------------
    // Avatar (simple emoji only for now)
    // -----------------------------
    function renderAvatar(){
      const ath = getActiveAthlete();
      avatarBtn.innerHTML = "";
      const emoji = ath?.avatarEmoji || "‚ùÑÔ∏è";
      avatarBtn.innerHTML = `<div class="emoji">${escapeHtml(emoji)}</div>`;
    }

    function openAvatarQuick(){
      const ath = getActiveAthlete();
      const emoji = prompt("Set avatar emoji (example: ‚õ∏Ô∏è üèÅ ‚≠ê)", ath?.avatarEmoji || "‚ùÑÔ∏è");
      if(emoji == null) return;
      ath.avatarEmoji = emoji.trim() || "‚ùÑÔ∏è";
      saveState();
      renderAll(false);
    }

    // -----------------------------
    // Athlete CRUD
    // -----------------------------
    function saveAthlete(){
      clearErrors();
      const name = document.getElementById("athName").value.trim();
      const year = document.getElementById("athYear").value.trim();
      const emoji = document.getElementById("athEmoji").value.trim();

      if(!name){ showError("athleteErr","Please enter a name."); return; }
      if(year && !/^\d{4}$/.test(year)){ showError("athleteErr","Birth year should be 4 digits (e.g., 2014)."); return; }

      const newAth = {
        id: uid(),
        name,
        birthYear: year || "",
        createdAt: new Date().toISOString(),
        entries: [],
        avatarEmoji: emoji || "‚ùÑÔ∏è"
      };

      state.athletes.push(newAth);
      state.activeAthleteId = newAth.id;
      saveState();

      document.getElementById("athName").value = "";
      document.getElementById("athYear").value = "";
      document.getElementById("athEmoji").value = "";
      closeModal("modalAthlete");

      flashBanner(`Athlete added: ${name}`, false);
      renderAll(true);
    }

    function openEditAthlete(){
      const ath = getActiveAthlete();
      if(!ath){ flashBanner("No athlete selected.", false); return; }
      document.getElementById("editAthName").value = ath.name || "";
      document.getElementById("editAthYear").value = ath.birthYear || "";
      openModal("modalEditAthlete");
    }

    function saveAthleteEdits(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){ showError("editAthErr","No athlete selected."); return; }

      const name = document.getElementById("editAthName").value.trim();
      const year = document.getElementById("editAthYear").value.trim();

      if(!name){ showError("editAthErr","Please enter a name."); return; }
      if(year && !/^\d{4}$/.test(year)){ showError("editAthErr","Birth year should be 4 digits (e.g., 2014)."); return; }

      ath.name = name;
      ath.birthYear = year || "";
      saveState();
      closeModal("modalEditAthlete");
      flashBanner("Athlete updated.", false);
      renderAll(true);
    }

    // -----------------------------
    // Entry modal
    // -----------------------------
    function openEntryModal(){
      clearErrors();
      document.getElementById("enDate").valueAsDate = new Date();
      document.getElementById("enLocation").value = "";
      document.getElementById("enNotes").value = "";

      entryRowsEl.innerHTML = "";
      addEntryRow("400m", "", true);
      openModal("modalEntry");
    }

    function addEntryRow(distance="500m", time="", isFirst=false){
      const row = document.createElement("div");
      row.className = "entryRow";

      row.innerHTML = `
        <div class="field">
          <label>Distance</label>
          <input class="input jsDist" list="distanceList" placeholder="e.g., 500m" value="${escapeHtml(distance || "")}" />
        </div>

        <div class="field">
          <label>Time</label>
          <input class="input jsTime" placeholder="${escapeHtml(prefs.timeHint || "00:52.300")}" value="${escapeHtml(time || "")}" />
        </div>

        <div style="display:flex; justify-content:flex-end;">
          <button class="miniBtn miniBtnDanger jsRemove" ${isFirst ? "disabled style='opacity:.45; cursor:not-allowed;'" : ""}>Remove</button>
        </div>
      `;

      entryRowsEl.appendChild(row);

      const removeBtn = row.querySelector(".jsRemove");
      removeBtn.addEventListener("click", () => {
        if(removeBtn.disabled) return;
        row.remove();
      });
    }

    function saveEntryMulti(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){ showError("entryErr","No athlete selected. Add/select an athlete first."); return; }

      const date = document.getElementById("enDate").value;
      const location = document.getElementById("enLocation").value.trim();
      const notes = document.getElementById("enNotes").value.trim();

      if(!date){ showError("entryErr","Please select a date."); return; }
      if(!location){ showError("entryErr","Please enter a location."); return; }

      const rows = [...entryRowsEl.querySelectorAll(".entryRow")];
      if(rows.length === 0){ showError("entryErr","Please add at least one distance/time."); return; }

      const beforePBMap = computePBMap(ath.entries || []);
      let savedCount = 0;
      let pbMessages = [];

      for(const r of rows){
        const dist = normalizeDistance(r.querySelector(".jsDist").value);
        const timeStr = r.querySelector(".jsTime").value.trim();

        if(!dist){ showError("entryErr","Please enter a distance (example: 500m)."); return; }

        const parsed = parseTimeSmart(timeStr);
        if(parsed.ms == null){
          showError("entryErr",`Time looks invalid. Try mm:ss.mmm or HH:MM:SS (example: ${prefs.timeHint} or 00:01:00).`);
          return;
        }

        if(parsed.note){
          const ok = confirm(`Just checking üôÇ\n\nWe interpreted "${timeStr}" as "${parsed.normalized}".\n\nSave it?`);
          if(!ok){
            showError("entryErr","Please correct the time and try again.");
            return;
          }
        }

        const beforePB = beforePBMap[dist]?.ms ?? null;

        ath.entries.push({
          id: "e_" + Math.random().toString(16).slice(2) + Date.now().toString(16),
          date, distance: dist, time: parsed.normalized, location, notes
        });
        savedCount++;

        if(beforePB == null || parsed.ms < beforePB){
          const diff = beforePB == null ? null : (beforePB - parsed.ms);
          pbMessages.push(
            diff == null
              ? `First PB for ${dist}: ${parsed.normalized}`
              : `${dist} improved by ${(diff/1000).toFixed(3)}s ‚Üí ${parsed.normalized}`
          );
        }
      }

      saveState();
      closeModal("modalEntry");

      refreshDistanceUI();

      if(pbMessages.length){
        flashBanner(`üéâ ${ath.name}: ${pbMessages[0]}${pbMessages.length>1 ? ` (+${pbMessages.length-1} more)` : ""}`, true);
      }else{
        flashBanner(`${savedCount} race entr${savedCount===1?"y":"ies"} saved for ${ath.name}.`, false);
      }

      renderAll(true);
    }

    function openEditEntryModal(entryId){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath) return;

      const e = (ath.entries || []).find(x=>x.id===entryId);
      if(!e) return;

      document.getElementById("editEntryId").value = e.id;
      document.getElementById("editEnDate").value = e.date || "";
      document.getElementById("editEnLocation").value = e.location || "";
      document.getElementById("editEnNotes").value = e.notes || "";
      document.getElementById("editEnDistance").value = normalizeDistance(e.distance) || "";
      document.getElementById("editEnTime").value = e.time || "";

      refreshDistanceUI();
      openModal("modalEditEntry");
    }

    function saveEntryEdits(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){ showError("editEntryErr","No athlete selected."); return; }

      const id = document.getElementById("editEntryId").value;
      const e = (ath.entries || []).find(x=>x.id===id);
      if(!e){ showError("editEntryErr","Entry not found."); return; }

      const date = document.getElementById("editEnDate").value;
      const location = document.getElementById("editEnLocation").value.trim();
      const notes = document.getElementById("editEnNotes").value.trim();
      const distance = normalizeDistance(document.getElementById("editEnDistance").value);
      const timeStr = document.getElementById("editEnTime").value.trim();

      if(!date){ showError("editEntryErr","Please select a date."); return; }
      if(!location){ showError("editEntryErr","Please enter a location."); return; }
      if(!distance){ showError("editEntryErr","Please enter a distance (example: 500m)."); return; }

      const parsed = parseTimeSmart(timeStr);
      if(parsed.ms == null){
        showError("editEntryErr",`Time looks invalid. Try mm:ss.mmm or HH:MM:SS.`);
        return;
      }

      e.date = date;
      e.location = location;
      e.notes = notes;
      e.distance = distance;
      e.time = parsed.normalized;

      saveState();
      refreshDistanceUI();

      closeModal("modalEditEntry");
      flashBanner("Entry updated.", false);
      renderAll(true);
    }

    function deleteEntryFromEditModal(){
      const id = document.getElementById("editEntryId").value;
      if(!id) return;
      if(!confirm("Delete this entry?")) return;
      deleteEntry(id, true);
    }

    function deleteEntry(entryId, fromEditModal=false){
      const ath = getActiveAthlete();
      if(!ath) return;

      const entry = (ath.entries || []).find(e => e.id === entryId);
      if(!entry) return;

      if(!fromEditModal){
        const msg = `Delete this entry?\n\n${fmtDate(entry.date)} ‚Ä¢ ${entry.location || "‚Äî"} ‚Ä¢ ${entry.distance} ‚Ä¢ ${entry.time}`;
        if(!confirm(msg)) return;
      }

      ath.entries = (ath.entries || []).filter(e => e.id !== entryId);
      saveState();

      refreshDistanceUI();

      if(fromEditModal) closeModal("modalEditEntry");
      flashBanner("Entry deleted.", false);
      renderAll(true);
    }

    // -----------------------------
    // Reset
    // -----------------------------
    function doResetAll(){
      clearErrors();
      const txt = document.getElementById("resetConfirm").value.trim();
      if(txt !== "RESET"){ showError("resetErr","Please type RESET exactly to confirm."); return; }
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_PREF);
      state = structuredClone(defaultState);
      prefs = structuredClone(defaultPrefs);
      closeModal("modalReset");
      flashBanner("All data cleared on this device.", false);
      applyTheme();
      renderAll(true);
    }

    // -----------------------------
    // Render
    // -----------------------------
    function renderAll(allowChartRedraw){
      renderAthleteSelect();
      refreshDistanceUI();
      renderAvatar();
      renderHome();
      renderAnalytics(allowChartRedraw);
      renderSettingsExcelPill();
      syncAppbarHeight();
    }

    function renderAthleteSelect(){
      athleteSelect.innerHTML = "";

      if(state.athletes.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No athletes yet";
        athleteSelect.appendChild(opt);
        state.activeAthleteId = null;
        saveState();
        pillAthlete.textContent = "No athlete selected";
        pillAnalytics.textContent = "No athlete";
        if(pillExport) pillExport.textContent = "No athlete";
        return;
      }

      if(!state.activeAthleteId || !state.athletes.some(a => a.id === state.activeAthleteId)){
        state.activeAthleteId = state.athletes[0].id;
        saveState();
      }

      for(const a of state.athletes){
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = a.name + (a.birthYear ? ` (${a.birthYear})` : "");
        athleteSelect.appendChild(opt);
      }
      athleteSelect.value = state.activeAthleteId;
    }

    function renderSettingsExcelPill(){
      const ath = getActiveAthlete();
      if(!pillExport) return;
      pillExport.textContent = ath ? `Selected: ${ath.name}` : "No athlete";
    }

    function renderHome(){
      const ath = getActiveAthlete();

      if(!ath){
        pillAthlete.textContent = "No athlete selected";
        pillCount.textContent = "0 races";
        pillPBCount.textContent = "0 PBs";
        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No athlete selected</strong>
            <p>Add an athlete and start entering races.</p>
          </div>
        `;
        cardsWrap.innerHTML = `
          <div class="empty" style="min-width: min(520px, 86vw);">
            <strong>No cards yet</strong>
            <p>Add races to see distance cards here.</p>
          </div>
        `;
        return;
      }

      pillAthlete.textContent = ath.name + (ath.birthYear ? ` ‚Ä¢ ${ath.birthYear}` : "");
      const entriesAll = sortByDateDesc(ath.entries || []);
      pillCount.textContent = `${entriesAll.length} races`;

      const pbMap = computePBMap(entriesAll);
      const pbCount = Object.keys(pbMap).length;
      pillPBCount.textContent = `${pbCount} PBs`;

      if(pbCount === 0){
        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No PBs yet</strong>
            <p>Add race entries and PBs will appear automatically for each distance.</p>
          </div>
        `;
      }else{
        const distances = Object.keys(pbMap).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
        pbSummaryWrap.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Distance</th>
                <th>PB</th>
                <th>Date</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody>
              ${distances.map(d=>{
                const pb = pbMap[d];
                return `
                  <tr data-entry-id="${pb.id}" title="Click to edit this entry">
                    <td><span class="badge">${escapeHtml(d)}</span></td>
                    <td><b>${msToTime(pb.ms)}</b></td>
                    <td>${fmtDate(pb.date)}</td>
                    <td>${escapeHtml((pb.location || "").trim() || "‚Äî")}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;
      }

      const scopedEntries = (distanceFilter.value === "ALL")
        ? entriesAll
        : entriesAll.filter(e => normalizeDistance(e.distance) === distanceFilter.value);

      if(scopedEntries.length === 0){
        cardsWrap.innerHTML = `
          <div class="empty" style="min-width: min(520px, 86vw);">
            <strong>No entries</strong>
            <p>${distanceFilter.value === "ALL" ? "Add races to see cards by distance." : `No entries for ${distanceFilter.value}.`}</p>
          </div>
        `;
        return;
      }

      const groups = {};
      for(const e of scopedEntries){
        const key = normalizeDistance(e.distance) || "‚Äî";
        (groups[key] ||= []).push({ ...e, distance: key });
      }
      const groupKeys = Object.keys(groups).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));

      cardsWrap.innerHTML = groupKeys.map(dKey => {
        const list = sortByDateDesc(groups[dKey]);
        const pbForDist = pbMap[dKey]?.ms ?? null;
        const pbLabel = pbForDist != null ? `PB ${msToTime(pbForDist)}` : "No PB";
        const countLabel = `${list.length} entr${list.length===1?"y":"ies"}`;

        const itemsHtml = list.map(e=>{
          const parsed = parseTimeSmart(e.time);
          const ms = parsed.ms;
          const isPB = pbMap[e.distance] && ms != null && ms === pbMap[e.distance].ms;
          const badge = isPB ? `<span class="badge badgePB">üèÖ PB</span>` : `<span class="badge badgeOK">Saved</span>`;

          return `
            <div class="entryItem">
              <div class="entryMain">
                <div class="line1">
                  <span class="time">${escapeHtml(e.time)}</span>
                  ${badge}
                </div>
                <div class="meta">${fmtDate(e.date)} ‚Ä¢ ${escapeHtml((e.location||"").trim() || "‚Äî")}</div>
                <div class="notes">${e.notes ? escapeHtml(e.notes) : "‚Äî"}</div>
              </div>
              <div class="entryActions">
                <button class="iconBtn" title="Edit entry" data-edit-entry-id="${e.id}">‚úèÔ∏è</button>
                <button class="iconBtn iconBtnDanger" title="Delete entry" data-del-entry-id="${e.id}">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join("");

        return `
          <div class="distCard">
            <div class="distTop">
              <div class="distTitle">
                <div class="big"><span class="badge">${escapeHtml(dKey)}</span> Entries</div>
                <div class="small">Latest first (by date)</div>
              </div>
              <div class="distStats">
                <div class="pb">${pbLabel}</div>
                <div class="count">${countLabel}</div>
              </div>
            </div>
            <div class="distList">${itemsHtml}</div>
          </div>
        `;
      }).join("");
    }

    function renderAnalytics(allowChartRedraw){
      const ath = getActiveAthlete();

      if(!ath){
        pillAnalytics.textContent = "No athlete";
        anPB.textContent = "‚Äî";
        anPBMeta.textContent = "Pick a distance for PB + chart";
        anCount.textContent = "‚Äî";
        if(allowChartRedraw) drawChart([], analyticsDistance.value);
        return;
      }

      pillAnalytics.textContent = ath.name + (ath.birthYear ? ` ‚Ä¢ ${ath.birthYear}` : "");

      const entriesAll = ath.entries || [];
      const pbMap = computePBMap(entriesAll);

      const dist = analyticsDistance.value;
      const scoped = (dist === "ALL") ? [] : entriesAll.filter(e => normalizeDistance(e.distance) === dist);

      anCount.textContent = dist === "ALL" ? `${entriesAll.length} total races` : `${scoped.length} races for ${dist}`;

      const pb = dist !== "ALL" ? (pbMap[dist]?.ms ?? null) : null;
      anPB.textContent = pb != null ? msToTime(pb) : "‚Äî";
      anPBMeta.textContent = pb != null ? `${dist} best` : (dist === "ALL" ? "Pick a distance for PB + chart" : `No PB for ${dist}`);

      if(allowChartRedraw){
        drawChart(sortByDateDesc(scoped).map(e=>({...e, distance: normalizeDistance(e.distance)})), dist);
      }
    }

    // -----------------------------
    // Chart (with X-axis date labels DD-MON-YY)
    // -----------------------------
function drawChart(entries){
  const data = [...entries]
    .filter(e => parseTimeSmart(e.time).ms != null && e.date)
    .sort((a,b)=> new Date(a.date) - new Date(b.date));

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // reset saved points
  chartLast = null;

  if(data.length < 2){
    ctx.fillStyle = "rgba(15,21,38,.75)";
    ctx.font = "900 18px system-ui";
    ctx.fillText("Add at least 2 races to see a trend", 50, 200);
    return;
  }

  const pts = data.map((e,i)=>{
    const parsed = parseTimeSmart(e.time);
    return {
      idx: i,
      date: e.date,
      label: fmtDateAxis(e.date),
      ms: parsed.ms,
      time: parsed.normalized
    };
  });

  const pb = pts.reduce((b,p)=> (p.ms < b.ms ? p : b), pts[0]);

  const padL=80, padR=30, padT=30, padB=70;
  const W = canvas.width - padL - padR;
  const H = canvas.height - padT - padB;

  let minY = Math.min(...pts.map(p=>p.ms));
  let maxY = Math.max(...pts.map(p=>p.ms));
  const pad = (maxY - minY) * 0.2 || 200;

  // ‚úÖ keep axis values clean (integers) to avoid long decimals
  minY = Math.round(minY - pad);
  maxY = Math.round(maxY + pad);

  const toX = i => padL + (i/(pts.length-1)) * W;
  const toY = y => padT + ((maxY - y)/(maxY - minY)) * H;

  // ‚úÖ SAVE pixel positions for clicking points later
  chartLast = {
    pts: pts.map(p => ({
      ...p,
      px: toX(p.idx),
      py: toY(p.ms),
      fullDate: fmtDate(p.date)
    }))
  };

  // Grid + Y labels
  ctx.strokeStyle = "rgba(15,21,38,.10)";
  ctx.fillStyle = "rgba(15,21,38,.65)";
  ctx.font = "900 12px system-ui";
  ctx.textAlign = "right";

  for(let i=0;i<=5;i++){
    const y = padT + (H/5)*i;
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(padL+W, y);
    ctx.stroke();

    const val = Math.round(maxY - ((maxY-minY)/5)*i);
    ctx.fillText(msToTime(val), padL-10, y+4);
  }

  // PB reference line
  ctx.setLineDash([6,6]);
  ctx.strokeStyle = "rgba(200,139,0,.6)";
  ctx.beginPath();
  ctx.moveTo(padL, toY(pb.ms));
  ctx.lineTo(padL+W, toY(pb.ms));
  ctx.stroke();
  ctx.setLineDash([]);

  // Line
  const grad = ctx.createLinearGradient(padL, 0, padL+W, 0);
  grad.addColorStop(0, "#2f6bff");
  grad.addColorStop(1, "#2bb7ff");

  ctx.strokeStyle = grad;
  ctx.lineWidth = 4;
  ctx.beginPath();
  pts.forEach((p,i)=>{
    const x = toX(p.idx), y = toY(p.ms);
    i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
  });
  ctx.stroke();

  // Points
  pts.forEach(p=>{
    const x = toX(p.idx), y = toY(p.ms);
    ctx.fillStyle = (p === pb) ? "#c88b00" : "#fff";
    ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = "#0f1526";
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });

  // X axis labels
  ctx.fillStyle = "rgba(15,21,38,.65)";
  ctx.font = "900 12px system-ui";
  ctx.textAlign = "center";

  for(let i=0;i<Math.min(6,pts.length);i++){
    const idx = Math.round((pts.length-1)*(i/5));
    const p = pts[idx];
    ctx.fillText(p.label, toX(p.idx), padT+H+26);
  }
}


    // -----------------------------
    // Excel export/template
    // -----------------------------
    function exportXLSX(){
      const ath = getActiveAthlete();
      if(!ath){ flashBanner("No athlete selected.", false); return; }

      const rows = [["Athlete","BirthYear","Date","Location","Distance","Time","Notes"]];
      for(const e of sortByDateDesc(ath.entries || [])){
        rows.push([ath.name, ath.birthYear || "", e.date, e.location || "", normalizeDistance(e.distance), e.time, (e.notes||"")]);
      }

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "PB Data");

      const safeName = (ath.name || "Athlete").replaceAll(/[^\w\- ]/g,"").replaceAll(" ","_");
      XLSX.writeFile(wb, `PB-${safeName}.xlsx`);
      flashBanner("Excel downloaded.", false);
    }

    function downloadTemplateXLSX(){
      const sample = [
        ["Athlete","BirthYear","Date","Location","Distance","Time","Notes"],
        ["Samarveer","2014","2025-11-29","Ontario Provincial Circuit - Brampton","400m","00:48.700","Sample row"],
        ["Samarveer","2014","","","500m","00:59.300","(optional) leave date/location blank to fill-down like Excel"],
        ["Samarveer","2014","","","400m","00:01:00","HH:MM:SS is allowed (Excel style)"]
      ];
      const ws = XLSX.utils.aoa_to_sheet(sample);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Template");
      XLSX.writeFile(wb, "PB-VelocityBoard-Template.xlsx");
      flashBanner("Template downloaded.", false);
    }

    // ‚úÖ CLEAN IMPORT (supports fill-down, supports 28-Jan-24, supports 00:01:00)
    function importXLSXIntoSelectedAthlete(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){ showError("importMsg","Please select an athlete first."); return; }

      const file = excelFile.files && excelFile.files[0];
      if(!file){ showError("importMsg","Please choose an Excel file first."); return; }

      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = new Uint8Array(reader.result);
          const wb = XLSX.read(data, { type: "array" });
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];

          const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
          if(!json.length){
            showError("importMsg","Excel looks empty. Please use the template.");
            return;
          }

          const norm = (s)=> String(s||"").trim().toLowerCase();
          const get = (row, key)=>{
            const k = Object.keys(row).find(h => norm(h) === norm(key));
            return k ? row[k] : "";
          };

          let added = 0;
          let skipped = 0;
          let firstBad = "";

          let lastDate = "";
          let lastLocation = "";

          for(let i=0;i<json.length;i++){
            const row = json[i];

            let rawDate = get(row,"Date");
            let rawLocation = get(row,"Location");
            let rawDistance = get(row,"Distance");
            let rawTime = get(row,"Time");
            let notes = String(get(row,"Notes") || "").trim();

            if(String(rawDate).trim()) lastDate = rawDate;
            else rawDate = lastDate;

            if(String(rawLocation).trim()) lastLocation = rawLocation;
            else rawLocation = lastLocation;

            let date = excelDateToISO(rawDate);
            let location = String(rawLocation || "").trim();
            let distance = normalizeDistance(rawDistance);
            let timeRaw = (rawTime == null) ? "" : rawTime;

            if(typeof timeRaw === "string") timeRaw = timeRaw.replace(/\s+/g,"");

            if(!date || !location || !distance || (timeRaw === "" || timeRaw == null)){
              skipped++;
              continue;
            }

            const parsed = parseTimeSmart(timeRaw);
            if(parsed.ms == null){
              skipped++;
              if(!firstBad) firstBad = `Row ${i+2}: invalid time "${timeRaw}"`;
              continue;
            }

            ath.entries.push({
              id: "e_" + Math.random().toString(16).slice(2) + Date.now().toString(16),
              date,
              location,
              distance,
              time: parsed.normalized,
              notes: notes || ""
            });
            added++;
          }

          saveState();
          refreshDistanceUI();

          if(added === 0){
            showError("importMsg", `No rows imported. ${firstBad || "Please use columns: Date, Location, Distance, Time."}`);
            return;
          }

          flashBanner(`Excel import complete: ${added} row(s) added to ${ath.name}${skipped ? ` ‚Ä¢ ${skipped} skipped` : ""}.`, false);
          renderAll(true);

        }catch(e){
          showError("importMsg","Could not import Excel. Please use the template format.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function excelDateToISO(v){
      if(v == null) return "";
      const s = String(v).trim();
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      if(Object.prototype.toString.call(v) === "[object Date]" && !isNaN(v)){
        const yyyy = v.getFullYear();
        const mm = String(v.getMonth()+1).padStart(2,"0");
        const dd = String(v.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }

      if(typeof v === "number" && isFinite(v)){
        const d = XLSX.SSF.parse_date_code(v);
        if(d){
          return `${d.y}-${String(d.m).padStart(2,"0")}-${String(d.d).padStart(2,"0")}`;
        }
      }

      const m = s.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{2,4})$/);
      if(m){
        const months = {jan:"01",feb:"02",mar:"03",apr:"04",may:"05",jun:"06",jul:"07",aug:"08",sep:"09",oct:"10",nov:"11",dec:"12"};
        const yyyy = m[3].length === 2 ? `20${m[3]}` : m[3];
        const mon = months[m[2].toLowerCase()];
        if(mon) return `${yyyy}-${mon}-${String(m[1]).padStart(2,"0")}`;
      }

      return "";
    }

    // -----------------------------
    // Donate
    // -----------------------------
    function donateAmount(amountStr){
      clearErrors();
      const amt = String(amountStr || "").trim();
      const n = Number(amt);
      if(!amt || !isFinite(n) || n <= 0){
        showError("donateErr","Please enter a valid amount (example: 2, 5, 10, 3.50).");
        return;
      }
      const base = PAYPAL_ME.replace(/\/+$/,"");
      const url = `${base}/${n}`;
      window.open(url, "_blank", "noopener,noreferrer");
      closeModal("modalDonate");
      flashBanner("Opening PayPal donation page‚Ä¶ üíô", false);
    }


    
  </script>

<div class="modalOverlay" id="modalHelp">
  <div class="modal">
    <div class="modalTop">
      <div>
        <h3>‚ùì Help & Instructions</h3>
        <p>A gentle guide to use this tracker smoothly.</p>
      </div>
      <button class="xbtn" data-close="modalHelp">‚úï</button>
    </div>

    <div class="empty" style="margin-top:0;">
      <strong>Getting Started</strong>
      <p>
        ‚Ä¢ Start by clicking <b>+ Add Athlete</b><br>
        ‚Ä¢ Enter name (and optional birth year + avatar emoji)<br>
        ‚Ä¢ Select the athlete from the dropdown at the top
      </p>
    </div>

    <div class="empty">
      <strong>Add Race Entries</strong>
      <p>
        ‚Ä¢ Click <b>+ Add Race</b><br>
        ‚Ä¢ Choose the race <b>date</b> and enter <b>location</b><br>
        ‚Ä¢ Add one or more distances in the same race (example: 400m + 500m)<br>
        ‚Ä¢ Time formats allowed: <b>mm:ss.mmm</b> (00:52.300) or <b>HH:MM:SS</b> (00:01:00)
      </p>
    </div>

    <div class="empty">
      <strong>PB Summary (Home)</strong>
      <p>
        ‚Ä¢ The PB table shows the best time automatically for each distance<br>
        ‚Ä¢ You can click any PB row to edit that entry
      </p>
    </div>

    <div class="empty">
      <strong>Race Cards (Home)</strong>
      <p>
        ‚Ä¢ Cards are grouped by distance and sorted by latest date<br>
        ‚Ä¢ Use <b>Distance Focus</b> to filter cards (or choose ‚ÄúAll distances‚Äù)<br>
        ‚Ä¢ Tap ‚úèÔ∏è to edit, üóëÔ∏è to delete
      </p>
    </div>

    <div class="empty">
      <strong>Analytics (Chart)</strong>
      <p>
        ‚Ä¢ Select a distance to see the trend line for that distance<br>
        ‚Ä¢ PB for the selected distance is shown above the chart<br>
        ‚Ä¢ Tip: Add at least 2 races to see a proper trend
      </p>
    </div>

    <div class="empty">
      <strong>Excel Import / Export</strong>
      <p>
        ‚Ä¢ Go to <b>Settings ‚Üí Excel Import / Template</b><br>
        ‚Ä¢ Download template, fill it, and upload it to import<br>
        ‚Ä¢ You can download Excel for the selected athlete and upload it on another device
      </p>
    </div>

    <div class="empty">
      <strong>Storage & Reset</strong>
      <p>
        ‚Ä¢ Everything is saved safely on this device (local storage)<br>
        ‚Ä¢ If you want a fresh start, click <b>Reset</b><br>
        ‚Ä¢ Reset removes data from this device only
      </p>
    </div>

    <div class="foot">
      If something feels confusing, it‚Äôs completely okay ‚Äî just open this help anytime ‚ùÑÔ∏è
    </div>

    <div class="modalActions">
      <button class="btn btnPrimary" data-close="modalHelp">Close</button>
    </div>
  </div>
</div>


  
</body>
</html>
