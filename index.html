<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PB Tracker</title>

  <style>
    :root{
      /* Royal-dark-blue + glass */
      --bg1:#07122e;
      --bg2:#0a1b46;
      --glass: rgba(255,255,255,.78);
      --glass2: rgba(255,255,255,.62);
      --stroke: rgba(15,21,38,.12);
      --text: rgba(10,14,24,.92);
      --muted: rgba(10,14,24,.62);
      --muted2: rgba(10,14,24,.46);
      --primary: #1f56ff;
      --primary2:#2bb7ff;
      --danger:#e23b57;

      --radius: 18px;
      --shadow: 0 18px 60px rgba(5, 10, 24, .18);
      --shadow2: 0 10px 26px rgba(5, 10, 24, .14);

      --w: 1180px;
      --gap: 14px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(31,86,255,.25), transparent 60%),
        radial-gradient(900px 650px at 85% 20%, rgba(43,183,255,.18), transparent 55%),
        radial-gradient(900px 650px at 40% 90%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      overflow-x:hidden;
    }

    button, input, select { font-family:inherit; }

    .wrap{
      max-width: var(--w);
      margin: 0 auto;
      padding: 148px 16px 26px; /* header is fixed */
    }

    /* ---------- FIXED APP BAR ---------- */
    .appbar{
      position:fixed;
      top:0; left:0; right:0;
      z-index:50;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: rgba(255,255,255,.70);
      border-bottom:1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 40px rgba(0,0,0,.10);
    }
    .appbarInner{
      max-width: var(--w);
      margin:0 auto;
      padding: 10px 14px 12px;
    }

    /* Center brand */
    .brandCenter{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 4px;
    }
    .brandTitle{
      font-weight: 1000;
      letter-spacing: .35px;
      font-size: 20px;
      text-align:center;
    }

    /* Panels */
    .topPanels{
      width:100%;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .panel{
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(15,21,38,.10);
      border-radius: 18px;
      padding: 10px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .panelRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap: 8px;
      padding: 6px;
      border:1px solid rgba(15,21,38,.10);
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      justify-content:center;
      width:100%;
    }
    .tabBtn{
      border:0;
      padding: 9px 14px;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      font-weight: 900;
      cursor:pointer;
      transition: .18s ease;
      white-space:nowrap;
    }
    .tabBtn:hover{ color: var(--text); background: rgba(15,21,38,.04); }
    .tabBtn.active{
      background: rgba(31,86,255,.12);
      border: 1px solid rgba(31,86,255,.20);
      color: var(--text);
    }

    /* üéÅ button beside Settings */
    .giftBtn{
      border:0;
      background: transparent;
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      color: var(--muted);
      transition: .18s ease;
      white-space:nowrap;
    }
    .giftBtn:hover{ background: rgba(15,21,38,.04); color: var(--text); }

    /* Athlete panel */
    .athletePanel{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }
    .select{
      appearance:none;
      -webkit-appearance:none;
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      padding: 10px 34px 10px 12px;
      border-radius: 14px;
      font-weight:900;
      outline:none;
      cursor:pointer;
      min-width: 220px;
    }
    .selectWrap{ position:relative; }
    .selectWrap:after{
      content:"‚ñæ";
      position:absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-52%);
      color: var(--muted);
      pointer-events:none;
      font-size: 12px;
    }
    /* Ensure dropdown options readable (fix your #2 issue) */
    select, option{
      color: rgba(10,14,24,.92);
      background-color: #ffffff;
    }

    .athletePill{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(15,21,38,.04);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 1000;
      color: rgba(15,21,38,.75);
      white-space: nowrap;
    }

    /* Actions panel */
    .actionsPanel{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:center;
      width:100%;
    }

    .btn{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:1000;
      cursor:pointer;
      transition: .18s ease;
      box-shadow: var(--shadow2);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btnPrimary{
      border: none;
      color: white;
      background: linear-gradient(135deg, rgba(31,86,255,.98), rgba(43,183,255,.92));
      box-shadow: 0 14px 34px rgba(31,86,255,.18);
    }
    .btnDanger{
      border: 1px solid rgba(226,59,87,.22);
      background: rgba(226,59,87,.10);
    }

    /* Desktop: 3 panels side-by-side */
    @media (min-width: 940px){
      .topPanels{
        grid-template-columns: 1.05fr .95fr 1.25fr;
        align-items: start;
      }
      .tabs{ justify-content: center; }
      .actionsPanel{ justify-content:flex-end; }
      .panelRow{ justify-content:center; }
    }

    /* Cards */
    .card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.72);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    .title{
      font-size: 18px;
      font-weight: 1000;
      letter-spacing:.15px;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 3px;
      line-height:1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,21,38,.12);
      background: rgba(15,21,38,.04);
      color: var(--muted);
      font-size: 12px;
      font-weight:1000;
      white-space:nowrap;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.86);
    }
    .table th, .table td{
      padding: 10px 10px;
      font-size: 13px;
      border-bottom:1px solid rgba(15,21,38,.06);
      text-align:left;
      vertical-align:top;
      color: rgba(10,14,24,.90);
    }
    .table th{
      color: rgba(10,14,24,.65);
      font-weight: 1000;
      font-size: 12px;
      letter-spacing:.25px;
      background: rgba(15,21,38,.03);
    }
    .table tr:hover td{ background: rgba(31,86,255,.04); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 1000;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      white-space:nowrap;
    }
    .badgePB{ background: rgba(200,139,0,.10); border-color: rgba(200,139,0,.22); }
    .badgeOK{ background: rgba(24,169,101,.10); border-color: rgba(24,169,101,.22); }

    .iconBtn{
      border:1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.92);
      color: var(--text);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:.18s ease;
      box-shadow: var(--shadow2);
    }
    .iconBtnDanger{
      border-color: rgba(226,59,87,.22);
      background: rgba(226,59,87,.10);
    }

    .empty{
      border:1px dashed rgba(15,21,38,.20);
      border-radius: 18px;
      padding: 16px;
      color: var(--muted);
      background: rgba(255,255,255,.65);
      margin-top: 10px;
    }
    .empty strong{ color: var(--text); }
    .empty p{ margin: 8px 0 0; font-size: 13px; line-height:1.45; }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* ---------- RACE CARDS (UNO-hand style) ---------- */
    .raceStrip{
      display:flex;
      gap: 12px;
      overflow-x: auto;              /* IMPORTANT */
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory; /* feels nice on phone */
      padding-bottom: 8px;
    }
    .raceStrip::-webkit-scrollbar{ height: 10px; }
    .raceStrip::-webkit-scrollbar-thumb{
      background: rgba(15,21,38,.18);
      border-radius: 999px;
    }

    .raceCard{
      flex: 0 0 auto;
      width: 320px;                /* laptop */
      max-width: 82vw;             /* phone: allows multiple cards via swipe */
      scroll-snap-align: start;
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .raceCardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .raceCardTop .dist{
      font-weight: 1000;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .raceCardTop .count{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    .raceList{
      max-height: 240px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      border-top: 1px solid rgba(15,21,38,.08);
      padding-top: 8px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .raceItem{
      border: 1px solid rgba(15,21,38,.08);
      background: rgba(255,255,255,.86);
      border-radius: 14px;
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:start;
    }
    .raceItem .meta{
      color: rgba(10,14,24,.78);
      font-size: 12px;
      line-height: 1.35;
    }
    .raceItem .time{
      font-weight: 1000;
      font-size: 13px;
      text-align:right;
      white-space:nowrap;
    }
    .raceItem .actions{
      display:flex;
      gap: 6px;
      justify-content:flex-end;
      margin-top: 6px;
    }
    .miniIcon{
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.92);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow2);
    }
    .miniIconDanger{
      border-color: rgba(226,59,87,.22);
      background: rgba(226,59,87,.10);
    }

    /* Modals */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.38);
      display:none;
      z-index: 100;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modalOverlay.show{ display:flex; }

    .modal{
      width: min(760px, 100%);
      max-height: calc(100vh - 60px);
      overflow:auto;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      background: rgba(255,255,255,.92);
      padding-bottom: 10px;
      z-index: 2;
      border-bottom: 1px solid rgba(15,21,38,.06);
    }
    .modalTop h3{
      margin:0;
      font-size: 16px;
      font-weight: 1000;
    }
    .modalTop p{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }
    .xbtn{
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      color: var(--text);
      border-radius: 12px;
      width: 38px; height: 38px;
      cursor:pointer;
      font-weight: 1000;
      flex: 0 0 auto;
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      font-weight: 1000;
      color: var(--muted);
      letter-spacing:.2px;
    }
    .input, .select2{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight: 1000;
    }
    .input:focus, .select:focus, .select2:focus{
      outline: none;
      border-color: rgba(31,86,255,.35);
      box-shadow: 0 0 0 4px rgba(31,86,255,.10);
    }

    .error{
      display:none;
      color: rgba(120, 10, 30, .92);
      background: rgba(226,59,87,.10);
      border: 1px solid rgba(226,59,87,.22);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 1000;
      margin-top: 10px;
    }
    .error.show{ display:block; }

    .modalActions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 12px;
      flex-wrap:wrap;
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.92);
      padding-top: 10px;
      z-index: 2;
      border-top: 1px solid rgba(15,21,38,.06);
    }

    .entryRows{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 8px;
    }
    .entryRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items:end;
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding: 10px;
    }
    .miniBtn{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 1000;
      cursor:pointer;
      transition:.18s ease;
      white-space:nowrap;
    }
    .miniBtn:hover{ transform: translateY(-1px); }
    .miniBtnDanger{
      border:1px solid rgba(226,59,87,.22);
      background: rgba(226,59,87,.10);
    }

    /* Phone tweaks */
    @media (max-width: 560px){
      .wrap{ padding-top: 152px; }
      .form{ grid-template-columns: 1fr; }
      .entryRow{ grid-template-columns: 1fr; }
      .select{ min-width: 100%; }
      .athletePanel{ justify-content: stretch; }
      .athletePill{ width:100%; text-align:center; }
      .raceCard{ width: 88vw; } /* IMPORTANT: makes swipe show other cards */
    }
  </style>
</head>

<body>

  <div class="appbar">
    <div class="appbarInner">

      <!-- Center heading (fixed) -->
      <div class="brandCenter">
        <div class="brandTitle">PB Tracker</div>
      </div>

      <div class="topPanels">

        <!-- Panel 1: Tabs (fixed) -->
        <div class="panel">
          <div class="panelRow">
            <div class="tabs" role="tablist" aria-label="PB Tracker Tabs">
              <button class="tabBtn active" data-tab="home">Home</button>
              <button class="tabBtn" data-tab="analytics">Analytics</button>
              <button class="tabBtn" data-tab="export">Export</button>
              <button class="tabBtn" data-tab="settings">Settings</button>
              <button class="giftBtn" id="btnGift" title="Support this project">üéÅ</button>
            </div>
          </div>
        </div>

        <!-- Panel 2: Athlete dropdown + fixed selected pill (fixed) -->
        <div class="panel">
          <div class="athletePanel">
            <div class="selectWrap" style="flex:1 1 240px; min-width:240px;">
              <select id="athleteSelect" class="select" title="Select Athlete"></select>
            </div>
            <div id="activeAthletePill" class="athletePill">No athlete selected</div>
          </div>
        </div>

        <!-- Panel 3: Actions (fixed) -->
        <div class="panel">
          <div class="actionsPanel">
            <button class="btn" id="btnEditAthlete">Edit</button>
            <button class="btn btnPrimary" id="btnAddAthlete">+ Add Athlete</button>
            <button class="btn" id="btnAddEntry">+ Add Race</button>
            <button class="btn btnDanger" id="btnReset">Reset</button>
          </div>
        </div>

      </div>

    </div>
  </div>

  <div class="wrap">

    <!-- HOME: remove the "Quick View..." section (per your request) -->
    <section id="screenHome" class="screen active">

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">PB Summary</div>
            <div class="sub">Best time for each distance.</div>
          </div>
          <div class="pill" id="pillPBCount">0 PBs</div>
        </div>

        <div id="pbSummaryWrap"></div>
      </div>

      <div style="height:14px;"></div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Race Cards</div>
            <div class="sub">Cards are grouped by distance. Swipe horizontally to see more distances. Inside each card, scroll down for older races.</div>
          </div>
          <div class="pill" id="pillTotalRaces">0 races</div>
        </div>

        <div id="raceCardsWrap"></div>
      </div>

    </section>

    <!-- ANALYTICS: Performance Snapshot moved here (simplified) -->
    <section id="screenAnalytics" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Performance Snapshot</div>
            <div class="sub">Choose a distance to view PB and a simple trend.</div>
          </div>
          <div class="pill" id="pillAnalytics">‚Äî</div>
        </div>

        <div class="form">
          <div class="field">
            <label>Distance Focus</label>
            <select id="distanceFilter" class="select2">
              <option value="">Select a distance</option>
              <option value="111m">111m</option>
              <option value="222m">222m</option>
              <option value="333m">333m</option>
              <option value="400m">400m</option>
              <option value="500m">500m</option>
              <option value="800m">800m</option>
              <option value="1000m">1000m</option>
              <option value="1500m">1500m</option>
            </select>
          </div>

          <div class="field">
            <label>PB (Selected Distance)</label>
            <div class="input" id="pbDisplay" style="display:flex;align-items:center;min-height:44px;">
              Select a distance to display PB
            </div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <canvas id="trendCanvas" width="1200" height="420" style="width:100%;height:240px;border-radius:16px;border:1px solid rgba(15,21,38,.10);background:rgba(255,255,255,.86);"></canvas>
          <div style="text-align:center;margin-top:8px;color:rgba(10,14,24,.62);font-weight:900;">Trend (Time vs Race Date)</div>
        </div>

      </div>
    </section>

    <!-- EXPORT -->
    <section id="screenExport" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Export / Import</div>
            <div class="sub">Export CSV for the selected athlete, or import from CSV into the selected athlete.</div>
          </div>
          <div class="pill" id="pillExport">‚Äî</div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button class="btn btnPrimary" id="btnExportCSV">Download CSV (selected athlete)</button>
          <button class="btn" id="btnDownloadSample">Download Sample CSV</button>
        </div>

        <!-- Your remembered Upload CSV block (kept) -->
        <div class="empty" style="margin-top:12px;">
          <strong>Upload CSV</strong>
          <p>Data from this file will be added to the currently selected athlete.</p>
          <div class="field" style="margin-top:10px;">
            <label>Choose Excel file</label>
            <input class="input" id="csvFile" type="file" accept=".csv" />
          </div>
          <div style="margin-top:10px;">
            <button class="btn btnPrimary" id="btnImportCSV">Import the Data into selected athlete</button>
          </div>
          <div id="importMsg" class="error"></div>
        </div>

      </div>
    </section>

    <!-- SETTINGS -->
    <section id="screenSettings" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Settings</div>
            <div class="sub">Small preferences for a smooth experience.</div>
          </div>
          <button class="btn" id="btnHelp">Help</button>
        </div>

        <div class="form">
          <div class="field">
            <label>Time Placeholder</label>
            <input id="timeHint" class="input" value="00:52.300" />
          </div>
        </div>

        <div class="empty" style="margin-top:12px;">
          <strong>Storage note</strong>
          <p>Your data is saved on this device. If you switch devices, export CSV and import it on the new device.</p>
        </div>
      </div>
    </section>

  </div>

  <!-- MODAL: ADD ATHLETE -->
  <div class="modalOverlay" id="modalAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Athlete</h3>
          <p>Create an athlete profile. You can add races after that.</p>
        </div>
        <button class="xbtn" data-close="modalAthlete">‚úï</button>
      </div>

      <div class="form">
        <div class="field">
          <label>Name</label>
          <input id="athName" class="input" placeholder="e.g., Samarveer" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="athYear" class="input" inputmode="numeric" placeholder="e.g., 2014" />
        </div>
      </div>

      <div id="athleteErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthlete">Save Athlete</button>
      </div>
    </div>
  </div>

  <!-- MODAL: EDIT ATHLETE -->
  <div class="modalOverlay" id="modalEditAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Edit Athlete</h3>
          <p>Update the athlete name (and birth year). Entries remain unchanged.</p>
        </div>
        <button class="xbtn" data-close="modalEditAthlete">‚úï</button>
      </div>

      <div class="form">
        <div class="field">
          <label>Name</label>
          <input id="editAthName" class="input" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="editAthYear" class="input" inputmode="numeric" />
        </div>
      </div>

      <div id="editAthErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEditAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthleteEdits">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ADD ENTRY -->
  <div class="modalOverlay" id="modalEntry">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Race Entry</h3>
          <p>Same date + location can include multiple distances (400/500/800/1000 etc.).</p>
        </div>
        <button class="xbtn" data-close="modalEntry">‚úï</button>
      </div>

      <div class="form">
        <div class="field">
          <label>Date</label>
          <input id="enDate" class="input" type="date" />
        </div>

        <div class="field">
          <label>Location</label>
          <input id="enLocation" class="input" placeholder="e.g., Scarborough" />
        </div>

        <div class="field" style="grid-column:1 / -1;">
          <label>Notes (optional)</label>
          <input id="enNotes" class="input" placeholder="e.g., meet name, lane, fall, etc." />
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>Distances & Times</label>
        <div class="entryRows" id="entryRows"></div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="miniBtn" id="btnAddRow">+ Add another distance</button>
        </div>
      </div>

      <div id="entryErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEntry">Cancel</button>
        <button class="btn btnPrimary" id="saveEntry">Save Entry</button>
      </div>
    </div>
  </div>

  <!-- MODAL: RESET -->
  <div class="modalOverlay" id="modalReset">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Reset</h3>
          <p>This removes your stored data on this device. Type <strong>RESET</strong> to confirm.</p>
        </div>
        <button class="xbtn" data-close="modalReset">‚úï</button>
      </div>

      <div class="field">
        <label>Type RESET</label>
        <input id="resetConfirm" class="input" placeholder="RESET" />
      </div>

      <div id="resetErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalReset">Cancel</button>
        <button class="btn btnDanger" id="doReset">Reset Everything</button>
      </div>
    </div>
  </div>

  <!-- MODAL: HELP (Settings) -->
  <div class="modalOverlay" id="modalHelp">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>How to use PB Tracker</h3>
          <p>A simple, caring guide to help you get started.</p>
        </div>
        <button class="xbtn" data-close="modalHelp">‚úï</button>
      </div>

      <div class="empty" style="margin-top:0;">
        <strong>1) Start with an athlete</strong>
        <p>
          Tap <b>+ Add Athlete</b>, enter the name (and birth year if you want), and save.
          Then choose the athlete from the dropdown at the top.
        </p>
      </div>

      <div class="empty">
        <strong>2) Add races</strong>
        <p>
          Tap <b>+ Add Race</b>. Add the date and location, and then add one or more distances with times.
          You can add 400m, 500m, 800m, 1000m (all under the same date & location) and save together.
        </p>
      </div>

      <div class="empty">
        <strong>3) View PBs and race cards</strong>
        <p>
          The <b>Home</b> tab shows PBs for each distance and ‚Äúrace cards‚Äù grouped by distance.
          Swipe left/right to move between distances, and scroll inside a card to see older races.
        </p>
      </div>

      <div class="empty">
        <strong>4) Analytics (optional)</strong>
        <p>
          In <b>Analytics</b>, select a distance to view the PB for that distance and the trend chart.
          If you don‚Äôt select a distance, we‚Äôll simply wait and show a gentle message.
        </p>
      </div>

      <div class="empty">
        <strong>5) Export and Import</strong>
        <p>
          In <b>Export</b>, you can download a CSV for the selected athlete.
          You can also download a sample CSV, fill it in, and upload it back to quickly load many races.
        </p>
      </div>

      <div class="empty">
        <strong>6) Reset (only if needed)</strong>
        <p>
          Reset clears data from this device only. If you are unsure, export CSV first so you have a backup.
        </p>
      </div>

      <div class="modalActions">
        <button class="btn" data-close="modalHelp">Close</button>
      </div>
    </div>
  </div>

  <!-- MODAL: GIFT / PAYPAL -->
  <div class="modalOverlay" id="modalGift">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Support PB Tracker üéÅ</h3>
          <p>If this tool helped you, you can support it with a small tip. Thank you.</p>
        </div>
        <button class="xbtn" data-close="modalGift">‚úï</button>
      </div>

      <div class="empty" style="margin-top:0;">
        <strong>PayPal</strong>
        <p>Tap the button below to open PayPal.</p>
        <div style="margin-top:10px;">
          <button class="btn btnPrimary" id="btnPayPal">Open PayPal</button>
        </div>
        <p style="margin-top:10px;color:rgba(10,14,24,.55);font-size:12px;">
          Note: Replace the PayPal link in the code once, and it will work everywhere.
        </p>
      </div>

      <div class="modalActions">
        <button class="btn" data-close="modalGift">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* ================================
       PB TRACKER ‚Äî Single-file v1
       Fixes requested:
       - Keep header + athlete pill fixed while scrolling
       - Separate panels in header
       - Remove Quick View section
       - Race cards scroll on phone (horizontal) + inside card (vertical)
       - Settings Help button + sweet instructions
       - üéÅ button beside Settings + PayPal modal
       - Consistent text color (no white chart labels)
       - No JSON export (removed)
    ================================= */

    const LS_KEY  = "pb_tracker_singlefile_v1";
    const LS_PREF = "pb_tracker_prefs_v1";

    // ‚úÖ Replace this with your PayPal link (PayPal.me or hosted PayPal button URL)
    const PAYPAL_LINK = "https://www.paypal.com/";

    const defaultState = { athletes: [], activeAthleteId: null };
    const defaultPrefs = { timeHint: "00:52.300" };

    let state = loadState();
    let prefs = loadPrefs();

    // Tabs
    const tabBtns = [...document.querySelectorAll(".tabBtn")];
    const screens = {
      home: document.getElementById("screenHome"),
      analytics: document.getElementById("screenAnalytics"),
      export: document.getElementById("screenExport"),
      settings: document.getElementById("screenSettings")
    };

    // Header controls
    const athleteSelect = document.getElementById("athleteSelect");
    const activeAthletePill = document.getElementById("activeAthletePill");

    // Home
    const pillPBCount = document.getElementById("pillPBCount");
    const pillTotalRaces = document.getElementById("pillTotalRaces");
    const pbSummaryWrap = document.getElementById("pbSummaryWrap");
    const raceCardsWrap = document.getElementById("raceCardsWrap");

    // Analytics
    const pillAnalytics = document.getElementById("pillAnalytics");
    const distanceFilter = document.getElementById("distanceFilter");
    const pbDisplay = document.getElementById("pbDisplay");

    // Export
    const pillExport = document.getElementById("pillExport");
    const csvFile = document.getElementById("csvFile");
    const importMsg = document.getElementById("importMsg");

    // Settings
    const timeHint = document.getElementById("timeHint");

    // Chart
    const canvas = document.getElementById("trendCanvas");
    const ctx = canvas.getContext("2d");

    // Entry modal
    const entryRowsEl = document.getElementById("entryRows");

    // Events
    document.getElementById("btnAddAthlete").addEventListener("click", () => openModal("modalAthlete"));
    document.getElementById("btnEditAthlete").addEventListener("click", openEditAthlete);
    document.getElementById("btnAddEntry").addEventListener("click", () => {
      if(!getActiveAthlete()){
        openModal("modalAthlete");
        return;
      }
      openEntryModal();
    });
    document.getElementById("btnReset").addEventListener("click", () => openModal("modalReset"));

    document.getElementById("saveAthlete").addEventListener("click", saveAthlete);
    document.getElementById("saveAthleteEdits").addEventListener("click", saveAthleteEdits);
    document.getElementById("saveEntry").addEventListener("click", saveEntryMulti);
    document.getElementById("doReset").addEventListener("click", doResetAll);

    document.getElementById("btnExportCSV").addEventListener("click", exportCSV);
    document.getElementById("btnDownloadSample").addEventListener("click", downloadSampleCSV);
    document.getElementById("btnImportCSV").addEventListener("click", importCSVIntoSelected);

    // Help + Gift
    document.getElementById("btnHelp").addEventListener("click", () => openModal("modalHelp"));
    document.getElementById("btnGift").addEventListener("click", () => openModal("modalGift"));
    document.getElementById("btnPayPal").addEventListener("click", () => window.open(PAYPAL_LINK, "_blank", "noopener,noreferrer"));

    // Close modals
    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", () => closeModal(btn.getAttribute("data-close")));
    });
    document.querySelectorAll(".modalOverlay").forEach(ov => {
      ov.addEventListener("click", (e) => {
        if(e.target === ov) ov.classList.remove("show");
      });
    });

    // Tabs switching
    tabBtns.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

    // Athlete selection
    athleteSelect.addEventListener("change", () => {
      state.activeAthleteId = athleteSelect.value || null;
      saveState();
      renderAll();
    });

    // Analytics filter: update plot ONLY when distance changes (as you wanted)
    distanceFilter.addEventListener("change", () => {
      renderAnalytics(); // only chart + PB
    });

    // Preference
    timeHint.addEventListener("input", () => {
      prefs.timeHint = timeHint.value.trim() || "00:52.300";
      savePrefs();
    });

    // Add entry row
    document.getElementById("btnAddRow").addEventListener("click", () => addEntryRow());

    // Delegation: delete from race cards
    raceCardsWrap.addEventListener("click", (e) => {
      const del = e.target.closest("[data-del-entry-id]");
      if(del){
        deleteEntry(del.getAttribute("data-del-entry-id"));
        return;
      }
    });

    init();

    function init(){
      if(!state.athletes) state = structuredClone(defaultState);
      if(!prefs) prefs = structuredClone(defaultPrefs);

      timeHint.value = prefs.timeHint || "00:52.300";

      renderAll();
    }

    function switchTab(tab){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
      Object.keys(screens).forEach(k => screens[k].classList.toggle("active", k === tab));

      // Only re-render what's needed
      if(tab === "analytics") renderAnalytics();
      if(tab === "home") renderHome();
      if(tab === "export") renderExport();
      if(tab === "settings") {/* nothing heavy */}

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openModal(id){
      clearErrors();
      document.getElementById(id).classList.add("show");
    }
    function closeModal(id){
      document.getElementById(id).classList.remove("show");
    }

    function clearErrors(){
      ["athleteErr","entryErr","resetErr","importMsg","editAthErr"].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.classList.remove("show"); el.textContent=""; }
      });
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : structuredClone(defaultState);
      }catch(e){
        return structuredClone(defaultState);
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function loadPrefs(){
      try{
        const raw = localStorage.getItem(LS_PREF);
        return raw ? JSON.parse(raw) : structuredClone(defaultPrefs);
      }catch(e){
        return structuredClone(defaultPrefs);
      }
    }
    function savePrefs(){
      localStorage.setItem(LS_PREF, JSON.stringify(prefs));
    }

    function getActiveAthlete(){
      return state.athletes.find(a => a.id === state.activeAthleteId) || null;
    }
    function uid(){
      return "a_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function parseTimeToMs(t){
      if(!t) return null;
      t = (""+t).trim();

      // allow "50.123" seconds input
      if(/^\d+(\.\d{1,3})?$/.test(t)){
        const sec = Number(t);
        return Math.round(sec * 1000);
      }
      // mm:ss.mmm
      const m = t.match(/^(\d{1,2}):([0-5]\d)(?:\.(\d{1,3}))?$/);
      if(!m) return null;
      const mm = Number(m[1]);
      const ss = Number(m[2]);
      const ms = Number((m[3] || "0").padEnd(3,"0"));
      return (mm*60 + ss)*1000 + ms;
    }

    function msToTime(ms){
      if(ms == null || isNaN(ms)) return "‚Äî";
      const totalSec = Math.floor(ms/1000);
      const mm = Math.floor(totalSec/60);
      const ss = totalSec % 60;
      const msec = ms % 1000;
      return String(mm).padStart(2,"0")+":"+String(ss).padStart(2,"0")+"."+String(msec).padStart(3,"0");
    }

    function fmtDate(iso){
      if(!iso) return "‚Äî";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      }catch(e){ return iso; }
    }

    function sortByDateDesc(entries){
      return [...entries].sort((a,b)=> new Date(b.date) - new Date(a.date));
    }

    function computePBMap(entries){
      const pb = {};
      for(const e of entries){
        const ms = parseTimeToMs(e.time);
        if(ms == null) continue;
        if(!pb[e.distance] || ms < pb[e.distance].ms){
          pb[e.distance] = { ...e, ms };
        }
      }
      return pb;
    }

    function showError(id, msg){
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add("show");
    }

    function saveAthlete(){
      clearErrors();
      const name = document.getElementById("athName").value.trim();
      const year = document.getElementById("athYear").value.trim();

      if(!name){
        showError("athleteErr","Please enter a name.");
        return;
      }
      if(year && !/^\d{4}$/.test(year)){
        showError("athleteErr","Birth year should be 4 digits (e.g., 2014).");
        return;
      }

      const newAth = {
        id: uid(),
        name,
        birthYear: year || "",
        createdAt: new Date().toISOString(),
        entries: []
      };

      state.athletes.push(newAth);
      state.activeAthleteId = newAth.id;
      saveState();

      document.getElementById("athName").value = "";
      document.getElementById("athYear").value = "";
      closeModal("modalAthlete");

      renderAll();
    }

    function openEditAthlete(){
      const ath = getActiveAthlete();
      if(!ath) return;
      document.getElementById("editAthName").value = ath.name || "";
      document.getElementById("editAthYear").value = ath.birthYear || "";
      openModal("modalEditAthlete");
    }

    function saveAthleteEdits(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){
        showError("editAthErr","No athlete selected.");
        return;
      }

      const name = document.getElementById("editAthName").value.trim();
      const year = document.getElementById("editAthYear").value.trim();

      if(!name){
        showError("editAthErr","Please enter a name.");
        return;
      }
      if(year && !/^\d{4}$/.test(year)){
        showError("editAthErr","Birth year should be 4 digits (e.g., 2014).");
        return;
      }

      ath.name = name;
      ath.birthYear = year || "";
      saveState();
      closeModal("modalEditAthlete");

      renderAll();
    }

    function openEntryModal(){
      clearErrors();
      const dateEl = document.getElementById("enDate");
      dateEl.valueAsDate = new Date();

      document.getElementById("enLocation").value = "";
      document.getElementById("enNotes").value = "";

      entryRowsEl.innerHTML = "";
      addEntryRow("400m", "", true);
      openModal("modalEntry");
    }

    function addEntryRow(distance="500m", time="", isFirst=false){
      const row = document.createElement("div");
      row.className = "entryRow";

      row.innerHTML = `
        <div class="field">
          <label>Distance</label>
          <select class="select2 jsDist">
            <option value="111m">111m</option>
            <option value="222m">222m</option>
            <option value="333m">333m</option>
            <option value="400m">400m</option>
            <option value="500m">500m</option>
            <option value="800m">800m</option>
            <option value="1000m">1000m</option>
            <option value="1500m">1500m</option>
          </select>
        </div>

        <div class="field">
          <label>Time (mm:ss.mmm)</label>
          <input class="input jsTime" placeholder="${escapeHtml(prefs.timeHint || "00:52.300")}" value="${escapeHtml(time || "")}" />
        </div>

        <div style="display:flex; justify-content:flex-end;">
          <button class="miniBtn miniBtnDanger jsRemove" ${isFirst ? "disabled style='opacity:.45; cursor:not-allowed;'" : ""}>Remove</button>
        </div>
      `;

      entryRowsEl.appendChild(row);
      row.querySelector(".jsDist").value = distance;

      const removeBtn = row.querySelector(".jsRemove");
      removeBtn.addEventListener("click", () => {
        if(removeBtn.disabled) return;
        row.remove();
      });
    }

    function saveEntryMulti(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){
        showError("entryErr","No athlete selected. Add/select an athlete first.");
        return;
      }

      const date = document.getElementById("enDate").value;
      const location = document.getElementById("enLocation").value.trim();
      const notes = document.getElementById("enNotes").value.trim();

      if(!date){
        showError("entryErr","Please select a date.");
        return;
      }
      if(!location){
        showError("entryErr","Please enter a location (e.g., Scarborough).");
        return;
      }

      const rows = [...entryRowsEl.querySelectorAll(".entryRow")];
      if(rows.length === 0){
        showError("entryErr","Please add at least one distance/time.");
        return;
      }

      for(const r of rows){
        const dist = r.querySelector(".jsDist").value;
        const timeStr = r.querySelector(".jsTime").value.trim();
        const ms = parseTimeToMs(timeStr);

        if(ms == null){
          showError("entryErr",`One or more times are invalid. Use mm:ss.mmm (example: ${prefs.timeHint}).`);
          return;
        }

        const entry = {
          id: "e_" + Math.random().toString(16).slice(2) + Date.now().toString(16),
          date,
          distance: dist,
          time: timeStr,
          location,
          notes
        };

        ath.entries.push(entry);
      }

      saveState();
      closeModal("modalEntry");
      renderAll();
    }

    function deleteEntry(entryId){
      const ath = getActiveAthlete();
      if(!ath) return;

      const entry = (ath.entries || []).find(e => e.id === entryId);
      if(!entry) return;

      const msg = `Delete this entry?\n\n${fmtDate(entry.date)} ‚Ä¢ ${entry.location || "‚Äî"} ‚Ä¢ ${entry.distance} ‚Ä¢ ${entry.time}`;
      if(!confirm(msg)) return;

      ath.entries = (ath.entries || []).filter(e => e.id !== entryId);
      saveState();
      renderAll();
    }

    function doResetAll(){
      clearErrors();
      const txt = document.getElementById("resetConfirm").value.trim();
      if(txt !== "RESET"){
        showError("resetErr","Please type RESET exactly to confirm.");
        return;
      }
      localStorage.removeItem(LS_KEY);
      state = structuredClone(defaultState);
      closeModal("modalReset");
      renderAll();
    }

    function renderAll(){
      renderAthleteSelect();
      renderHeaderPill();
      renderHome();
      renderAnalytics(); // keeps analytics consistent if user is on it
      renderExport();
    }

    function renderAthleteSelect(){
      athleteSelect.innerHTML = "";

      if(state.athletes.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No athletes yet";
        athleteSelect.appendChild(opt);
        state.activeAthleteId = null;
        saveState();
        return;
      }

      if(!state.activeAthleteId || !state.athletes.some(a => a.id === state.activeAthleteId)){
        state.activeAthleteId = state.athletes[0].id;
        saveState();
      }

      for(const a of state.athletes){
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = a.name + (a.birthYear ? ` (${a.birthYear})` : "");
        athleteSelect.appendChild(opt);
      }
      athleteSelect.value = state.activeAthleteId;
    }

    function renderHeaderPill(){
      const ath = getActiveAthlete();
      if(!ath){
        activeAthletePill.textContent = "No athlete selected";
      }else{
        activeAthletePill.textContent = ath.name + (ath.birthYear ? ` (${ath.birthYear})` : "");
      }
    }

    function renderHome(){
      const ath = getActiveAthlete();

      if(!ath){
        pillPBCount.textContent = "0 PBs";
        pillTotalRaces.textContent = "0 races";
        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No athlete selected</strong>
            <p>Add an athlete and start entering races.</p>
          </div>
        `;
        raceCardsWrap.innerHTML = `
          <div class="empty">
            <strong>No race cards yet</strong>
            <p>Once you add races, cards will appear grouped by distance.</p>
          </div>
        `;
        return;
      }

      const entriesAll = sortByDateDesc(ath.entries || []);
      pillTotalRaces.textContent = `${entriesAll.length} races`;

      const pbMap = computePBMap(entriesAll);
      const pbCount = Object.keys(pbMap).length;
      pillPBCount.textContent = `${pbCount} PBs`;

      // PB Summary with ensured location filled from PB entry
      if(pbCount === 0){
        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No PBs yet</strong>
            <p>Add race entries and PBs will appear automatically for each distance.</p>
          </div>
        `;
      }else{
        const distances = Object.keys(pbMap).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
        pbSummaryWrap.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Distance</th>
                <th>PB</th>
                <th>Date</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody>
              ${distances.map(d=>{
                const pb = pbMap[d];
                return `
                  <tr>
                    <td><span class="badge">${escapeHtml(d)}</span></td>
                    <td><b>${msToTime(pb.ms)}</b></td>
                    <td>${fmtDate(pb.date)}</td>
                    <td>${escapeHtml(pb.location || "‚Äî")}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;
      }

      // Race cards grouped by distance (UNO-hand)
      const byDist = {};
      for(const e of entriesAll){
        if(!byDist[e.distance]) byDist[e.distance] = [];
        byDist[e.distance].push(e);
      }
      const distKeys = Object.keys(byDist).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));

      if(distKeys.length === 0){
        raceCardsWrap.innerHTML = `
          <div class="empty">
            <strong>No races yet</strong>
            <p>Add race entries to start tracking improvements and PBs.</p>
          </div>
        `;
        return;
      }

      raceCardsWrap.innerHTML = `
        <div class="raceStrip">
          ${distKeys.map(dist=>{
            const list = byDist[dist];
            // newest on top already (entriesAll sorted desc, so list is in desc order as pushed)
            const pbMs = pbMap[dist]?.ms ?? null;

            return `
              <div class="raceCard">
                <div class="raceCardTop">
                  <div class="dist">${escapeHtml(dist)}</div>
                  <div class="count">${list.length} entr${list.length===1?"y":"ies"}</div>
                </div>

                <div class="raceList">
                  ${list.map(e=>{
                    const ms = parseTimeToMs(e.time);
                    const isPB = (pbMs != null && ms != null && ms === pbMs);
                    return `
                      <div class="raceItem">
                        <div>
                          <div class="meta">
                            <b>${fmtDate(e.date)}</b><br/>
                            ${escapeHtml(e.location || "‚Äî")} ${e.notes ? `‚Ä¢ ${escapeHtml(e.notes)}` : ""}
                          </div>
                          <div style="margin-top:6px;">
                            ${isPB ? `<span class="badge badgePB">üèÖ PB</span>` : `<span class="badge badgeOK">Saved</span>`}
                          </div>
                        </div>

                        <div>
                          <div class="time">${escapeHtml(e.time)}</div>
                          <div class="actions">
                            <button class="miniIcon miniIconDanger" title="Delete" data-del-entry-id="${e.id}">üóëÔ∏è</button>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join("")}
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    function renderAnalytics(){
      const ath = getActiveAthlete();
      const dist = distanceFilter.value;

      if(!ath){
        pillAnalytics.textContent = "No athlete";
        pbDisplay.textContent = "Select a distance to display PB";
        drawChart([]);
        return;
      }

      pillAnalytics.textContent = ath.name + (ath.birthYear ? ` (${ath.birthYear})` : "");

      if(!dist){
        pbDisplay.textContent = "Select a distance to display PB";
        drawChart([]);
        return;
      }

      const entries = (ath.entries || []).filter(e => e.distance === dist);
      const pbMap = computePBMap(entries);
      const pb = pbMap[dist]?.ms ?? null;

      pbDisplay.textContent = pb != null ? msToTime(pb) : "No PB found for this distance yet";

      drawChart(entries);
    }

    function renderExport(){
      const ath = getActiveAthlete();
      pillExport.textContent = ath ? `Selected: ${ath.name}` : "No athlete";
    }

    /* -------- Chart (black text, readable) -------- */
    function drawChart(entries){
      const data = [...entries]
        .filter(e => parseTimeToMs(e.time)!=null)
        .sort((a,b)=> new Date(a.date)-new Date(b.date));

      const points = data.map(e => ({
        x: new Date(e.date).getTime(),
        y: parseTimeToMs(e.time)
      }));

      // Clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Background
      ctx.fillStyle = "rgba(255,255,255,.86)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      if(points.length < 2){
        ctx.fillStyle = "rgba(10,14,24,.78)";
        ctx.font = "1000 26px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
        ctx.fillText("Select a distance and add entries to see trend", 50, 210);
        ctx.fillStyle = "rgba(10,14,24,.55)";
        ctx.font = "900 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
        ctx.fillText("Tip: Add at least 2 races for the selected distance.", 50, 245);
        return;
      }

      const padL = 78, padR=30, padT=26, padB=56;
      const W = canvas.width - padL - padR;
      const H = canvas.height - padT - padB;

      const xs = points.map(p=>p.x);
      const ys = points.map(p=>p.y);

      const minX = Math.min(...xs);
      const maxX = Math.max(...xs);

      let minY = Math.min(...ys);
      let maxY = Math.max(...ys);

      const padY = Math.max(120, (maxY-minY)*0.12);
      minY -= padY;
      maxY += padY;

      // grid
      ctx.strokeStyle = "rgba(10,14,24,.08)";
      ctx.lineWidth = 1;
      const gridCount = 5;
      for(let i=0;i<=gridCount;i++){
        const y = padT + (H/gridCount)*i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL+W, y);
        ctx.stroke();
      }

      // y labels
      ctx.fillStyle = "rgba(10,14,24,.70)";
      ctx.font = "1000 15px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
      for(let i=0;i<=gridCount;i++){
        const y = padT + (H/gridCount)*i;
        const val = maxY - ( (maxY-minY)/gridCount )*i;
        ctx.fillText(msToTime(Math.round(val)), 14, y+5);
      }

      // x labels
      ctx.fillStyle = "rgba(10,14,24,.65)";
      ctx.font = "1000 15px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
      const startLabel = fmtDate(new Date(minX).toISOString().slice(0,10));
      const endLabel = fmtDate(new Date(maxX).toISOString().slice(0,10));
      ctx.fillText(startLabel, padL, canvas.height-18);
      const endWidth = ctx.measureText(endLabel).width;
      ctx.fillText(endLabel, padL+W-endWidth, canvas.height-18);

      const toX = (x)=> padL + ((x-minX)/(maxX-minX))*W;
      const toY = (y)=> padT + ((maxY-y)/(maxY-minY))*H;

      // line gradient
      const grad = ctx.createLinearGradient(padL,0,padL+W,0);
      grad.addColorStop(0, "rgba(31,86,255,.92)");
      grad.addColorStop(1, "rgba(43,183,255,.92)");

      ctx.strokeStyle = grad;
      ctx.lineWidth = 4;
      ctx.beginPath();
      points.forEach((p,idx)=>{
        const x = toX(p.x);
        const y = toY(p.y);
        if(idx===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // points
      points.forEach((p)=>{
        const x = toX(p.x);
        const y = toY(p.y);
        ctx.fillStyle = "rgba(10,14,24,.88)";
        ctx.beginPath();
        ctx.arc(x,y,5,0,Math.PI*2);
        ctx.fill();
      });
    }

    /* -------- CSV Export / Import -------- */

    function exportCSV(){
      const ath = getActiveAthlete();
      if(!ath){
        alert("Please select an athlete first.");
        return;
      }
      const rows = [["Athlete","BirthYear","Date","Location","Distance","Time","Notes"]];
      for(const e of sortByDateDesc(ath.entries || [])){
        rows.push([ath.name, ath.birthYear || "", e.date, e.location || "", e.distance, e.time, (e.notes||"")]);
      }
      const csv = rows.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type:"text/csv" });
      downloadBlob(blob, `PB-${ath.name.replaceAll(" ","_")}.csv`);
    }

    function downloadSampleCSV(){
      const rows = [
        ["Athlete","BirthYear","Date","Location","Distance","Time","Notes"],
        ["Samarveer","2014","2025-11-29","Kingston","400m","00:50.000","sample row"]
      ];
      const csv = rows.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type:"text/csv" });
      downloadBlob(blob, "PB-Tracker-Sample.csv");
    }

    function importCSVIntoSelected(){
      clearErrors();

      const ath = getActiveAthlete();
      if(!ath){
        showError("importMsg","Please select an athlete first.");
        return;
      }

      const file = csvFile.files && csvFile.files[0];
      if(!file){
        showError("importMsg","Please choose a CSV file first.");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        try{
          const text = String(reader.result || "");
          const parsed = parseCSV(text);

          if(parsed.length < 2){
            showError("importMsg","CSV looks empty. Please check the file.");
            return;
          }

          const header = parsed[0].map(h => (h||"").trim());
          const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

          const iDate = idx("Date");
          const iLoc  = idx("Location");
          const iDist = idx("Distance");
          const iTime = idx("Time");
          const iNotes= idx("Notes");

          if(iDate < 0 || iLoc < 0 || iDist < 0 || iTime < 0){
            showError("importMsg","CSV must include headings: Date, Location, Distance, Time (Notes optional).");
            return;
          }

          let added = 0;

          for(let r=1; r<parsed.length; r++){
            const row = parsed[r];
            if(!row || row.length === 0) continue;

            const date = (row[iDate]||"").trim();
            const location = (row[iLoc]||"").trim();
            const distance = (row[iDist]||"").trim();
            const time = (row[iTime]||"").trim();
            const notes = (iNotes>=0 ? (row[iNotes]||"").trim() : "");

            if(!date || !location || !distance || !time) continue;

            // validate time
            const ms = parseTimeToMs(time);
            if(ms == null) continue;

            ath.entries.push({
              id: "e_" + Math.random().toString(16).slice(2) + Date.now().toString(16),
              date,
              distance,
              time,
              location,
              notes
            });
            added++;
          }

          saveState();
          importMsg.classList.remove("show");
          alert(`Imported ${added} entries into ${ath.name}.`);
          renderAll();

        }catch(e){
          showError("importMsg","Could not read CSV. Please upload a valid CSV file.");
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(text){
      // Simple CSV parser that handles quoted fields
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0; i<text.length; i++){
        const ch = text[i];
        const next = text[i+1];

        if(ch === '"' ){
          if(inQuotes && next === '"'){
            cur += '"';
            i++;
          }else{
            inQuotes = !inQuotes;
          }
          continue;
        }

        if(!inQuotes && (ch === ",")){
          row.push(cur);
          cur = "";
          continue;
        }

        if(!inQuotes && (ch === "\n")){
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }

        if(!inQuotes && ch === "\r"){
          continue;
        }

        cur += ch;
      }

      // last field
      if(cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }

      // trim trailing empty lines
      while(rows.length && rows[rows.length-1].every(c => (c||"").trim()==="")){
        rows.pop();
      }
      return rows;
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>

</body>
</html>
