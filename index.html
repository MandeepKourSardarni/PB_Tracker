<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PB VelocityBoard</title>

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.50);
      --primary: #7c5cff;
      --primary2:#4ad9ff;
      --danger:#ff4d6d;
      --ok:#3ee08f;
      --warn:#ffcc66;

      --radius: 18px;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --shadow2: 0 10px 20px rgba(0,0,0,.22);

      --w: 1180px;
      --gap: 14px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    * { box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,92,255,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(74,217,255,.20), transparent 55%),
        radial-gradient(900px 650px at 40% 90%, rgba(62,224,143,.14), transparent 55%),
        linear-gradient(180deg, var(--bg), #070a14 70%);
      overflow-x:hidden;
    }

    button, input, select { font-family:inherit; }

    .wrap{
      max-width: var(--w);
      margin: 0 auto;
      padding: 92px 18px 26px;
    }

    /* ---------- APP BAR ---------- */
    .appbar{
      position:fixed;
      top:0; left:0; right:0;
      z-index:50;
      backdrop-filter: blur(16px);
      background: rgba(5,8,16,.55);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .appbarInner{
      max-width: var(--w);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 18px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 220px;
    }
    .logo{
      width: 36px; height: 36px;
      border-radius: 12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.32), transparent 55%),
        linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 10px 22px rgba(124,92,255,.25);
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.12;
    }
    .brandText strong{
      font-size: 15.5px;
      letter-spacing:.2px;
    }
    .brandText span{
      font-size: 12px;
      color: var(--muted);
    }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 6px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
    }
    .tabBtn{
      border:0;
      padding: 9px 14px;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      font-weight:600;
      letter-spacing:.2px;
      cursor:pointer;
      transition: .18s ease;
    }
    .tabBtn:hover{ color: var(--text); background: rgba(255,255,255,.06); }
    .tabBtn.active{
      color: var(--text);
      background: rgba(124,92,255,.22);
      border: 1px solid rgba(124,92,255,.35);
      box-shadow: 0 10px 26px rgba(124,92,255,.18);
    }

    /* RIGHT TOOLBAR - keep one row on desktop */
    .rightTools{
      display:flex;
      align-items:center;
      gap: 8px;
      justify-content:flex-end;
      flex-wrap:nowrap;
    }

    .select{
      appearance:none;
      -webkit-appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 34px 10px 12px;
      border-radius: 14px;
      font-weight:800;
      outline:none;
      cursor:pointer;
      min-width: 200px;
    }
    .selectWrap{ position:relative; }
    .selectWrap:after{
      content:"‚ñæ";
      position:absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-52%);
      color: var(--muted);
      pointer-events:none;
      font-size: 12px;
    }

    /* dropdown visibility fix */
    select, option {
      color: var(--text);
      background-color: #0a1020;
    }
    .select2, .select2 option{
      color: var(--text);
      background-color: #0a1020;
    }

    /* Buttons fit to text */
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      transition: .18s ease;
      box-shadow: var(--shadow2);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .btn:active{ transform: translateY(0px); }

    .btnPrimary{
      border: 1px solid rgba(124,92,255,.35);
      background: linear-gradient(135deg, rgba(124,92,255,.42), rgba(74,217,255,.18));
      box-shadow: 0 14px 34px rgba(124,92,255,.20);
    }
    .btnDanger{
      border: 1px solid rgba(255,77,109,.35);
      background: rgba(255,77,109,.14);
      box-shadow: 0 14px 34px rgba(255,77,109,.12);
    }

    /* ---------- LAYOUT ---------- */
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: var(--gap);
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: 160px; }
      .select{ min-width: 180px; }
    }

    .card{
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 3px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      font-weight:900;
      white-space:nowrap;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }
    .kpi{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .label{ color: var(--muted); font-size: 12px; font-weight:900; }
    .kpi .value{ margin-top: 6px; font-size: 18px; font-weight: 900; letter-spacing:.3px; }
    .kpi .mini{ margin-top: 4px; color: var(--muted2); font-size: 12px; }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 12px;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
    }
    .table th, .table td{
      padding: 10px 10px;
      font-size: 13px;
      border-bottom:1px solid rgba(255,255,255,.07);
      text-align:left;
      vertical-align:top;
    }
    .table th{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.3px;
      background: rgba(255,255,255,.04);
    }
    .table tr:hover td{ background: rgba(255,255,255,.03); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }
    .badgeOK{ border-color: rgba(62,224,143,.35); background: rgba(62,224,143,.10); }
    .badgePB{ border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.10); }

    /* ---------- CHART ---------- */
    .chart{
      width:100%;
      height: 240px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      margin-top: 12px;
      position:relative;
    }
    .chart canvas{
      width:100%;
      height:100%;
      display:block;
    }
    .chartHint{
      position:absolute;
      left: 12px;
      top: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.2px;
    }

    /* ---------- EMPTY STATE ---------- */
    .empty{
      border:1px dashed rgba(255,255,255,.20);
      border-radius: 18px;
      padding: 18px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
      margin-top: 10px;
    }
    .empty strong{ color: var(--text); }
    .empty p{ margin: 8px 0 0; font-size: 13px; line-height:1.45; }

    /* ---------- TOAST / BANNER ---------- */
    .banner{
      display:none;
      margin: 0 0 14px;
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(255,204,102,.35);
      background: rgba(255,204,102,.11);
      box-shadow: 0 18px 50px rgba(255,204,102,.10);
    }
    .banner.show{ display:block; }
    .banner strong{ font-weight: 900; }
    .banner .small{ color: var(--muted); font-size: 12px; margin-top: 3px; }

    /* ---------- MODAL ---------- */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 100;
      align-items:center;
      justify-content:center;
      padding: 20px;
    }
    .modalOverlay.show{ display:flex; }

    /* KEY FIX: MODAL SCROLL */
    .modal{
      width: min(700px, 100%);
      max-height: calc(100vh - 70px);
      overflow:auto;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(18,26,48,.95), rgba(10,14,26,.95));
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(18,26,48,.98), rgba(18,26,48,.85));
      padding-bottom: 10px;
      z-index: 2;
    }
    .modalTop h3{
      margin:0;
      font-size: 16px;
      font-weight: 900;
    }
    .modalTop p{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }
    .xbtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      width: 38px; height: 38px;
      cursor:pointer;
      font-weight: 900;
      flex: 0 0 auto;
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing:.2px;
    }
    .input, .select2{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight: 900;
    }
    .help{
      font-size: 12px;
      color: var(--muted2);
      line-height:1.35;
    }
    .error{
      display:none;
      color: #ffd1d9;
      background: rgba(255,77,109,.12);
      border: 1px solid rgba(255,77,109,.25);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      margin-top: 10px;
    }
    .error.show{ display:block; }

    .modalActions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 12px;
      flex-wrap:wrap;
      position: sticky;
      bottom: 0;
      background: linear-gradient(0deg, rgba(18,26,48,.98), rgba(18,26,48,.85));
      padding-top: 10px;
      z-index: 2;
    }

    /* Multi-entry rows */
    .entryRows{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 8px;
    }
    .entryRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items:end;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px;
    }
    .miniBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      transition:.18s ease;
      white-space:nowrap;
    }
    .miniBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .miniBtnDanger{
      border:1px solid rgba(255,77,109,.30);
      background: rgba(255,77,109,.12);
    }

    .foot{
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12px;
      line-height:1.45;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* Mobile behavior: allow wrap, but keep Reset next to Add Race if possible */
    @media (max-width: 560px){
      .tabs{ display:none; }
      .brandText span{ display:none; }
      .wrap{ padding-top: 84px; }
      .rightTools{ flex-wrap:wrap; justify-content:flex-start; }
      .select{ min-width: 100%; }
      .form{ grid-template-columns: 1fr; }
      .entryRow{ grid-template-columns: 1fr; }
      .modal{ max-height: calc(100vh - 40px); }
    }
  </style>
</head>

<body>

  <div class="appbar">
    <div class="appbarInner">

      <div class="brand">
        <div class="logo"></div>
        <div class="brandText">
          <strong>PB VelocityBoard</strong>
          <span>Track ‚Ä¢ Improve ‚Ä¢ Celebrate</span>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="PB VelocityBoard Tabs">
        <button class="tabBtn active" data-tab="home">Home</button>
        <button class="tabBtn" data-tab="analytics">Analytics</button>
        <button class="tabBtn" data-tab="export">Export</button>
        <button class="tabBtn" data-tab="settings">Settings</button>
      </div>

      <div class="rightTools">
        <div class="selectWrap">
          <select id="athleteSelect" class="select" title="Select Athlete"></select>
        </div>
        <button class="btn" id="btnEditAthlete">Edit</button>
        <button class="btn btnPrimary" id="btnAddAthlete">+ Add Athlete</button>
        <button class="btn" id="btnAddEntry">+ Add Race</button>
        <button class="btn btnDanger" id="btnReset">Reset</button>
      </div>

    </div>
  </div>

  <div class="wrap">

    <div id="pbBanner" class="banner">
      <strong>üéâ New PB!</strong>
      <div class="small" id="pbBannerText">Saved.</div>
    </div>

    <!-- HOME -->
    <section id="screenHome" class="screen active">
      <div class="grid">

        <!-- LEFT CARD -->
        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="title">Performance Snapshot</div>
              <div class="sub">Latest results + PB highlights for the selected athlete.</div>
            </div>
            <div class="pill" id="pillAthlete">No athlete selected</div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">PB (Selected Distance)</div>
              <div class="value" id="kpiPB">‚Äî</div>
              <div class="mini" id="kpiPBDistance">Pick a distance</div>
            </div>

            <div class="kpi">
              <div class="label">Latest Time</div>
              <div class="value" id="kpiLatest">‚Äî</div>
              <div class="mini" id="kpiLatestMeta">‚Äî</div>
            </div>

            <div class="kpi">
              <div class="label">Avg (Last 10)</div>
              <div class="value" id="kpiAvg10">‚Äî</div>
              <div class="mini">Lower is better</div>
            </div>

            <div class="kpi">
              <div class="label">Consistency</div>
              <div class="value" id="kpiCons">‚Äî</div>
              <div class="mini">Std Dev (last 10)</div>
            </div>
          </div>

          <div class="row">
            <div class="field" style="min-width:240px;">
              <label for="distanceFilter">Distance Focus</label>
              <select id="distanceFilter" class="select2">
                <option value="ALL">All distances</option>
                <option value="111m">111m</option>
                <option value="222m">222m</option>
                <option value="333m">333m</option>
                <option value="400m">400m</option>
                <option value="500m">500m</option>
                <option value="800m">800m</option>
                <option value="1000m">1000m</option>
                <option value="1500m">1500m</option>
              </select>
              <div class="help">This filter affects KPIs and the chart.</div>
            </div>

            <div class="pill" id="pillCount">0 races</div>
          </div>

          <div class="chart">
            <div class="chartHint">Trend (Time vs Race Date)</div>
            <canvas id="trendCanvas" width="1200" height="420"></canvas>
          </div>

          <div class="foot">
            Tip: Your data is saved on this device (local storage). Use Export if you want a backup.
          </div>
        </div>

        <!-- RIGHT CARD -->
        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="title">PB Summary + Recent Races</div>
              <div class="sub">All PBs (by distance) + latest entries.</div>
            </div>
            <div class="pill" id="pillPBCount">0 PBs</div>
          </div>

          <!-- NEW: PB SUMMARY ON HOME -->
          <div id="pbSummaryWrap"></div>

          <div style="height:10px;"></div>

          <div id="recentWrap"></div>

          <div class="foot">
            PBs are calculated per athlete per distance.
          </div>
        </div>

      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="screenAnalytics" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Analytics</div>
            <div class="sub">Clean, coach-friendly insight ‚Äî PB progression, averages, and consistency.</div>
          </div>
          <div class="pill" id="pillAnalytics">‚Äî</div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">Season Best (90d)</div>
            <div class="value" id="anBest90">‚Äî</div>
            <div class="mini" id="anBest90Meta">‚Äî</div>
          </div>

          <div class="kpi">
            <div class="label">Improvement (Last 5)</div>
            <div class="value" id="anImp5">‚Äî</div>
            <div class="mini">Latest vs oldest of last 5</div>
          </div>

          <div class="kpi">
            <div class="label">PB Count</div>
            <div class="value" id="anPBCount">‚Äî</div>
            <div class="mini">Across all distances</div>
          </div>

          <div class="kpi">
            <div class="label">Total Races</div>
            <div class="value" id="anTotal">‚Äî</div>
            <div class="mini">Entries stored</div>
          </div>
        </div>

        <table class="table" id="pbTable">
          <thead>
            <tr>
              <th>Distance</th>
              <th>PB Time</th>
              <th>Date</th>
              <th>Location</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="foot">
          PBs are computed per athlete per distance.
        </div>
      </div>
    </section>

    <!-- EXPORT -->
    <section id="screenExport" class="screen">
      <div class="grid">
        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="title">Export / Backup</div>
              <div class="sub">Download your data so you can move devices or share with a coach.</div>
            </div>
            <div class="pill" id="pillExport">‚Äî</div>
          </div>

          <div class="row">
            <button class="btn btnPrimary" id="btnExportJSON">Download JSON</button>
            <button class="btn" id="btnExportCSV">Download CSV (selected athlete)</button>
          </div>

          <div class="empty">
            <strong>Pro tip</strong>
            <p>Export JSON is the best backup. CSV is handy for coaches who prefer Excel.</p>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="title">Import JSON</div>
              <div class="sub">Restore your VelocityBoard backup.</div>
            </div>
          </div>

          <div class="field">
            <label>Upload JSON backup</label>
            <input class="input" id="importFile" type="file" accept=".json" />
            <div class="help">This will merge athletes.</div>
          </div>

          <div class="modalActions" style="justify-content:flex-start;">
            <button class="btn" id="btnImport">Import</button>
          </div>

          <div id="importMsg" class="error"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="screenSettings" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Settings</div>
            <div class="sub">Simple preferences for a clean experience.</div>
          </div>
          <div class="pill">Local Storage</div>
        </div>

        <div class="form">
          <div class="field">
            <label>Default Distance Focus</label>
            <select id="defaultDistance" class="select2">
              <option value="ALL">All distances</option>
              <option value="400m">400m</option>
              <option value="500m">500m</option>
              <option value="800m">800m</option>
              <option value="1000m">1000m</option>
              <option value="1500m">1500m</option>
            </select>
            <div class="help">Used when the app loads.</div>
          </div>

          <div class="field">
            <label>Time Format Reminder</label>
            <input id="timeHint" class="input" value="00:52.300" />
            <div class="help">Shown as example in the Add Race form.</div>
          </div>
        </div>

        <div class="empty" style="margin-top:12px;">
          <strong>Storage note</strong>
          <p>All data is stored on this device. To start fresh: Reset. To move devices: Export JSON and import it.</p>
        </div>
      </div>
    </section>

  </div>

  <!-- MODAL: ADD ATHLETE -->
  <div class="modalOverlay" id="modalAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Athlete</h3>
          <p>Create an athlete profile. You can add races after that.</p>
        </div>
        <button class="xbtn" data-close="modalAthlete">‚úï</button>
      </div>

      <div class="form">
        <div class="field">
          <label>Name</label>
          <input id="athName" class="input" placeholder="e.g., Samarveer" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="athYear" class="input" inputmode="numeric" placeholder="e.g., 2014" />
        </div>
      </div>

      <div id="athleteErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthlete">Save Athlete</button>
      </div>
    </div>
  </div>

  <!-- MODAL: EDIT ATHLETE -->
  <div class="modalOverlay" id="modalEditAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Edit Athlete</h3>
          <p>Update the athlete name (and birth year). PBs and entries remain unchanged.</p>
        </div>
        <button class="xbtn" data-close="modalEditAthlete">‚úï</button>
      </div>

      <div class="form">
        <div class="field">
          <label>Name</label>
          <input id="editAthName" class="input" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="editAthYear" class="input" inputmode="numeric" />
        </div>
      </div>

      <div id="editAthErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEditAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthleteEdits">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ADD ENTRY -->
  <div class="modalOverlay" id="modalEntry">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Race Entry</h3>
          <p>Same date + location can include multiple distances (400/500/800/1000 etc.).</p>
        </div>
        <button class="xbtn" data-close="modalEntry">‚úï</button>
      </div>

      <div class="form">
        <div class="field">
          <label>Date</label>
          <input id="enDate" class="input" type="date" />
        </div>

        <div class="field">
          <label>Location</label>
          <!-- UPDATED: plain text, no dropdown -->
          <input id="enLocation" class="input" placeholder="e.g., Scarborough" />
          <div class="help">Type any location (city or rink).</div>
        </div>

        <div class="field" style="grid-column:1 / -1;">
          <label>Notes (optional)</label>
          <input id="enNotes" class="input" placeholder="e.g., Meet name, lane, fall, etc." />
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>Distances & Times</label>
        <div class="help">Add one or more distances for this same date/location.</div>

        <div class="entryRows" id="entryRows"></div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="miniBtn" id="btnAddRow">+ Add another distance</button>
        </div>
      </div>

      <div id="entryErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEntry">Cancel</button>
        <button class="btn btnPrimary" id="saveEntry">Save Entry</button>
      </div>
    </div>
  </div>

  <!-- MODAL: RESET -->
  <div class="modalOverlay" id="modalReset">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Reset</h3>
          <p>This removes your stored data on this device. Type <strong>RESET</strong> to confirm.</p>
        </div>
        <button class="xbtn" data-close="modalReset">‚úï</button>
      </div>

      <div class="field">
        <label>Type RESET</label>
        <input id="resetConfirm" class="input" placeholder="RESET" />
        <div class="help">Tip: Export JSON first if you want a backup.</div>
      </div>

      <div id="resetErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalReset">Cancel</button>
        <button class="btn btnDanger" id="doReset">Reset Everything</button>
      </div>
    </div>
  </div>


  <script>
    const LS_KEY = "pb_velocityboard_v7_singlefile";
    const LS_PREF = "pb_velocityboard_prefs_v7";

    const defaultState = { athletes: [], activeAthleteId: null };
    const defaultPrefs = { defaultDistance: "ALL", timeHint: "00:52.300" };

    let state = loadState();
    let prefs = loadPrefs();

    const tabBtns = [...document.querySelectorAll(".tabBtn")];
    const screens = {
      home: document.getElementById("screenHome"),
      analytics: document.getElementById("screenAnalytics"),
      export: document.getElementById("screenExport"),
      settings: document.getElementById("screenSettings")
    };

    const athleteSelect = document.getElementById("athleteSelect");
    const distanceFilter = document.getElementById("distanceFilter");

    const pbBanner = document.getElementById("pbBanner");
    const pbBannerText = document.getElementById("pbBannerText");

    const kpiPB = document.getElementById("kpiPB");
    const kpiPBDistance = document.getElementById("kpiPBDistance");
    const kpiLatest = document.getElementById("kpiLatest");
    const kpiLatestMeta = document.getElementById("kpiLatestMeta");
    const kpiAvg10 = document.getElementById("kpiAvg10");
    const kpiCons = document.getElementById("kpiCons");

    const pillAthlete = document.getElementById("pillAthlete");
    const pillCount = document.getElementById("pillCount");
    const pillPBCount = document.getElementById("pillPBCount");
    const recentWrap = document.getElementById("recentWrap");
    const pbSummaryWrap = document.getElementById("pbSummaryWrap");

    const pillAnalytics = document.getElementById("pillAnalytics");
    const anBest90 = document.getElementById("anBest90");
    const anBest90Meta = document.getElementById("anBest90Meta");
    const anImp5 = document.getElementById("anImp5");
    const anPBCount = document.getElementById("anPBCount");
    const anTotal = document.getElementById("anTotal");
    const pbTableBody = document.querySelector("#pbTable tbody");

    const pillExport = document.getElementById("pillExport");
    const importFile = document.getElementById("importFile");
    const importMsg = document.getElementById("importMsg");

    const defaultDistance = document.getElementById("defaultDistance");
    const timeHint = document.getElementById("timeHint");

    const canvas = document.getElementById("trendCanvas");
    const ctx = canvas.getContext("2d");

    document.getElementById("btnAddAthlete").addEventListener("click", () => openModal("modalAthlete"));
    document.getElementById("btnEditAthlete").addEventListener("click", openEditAthlete);
    document.getElementById("btnAddEntry").addEventListener("click", () => {
      if(!getActiveAthlete()){
        flashBanner("Please add/select an athlete first.", false);
        openModal("modalAthlete");
        return;
      }
      openEntryModal();
    });
    document.getElementById("btnReset").addEventListener("click", () => openModal("modalReset"));

    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", () => closeModal(btn.getAttribute("data-close")));
    });
    document.querySelectorAll(".modalOverlay").forEach(ov => {
      ov.addEventListener("click", (e) => {
        if(e.target === ov) ov.classList.remove("show");
      });
    });

    document.getElementById("saveAthlete").addEventListener("click", saveAthlete);
    document.getElementById("saveAthleteEdits").addEventListener("click", saveAthleteEdits);
    document.getElementById("saveEntry").addEventListener("click", saveEntryMulti);
    document.getElementById("doReset").addEventListener("click", doResetAll);

    document.getElementById("btnExportJSON").addEventListener("click", exportJSON);
    document.getElementById("btnExportCSV").addEventListener("click", exportCSV);
    document.getElementById("btnImport").addEventListener("click", importJSON);

    tabBtns.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

    athleteSelect.addEventListener("change", () => {
      state.activeAthleteId = athleteSelect.value || null;
      saveState();
      renderAll();
    });

    distanceFilter.addEventListener("change", () => renderAll());

    defaultDistance.addEventListener("change", () => {
      prefs.defaultDistance = defaultDistance.value;
      savePrefs();
      distanceFilter.value = prefs.defaultDistance;
      renderAll();
    });

    timeHint.addEventListener("input", () => {
      prefs.timeHint = timeHint.value.trim() || "00:52.300";
      savePrefs();
    });

    const entryRowsEl = document.getElementById("entryRows");
    document.getElementById("btnAddRow").addEventListener("click", () => addEntryRow());

    init();

    function init(){
      if(!state.athletes) state = structuredClone(defaultState);
      if(!prefs) prefs = structuredClone(defaultPrefs);

      defaultDistance.value = prefs.defaultDistance;
      timeHint.value = prefs.timeHint;
      distanceFilter.value = prefs.defaultDistance;

      renderAll();
    }

    function switchTab(tab){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
      Object.keys(screens).forEach(k => screens[k].classList.toggle("active", k === tab));
      renderAll();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openModal(id){
      clearErrors();
      document.getElementById(id).classList.add("show");
    }
    function closeModal(id){
      document.getElementById(id).classList.remove("show");
    }

    function clearErrors(){
      ["athleteErr","entryErr","resetErr","importMsg","editAthErr"].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.classList.remove("show"); el.textContent=""; }
      });
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : structuredClone(defaultState);
      }catch(e){
        return structuredClone(defaultState);
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function loadPrefs(){
      try{
        const raw = localStorage.getItem(LS_PREF);
        return raw ? JSON.parse(raw) : structuredClone(defaultPrefs);
      }catch(e){
        return structuredClone(defaultPrefs);
      }
    }
    function savePrefs(){
      localStorage.setItem(LS_PREF, JSON.stringify(prefs));
    }

    function getActiveAthlete(){
      return state.athletes.find(a => a.id === state.activeAthleteId) || null;
    }
    function uid(){
      return "a_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function parseTimeToMs(t){
      if(!t) return null;
      t = (""+t).trim();
      if(/^\d+(\.\d{1,3})?$/.test(t)){
        const sec = Number(t);
        return Math.round(sec * 1000);
      }
      const m = t.match(/^(\d{1,2}):([0-5]\d)(?:\.(\d{1,3}))?$/);
      if(!m) return null;
      const mm = Number(m[1]);
      const ss = Number(m[2]);
      const ms = Number((m[3] || "0").padEnd(3,"0"));
      return (mm*60 + ss)*1000 + ms;
    }

    function msToTime(ms){
      if(ms == null || isNaN(ms)) return "‚Äî";
      const totalSec = Math.floor(ms/1000);
      const mm = Math.floor(totalSec/60);
      const ss = totalSec % 60;
      const msec = ms % 1000;
      return String(mm).padStart(2,"0")+":"+String(ss).padStart(2,"0")+"."+String(msec).padStart(3,"0");
    }

    function fmtDate(iso){
      if(!iso) return "‚Äî";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      }catch(e){ return iso; }
    }

    function sortByDateDesc(entries){
      return [...entries].sort((a,b)=> new Date(b.date) - new Date(a.date));
    }

    function mean(arr){
      if(!arr.length) return null;
      return arr.reduce((s,x)=>s+x,0)/arr.length;
    }
    function stddev(arr){
      if(arr.length < 2) return null;
      const m = mean(arr);
      const v = mean(arr.map(x => (x-m)*(x-m)));
      return Math.sqrt(v);
    }

    function computePBMap(entries){
      const pb = {};
      for(const e of entries){
        const ms = parseTimeToMs(e.time);
        if(ms == null) continue;
        if(!pb[e.distance] || ms < pb[e.distance].ms){
          pb[e.distance] = { ...e, ms };
        }
      }
      return pb;
    }

    function showError(id, msg){
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add("show");
    }

    function flashBanner(msg, isPB){
      pbBannerText.textContent = msg;
      pbBanner.style.borderColor = isPB ? "rgba(255,204,102,.35)" : "rgba(255,255,255,.12)";
      pbBanner.style.background = isPB ? "rgba(255,204,102,.11)" : "rgba(255,255,255,.06)";
      pbBanner.classList.add("show");
      clearTimeout(flashBanner._t);
      flashBanner._t = setTimeout(()=> pbBanner.classList.remove("show"), 4200);
    }

    function saveAthlete(){
      clearErrors();
      const name = document.getElementById("athName").value.trim();
      const year = document.getElementById("athYear").value.trim();

      if(!name){
        showError("athleteErr","Please enter a name.");
        return;
      }
      if(year && !/^\d{4}$/.test(year)){
        showError("athleteErr","Birth year should be 4 digits (e.g., 2014).");
        return;
      }

      const newAth = {
        id: uid(),
        name,
        birthYear: year || "",
        createdAt: new Date().toISOString(),
        entries: []
      };

      state.athletes.push(newAth);
      state.activeAthleteId = newAth.id;
      saveState();

      document.getElementById("athName").value = "";
      document.getElementById("athYear").value = "";
      closeModal("modalAthlete");

      flashBanner(`Athlete added: ${name}`, false);
      renderAll();
    }

    function openEditAthlete(){
      const ath = getActiveAthlete();
      if(!ath){
        flashBanner("No athlete selected.", false);
        return;
      }
      document.getElementById("editAthName").value = ath.name || "";
      document.getElementById("editAthYear").value = ath.birthYear || "";
      openModal("modalEditAthlete");
    }

    function saveAthleteEdits(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){
        showError("editAthErr","No athlete selected.");
        return;
      }

      const name = document.getElementById("editAthName").value.trim();
      const year = document.getElementById("editAthYear").value.trim();

      if(!name){
        showError("editAthErr","Please enter a name.");
        return;
      }
      if(year && !/^\d{4}$/.test(year)){
        showError("editAthErr","Birth year should be 4 digits (e.g., 2014).");
        return;
      }

      ath.name = name;
      ath.birthYear = year || "";
      saveState();
      closeModal("modalEditAthlete");

      flashBanner("Athlete updated.", false);
      renderAll();
    }

    function openEntryModal(){
      clearErrors();
      const dateEl = document.getElementById("enDate");
      dateEl.valueAsDate = new Date();

      document.getElementById("enLocation").value = "";
      document.getElementById("enNotes").value = "";

      entryRowsEl.innerHTML = "";
      addEntryRow("400m", "", true);
      openModal("modalEntry");
    }

    function addEntryRow(distance="500m", time="", isFirst=false){
      const row = document.createElement("div");
      row.className = "entryRow";

      row.innerHTML = `
        <div class="field">
          <label>Distance</label>
          <select class="select2 jsDist">
            <option value="111m">111m</option>
            <option value="222m">222m</option>
            <option value="333m">333m</option>
            <option value="400m">400m</option>
            <option value="500m">500m</option>
            <option value="800m">800m</option>
            <option value="1000m">1000m</option>
            <option value="1500m">1500m</option>
          </select>
        </div>

        <div class="field">
          <label>Time (mm:ss.mmm)</label>
          <input class="input jsTime" placeholder="${escapeHtml(prefs.timeHint || "00:52.300")}" value="${escapeHtml(time || "")}" />
          <div class="help">Example: ${escapeHtml(prefs.timeHint || "00:52.300")}</div>
        </div>

        <div style="display:flex; justify-content:flex-end;">
          <button class="miniBtn miniBtnDanger jsRemove" ${isFirst ? "disabled style='opacity:.45; cursor:not-allowed;'" : ""}>Remove</button>
        </div>
      `;

      entryRowsEl.appendChild(row);

      const distSel = row.querySelector(".jsDist");
      distSel.value = distance;

      const removeBtn = row.querySelector(".jsRemove");
      removeBtn.addEventListener("click", () => {
        if(removeBtn.disabled) return;
        row.remove();
      });
    }

    function saveEntryMulti(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){
        showError("entryErr","No athlete selected. Add/select an athlete first.");
        return;
      }

      const date = document.getElementById("enDate").value;
      const location = document.getElementById("enLocation").value.trim();
      const notes = document.getElementById("enNotes").value.trim();

      if(!date){
        showError("entryErr","Please select a date.");
        return;
      }
      if(!location){
        showError("entryErr","Please enter a location (e.g., Scarborough).");
        return;
      }

      const rows = [...entryRowsEl.querySelectorAll(".entryRow")];
      if(rows.length === 0){
        showError("entryErr","Please add at least one distance/time.");
        return;
      }

      const beforePBMap = computePBMap(ath.entries || []);
      let savedCount = 0;
      let pbMessages = [];

      for(const r of rows){
        const dist = r.querySelector(".jsDist").value;
        const timeStr = r.querySelector(".jsTime").value.trim();
        const ms = parseTimeToMs(timeStr);

        if(ms == null){
          showError("entryErr",`One or more times are invalid. Use mm:ss.mmm (example: ${prefs.timeHint}).`);
          return;
        }

        const beforePB = beforePBMap[dist]?.ms ?? null;

        const entry = {
          id: "e_" + Math.random().toString(16).slice(2),
          date,
          distance: dist,
          time: timeStr,
          location,
          notes
        };

        ath.entries.push(entry);
        savedCount++;

        if(beforePB == null || ms < beforePB){
          const diff = beforePB == null ? null : (beforePB - ms);
          const msg = diff == null
            ? `First PB for ${dist}: ${msToTime(ms)}`
            : `${dist} improved by ${(diff/1000).toFixed(3)}s ‚Üí ${msToTime(ms)}`;
          pbMessages.push(msg);
        }
      }

      saveState();
      closeModal("modalEntry");

      if(pbMessages.length){
        flashBanner(`üéâ ${ath.name}: ${pbMessages[0]}${pbMessages.length>1 ? ` (+${pbMessages.length-1} more)` : ""}`, true);
      }else{
        flashBanner(`${savedCount} race entr${savedCount===1?"y":"ies"} saved for ${ath.name}.`, false);
      }

      renderAll();
    }

    function doResetAll(){
      clearErrors();
      const txt = document.getElementById("resetConfirm").value.trim();
      if(txt !== "RESET"){
        showError("resetErr","Please type RESET exactly to confirm.");
        return;
      }
      localStorage.removeItem(LS_KEY);
      state = structuredClone(defaultState);
      closeModal("modalReset");
      flashBanner("All data cleared on this device.", false);
      renderAll();
    }

    function renderAll(){
      renderAthleteSelect();
      renderHome();
      renderAnalytics();
      renderExport();
    }

    function renderAthleteSelect(){
      athleteSelect.innerHTML = "";

      if(state.athletes.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No athletes yet";
        athleteSelect.appendChild(opt);
        state.activeAthleteId = null;
        saveState();
        return;
      }

      if(!state.activeAthleteId || !state.athletes.some(a => a.id === state.activeAthleteId)){
        state.activeAthleteId = state.athletes[0].id;
        saveState();
      }

      for(const a of state.athletes){
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = a.name + (a.birthYear ? ` (${a.birthYear})` : "");
        athleteSelect.appendChild(opt);
      }
      athleteSelect.value = state.activeAthleteId;
    }

    function renderHome(){
      const ath = getActiveAthlete();
      const dist = distanceFilter.value;

      if(!ath){
        pillAthlete.textContent = "No athlete selected";
        pillCount.textContent = "0 races";
        pillPBCount.textContent = "0 PBs";

        kpiPB.textContent = "‚Äî";
        kpiPBDistance.textContent = "Pick a distance";
        kpiLatest.textContent = "‚Äî";
        kpiLatestMeta.textContent = "‚Äî";
        kpiAvg10.textContent = "‚Äî";
        kpiCons.textContent = "‚Äî";

        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No athlete selected</strong>
            <p>Add an athlete and start entering races to see PBs here.</p>
          </div>
        `;

        recentWrap.innerHTML = `
          <div class="empty">
            <strong>Add your first athlete</strong>
            <p>Click <b>Add Athlete</b>, then add race entries to track PBs, trends, and progress.</p>
          </div>
        `;

        drawChart([], dist);
        return;
      }

      pillAthlete.textContent = ath.name + (ath.birthYear ? ` ‚Ä¢ ${ath.birthYear}` : "");
      const entriesAll = sortByDateDesc(ath.entries || []);
      pillCount.textContent = `${entriesAll.length} races`;

      const pbMap = computePBMap(entriesAll);
      const pbCount = Object.keys(pbMap).length;
      pillPBCount.textContent = `${pbCount} PBs`;

      // PB Summary (NEW on home)
      if(pbCount === 0){
        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No PBs yet</strong>
            <p>Add race entries and PBs will appear here automatically for each distance.</p>
          </div>
        `;
      }else{
        const distances = Object.keys(pbMap).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
        pbSummaryWrap.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Distance</th>
                <th>PB</th>
                <th>Date</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody>
              ${distances.map(d=>{
                const pb = pbMap[d];
                return `
                  <tr>
                    <td><span class="badge">${d}</span></td>
                    <td><b>${msToTime(pb.ms)}</b></td>
                    <td>${fmtDate(pb.date)}</td>
                    <td style="color:rgba(255,255,255,.75)">${escapeHtml(pb.location || "‚Äî")}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;
      }

      const entries = dist === "ALL" ? entriesAll : entriesAll.filter(e => e.distance === dist);

      const latest = entries[0] || null;
      if(latest){
        kpiLatest.textContent = latest.time;
        kpiLatestMeta.textContent = `${latest.distance} ‚Ä¢ ${latest.location || "‚Äî"} ‚Ä¢ ${fmtDate(latest.date)}`;
      }else{
        kpiLatest.textContent = "‚Äî";
        kpiLatestMeta.textContent = dist === "ALL" ? "No entries yet" : `No entries for ${dist}`;
      }

      if(dist !== "ALL"){
        const pb = pbMap[dist] ? pbMap[dist].ms : null;
        kpiPB.textContent = pb != null ? msToTime(pb) : "‚Äî";
        kpiPBDistance.textContent = pb != null ? `${dist} best` : `No PB for ${dist}`;
      }else{
        const allPBs = Object.values(pbMap).map(x => x.ms);
        const best = allPBs.length ? Math.min(...allPBs) : null;
        kpiPB.textContent = best != null ? msToTime(best) : "‚Äî";
        kpiPBDistance.textContent = best != null ? "Fastest PB (any distance)" : "No PBs yet";
      }

      const last10 = entries.slice(0,10).map(e => parseTimeToMs(e.time)).filter(x => x!=null);
      const avg10 = last10.length ? mean(last10) : null;
      const sd10 = last10.length ? stddev(last10) : null;
      kpiAvg10.textContent = avg10 != null ? msToTime(Math.round(avg10)) : "‚Äî";
      kpiCons.textContent = sd10 != null ? (sd10/1000).toFixed(3) + "s" : "‚Äî";

      if(entriesAll.length === 0){
        recentWrap.innerHTML = `
          <div class="empty">
            <strong>No races yet</strong>
            <p>Add race entries to start tracking improvements and PBs.</p>
          </div>
        `;
      }else{
        const rows = entriesAll.slice(0,12).map(e => {
          const ms = parseTimeToMs(e.time);
          const isPB = pbMap[e.distance] && ms != null && ms === pbMap[e.distance].ms;
          const badge = isPB
            ? `<span class="badge badgePB">üèÖ PB</span>`
            : `<span class="badge badgeOK">Saved</span>`;
          return `
            <tr>
              <td>${fmtDate(e.date)}</td>
              <td>${escapeHtml(e.location || "‚Äî")}</td>
              <td>${e.distance}</td>
              <td><b>${e.time}</b></td>
              <td>${badge}</td>
              <td style="color:rgba(255,255,255,.70)">${e.notes ? escapeHtml(e.notes) : "‚Äî"}</td>
            </tr>
          `;
        }).join("");

        recentWrap.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Location</th>
                <th>Distance</th>
                <th>Time</th>
                <th>Status</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      drawChart(entries, dist);
    }

    function renderAnalytics(){
      const ath = getActiveAthlete();
      const dist = distanceFilter.value;

      if(!ath){
        pillAnalytics.textContent = "No athlete";
        anBest90.textContent = "‚Äî";
        anBest90Meta.textContent = "‚Äî";
        anImp5.textContent = "‚Äî";
        anPBCount.textContent = "‚Äî";
        anTotal.textContent = "‚Äî";
        pbTableBody.innerHTML = `<tr><td colspan="5">No athlete selected.</td></tr>`;
        return;
      }

      const entriesAll = ath.entries || [];
      pillAnalytics.textContent = ath.name + (dist !== "ALL" ? ` ‚Ä¢ Focus: ${dist}` : "");

      anTotal.textContent = String(entriesAll.length);

      const pbMap = computePBMap(entriesAll);
      anPBCount.textContent = String(Object.keys(pbMap).length);

      const now = new Date();
      const cutoff = new Date(now.getTime() - 90*24*3600*1000);
      const scoped = entriesAll
        .filter(e => dist === "ALL" ? true : e.distance === dist)
        .filter(e => new Date(e.date) >= cutoff);

      const scopedMs = scoped.map(e => parseTimeToMs(e.time)).filter(x=>x!=null);
      if(scopedMs.length){
        const best = Math.min(...scopedMs);
        anBest90.textContent = msToTime(best);
        anBest90Meta.textContent = dist === "ALL" ? "Any distance ‚Ä¢ last 90 days" : `${dist} ‚Ä¢ last 90 days`;
      }else{
        anBest90.textContent = "‚Äî";
        anBest90Meta.textContent = "No entries in last 90 days";
      }

      const focusEntries = sortByDateDesc(entriesAll).filter(e => dist==="ALL" ? true : e.distance===dist);
      const last5 = focusEntries.slice(0,5).map(e=>parseTimeToMs(e.time)).filter(x=>x!=null);
      if(last5.length >= 2){
        const imp = last5[last5.length-1] - last5[0];
        const improved = imp > 0;
        const val = (Math.abs(imp)/1000).toFixed(3) + "s";
        anImp5.textContent = improved ? ("‚Üì " + val) : ("‚Üë " + val);
      }else{
        anImp5.textContent = "‚Äî";
      }

      const distances = Object.keys(pbMap).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
      if(!distances.length){
        pbTableBody.innerHTML = `<tr><td colspan="5">No PBs yet. Add race entries.</td></tr>`;
      }else{
        pbTableBody.innerHTML = distances.map(d=>{
          const pb = pbMap[d];
          return `
            <tr>
              <td><span class="badge">${d}</span></td>
              <td><b>${msToTime(pb.ms)}</b></td>
              <td>${fmtDate(pb.date)}</td>
              <td>${escapeHtml(pb.location || "‚Äî")}</td>
              <td style="color:rgba(255,255,255,.72)">${pb.notes ? escapeHtml(pb.notes) : "‚Äî"}</td>
            </tr>
          `;
        }).join("");
      }
    }

    function renderExport(){
      const ath = getActiveAthlete();
      pillExport.textContent = ath ? `Selected: ${ath.name}` : "No athlete";
    }

    function drawChart(entries, dist){
      const data = [...entries]
        .filter(e => parseTimeToMs(e.time)!=null)
        .sort((a,b)=> new Date(a.date)-new Date(b.date));

      const points = data.map(e => ({
        x: new Date(e.date).getTime(),
        y: parseTimeToMs(e.time)
      }));

      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(points.length < 2){
        ctx.fillStyle = "rgba(255,255,255,.65)";
        ctx.font = "700 26px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
        ctx.fillText("Add race entries to see trend", 50, 210);
        ctx.fillStyle = "rgba(255,255,255,.45)";
        ctx.font = "600 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
        ctx.fillText(dist === "ALL" ? "Tip: choose a distance for a cleaner line." : `Distance: ${dist}`, 50, 245);
        return;
      }

      const padL = 70, padR=30, padT=28, padB=56;
      const W = canvas.width - padL - padR;
      const H = canvas.height - padT - padB;

      const xs = points.map(p=>p.x);
      const ys = points.map(p=>p.y);

      const minX = Math.min(...xs);
      const maxX = Math.max(...xs);

      let minY = Math.min(...ys);
      let maxY = Math.max(...ys);

      const padY = Math.max(120, (maxY-minY)*0.12);
      minY = minY - padY;
      maxY = maxY + padY;

      ctx.strokeStyle = "rgba(255,255,255,.08)";
      ctx.lineWidth = 1;

      const gridCount = 5;
      for(let i=0;i<=gridCount;i++){
        const y = padT + (H/gridCount)*i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL+W, y);
        ctx.stroke();
      }

      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "800 15px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
      for(let i=0;i<=gridCount;i++){
        const y = padT + (H/gridCount)*i;
        const val = maxY - ( (maxY-minY)/gridCount )*i;
        ctx.fillText(msToTime(Math.round(val)), 14, y+5);
      }

      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "800 15px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
      ctx.fillText(fmtDate(new Date(minX).toISOString().slice(0,10)), padL, canvas.height-18);
      const endLabel = fmtDate(new Date(maxX).toISOString().slice(0,10));
      const endWidth = ctx.measureText(endLabel).width;
      ctx.fillText(endLabel, padL+W-endWidth, canvas.height-18);

      const toX = (x)=> padL + ((x-minX)/(maxX-minX))*W;
      const toY = (y)=> padT + ((maxY-y)/(maxY-minY))*H;

      const grad = ctx.createLinearGradient(padL,0,padL+W,0);
      grad.addColorStop(0, "rgba(124,92,255,.92)");
      grad.addColorStop(1, "rgba(74,217,255,.92)");

      ctx.strokeStyle = grad;
      ctx.lineWidth = 4;
      ctx.beginPath();
      points.forEach((p,idx)=>{
        const x = toX(p.x);
        const y = toY(p.y);
        if(idx===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      points.forEach((p)=>{
        const x = toX(p.x);
        const y = toY(p.y);
        ctx.fillStyle = "rgba(255,255,255,.95)";
        ctx.beginPath();
        ctx.arc(x,y,5,0,Math.PI*2);
        ctx.fill();
      });

      /* UPDATED: removed "Trend Line" title drawn on canvas */
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify({ state, prefs }, null, 2)], { type:"application/json" });
      downloadBlob(blob, "PB-VelocityBoard-backup.json");
      flashBanner("JSON backup downloaded.", false);
    }

    function exportCSV(){
      const ath = getActiveAthlete();
      if(!ath){
        flashBanner("No athlete selected.", false);
        return;
      }
      const rows = [["Athlete","BirthYear","Date","Location","Distance","Time","Notes"]];
      for(const e of sortByDateDesc(ath.entries || [])){
        rows.push([ath.name, ath.birthYear || "", e.date, e.location || "", e.distance, e.time, (e.notes||"")]);
      }
      const csv = rows.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type:"text/csv" });
      downloadBlob(blob, `PB-${ath.name.replaceAll(" ","_")}.csv`);
      flashBanner("CSV downloaded.", false);
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSON(){
      clearErrors();
      const file = importFile.files && importFile.files[0];
      if(!file){
        showError("importMsg","Please choose a JSON file first.");
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const parsed = JSON.parse(reader.result);
          if(!parsed.state || !Array.isArray(parsed.state.athletes)){
            showError("importMsg","Invalid backup structure (missing state.athletes).");
            return;
          }

          const incoming = parsed.state.athletes;
          for(const inc of incoming){
            if(!inc.id || !inc.name) continue;
            const existing = state.athletes.find(a => a.id === inc.id);
            if(existing){
              const existingIds = new Set((existing.entries||[]).map(e=>e.id));
              (inc.entries||[]).forEach(e=>{
                if(e && e.id && !existingIds.has(e.id)) existing.entries.push(e);
              });
              if(!existing.birthYear && inc.birthYear) existing.birthYear = inc.birthYear;
              if(existing.name !== inc.name) existing.name = inc.name;
            }else{
              state.athletes.push(inc);
            }
          }

          if(parsed.prefs){
            prefs = { ...prefs, ...parsed.prefs };
            savePrefs();
            defaultDistance.value = prefs.defaultDistance;
            timeHint.value = prefs.timeHint;
            distanceFilter.value = prefs.defaultDistance;
          }

          if(!state.activeAthleteId && state.athletes.length){
            state.activeAthleteId = state.athletes[0].id;
          }
          saveState();

          importMsg.classList.remove("show");
          flashBanner("Import complete. Data merged.", false);
          renderAll();

        }catch(e){
          showError("importMsg","Could not read JSON. Please upload a valid backup file.");
        }
      };
      reader.readAsText(file);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>

</body>
</html>
