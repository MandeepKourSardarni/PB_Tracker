<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PB VelocityBoard</title>

  <style>
    :root{
      --bg1:#07162f;
      --bg2:#041022;
      --accent:#2f6bff;
      --accent2:#2bb7ff;

      --text:#0f1526;             /* unified text color */
      --muted:rgba(15,21,38,.62);
      --muted2:rgba(15,21,38,.46);

      --danger:#e23b57;
      --ok:#18a965;
      --warn:#c88b00;

      --radius: 22px;
      --shadow: 0 18px 60px rgba(0,0,0,.18);
      --shadow2: 0 10px 26px rgba(0,0,0,.14);

      --w: 1180px;
      --gap: 14px;
      --appbarH: 84px; /* JS overrides */

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 12% 8%, rgba(47,107,255,.22), transparent 60%),
        radial-gradient(1000px 700px at 86% 18%, rgba(43,183,255,.16), transparent 58%),
        radial-gradient(900px 650px at 38% 92%, rgba(11,42,111,.32), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    button, input, select{ font-family:inherit; }

    .wrap{
      max-width: var(--w);
      margin: 0 auto;
      padding: calc(var(--appbarH) + 18px) 18px 26px;
    }

    /* ========= APP BAR ========= */
    .appbar{
      position:fixed;
      top:0; left:0; right:0;
      z-index:50;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(255,255,255,.80);
      border-bottom:1px solid rgba(15,21,38,.10);
    }
    .appbarInner{
      max-width: var(--w);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 18px;
      flex-wrap: wrap; /* phones */
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 220px;
      flex: 1 1 auto;
    }
    .logo{
      width: 38px; height: 38px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.40), transparent 55%),
        linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 30px rgba(47,107,255,.20);
      flex: 0 0 auto;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.12;
      min-width: 160px;
    }
    .brandText strong{ font-size: 15.5px; letter-spacing:.2px; }
    .brandText span{ font-size: 12px; color: var(--muted); }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 6px;
      border:1px solid rgba(15,21,38,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      flex: 0 0 auto;

      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tabBtn{
      border:0;
      padding: 9px 14px;
      border-radius: 999px;
      background: transparent;
      color: rgba(15,21,38,.62);
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      transition: .18s ease;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tabBtn:hover{ color: var(--text); background: rgba(15,21,38,.05); }
    .tabBtn.active{
      color: var(--text);
      background: rgba(47,107,255,.10);
      border: 1px solid rgba(47,107,255,.18);
    }

    .rightTools{
      display:flex;
      align-items:center;
      gap: 8px;
      justify-content:flex-end;
      flex-wrap: wrap;
      flex: 1 1 520px;
    }

    .selectWrap{ position:relative; flex: 1 1 220px; min-width: 220px; }
    .selectWrap:after{
      content:"‚ñæ";
      position:absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-52%);
      color: var(--muted);
      pointer-events:none;
      font-size: 12px;
    }

    .select{
      width:100%;
      appearance:none;
      -webkit-appearance:none;
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      padding: 10px 34px 10px 12px;
      border-radius: 14px;
      font-weight:900;
      outline:none;
      cursor:pointer;
    }

    select, option{
      color: var(--text);
      background-color: #ffffff;
    }

    .btn{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.86);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      transition: .18s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      box-shadow: none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.96); }

    .btnPrimary{
      border: none;
      background: linear-gradient(135deg, rgba(47,107,255,.98), rgba(43,183,255,.92));
      color: white;
      box-shadow: 0 14px 34px rgba(47,107,255,.18);
    }
    .btnDanger{
      border: 1px solid rgba(226,59,87,.22);
      background: rgba(226,59,87,.10);
    }

    /* ========= GLASS CARDS ========= */
    .card{
      border: 1px solid rgba(255,255,255,.16);
      background:
        linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.68));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    .title{ font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .sub{ color: var(--muted); font-size: 13px; margin-top: 3px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,21,38,.12);
      background: rgba(15,21,38,.04);
      color: rgba(15,21,38,.70);
      font-size: 12px;
      font-weight:900;
      white-space:nowrap;
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr; /* PB + Distance Focus */
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      border:1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.86);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .label{ color: var(--muted); font-size: 12px; font-weight:900; }
    .kpi .value{ margin-top: 6px; font-size: 18px; font-weight: 900; letter-spacing:.3px; }
    .kpi .mini{ margin-top: 4px; color: var(--muted2); font-size: 12px; }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing:.2px;
    }
    .input, .select2{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight: 900;
    }
    .input:focus, .select:focus, .select2:focus{
      outline:none;
      border-color: rgba(47,107,255,.35);
      box-shadow: 0 0 0 4px rgba(47,107,255,.12);
    }
    .help{ font-size: 12px; color: var(--muted2); line-height:1.35; }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.88);
    }
    .table th, .table td{
      padding: 10px 10px;
      font-size: 13px;
      border-bottom:1px solid rgba(15,21,38,.06);
      text-align:left;
      vertical-align:top;
      color: var(--text);
    }
    .table th{
      color: rgba(15,21,38,.65);
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.3px;
      background: rgba(15,21,38,.03);
    }
    .table tr:hover td{ background: rgba(47,107,255,.04); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      white-space:nowrap;
      color: rgba(15,21,38,.78);
    }
    .badgeOK{ border-color: rgba(24,169,101,.22); background: rgba(24,169,101,.10); }
    .badgePB{ border-color: rgba(200,139,0,.22); background: rgba(200,139,0,.10); }

    .iconBtn{
      border:1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      color: var(--text);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:.18s ease;
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(15,21,38,.06); }
    .iconBtnDanger{
      background: rgba(226,59,87,.10);
      border: 1px solid rgba(226,59,87,.22);
    }

    .chart{
      width:100%;
      height: 260px;
      border-radius: 16px;
      border:1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.86);
      overflow:hidden;
      margin-top: 12px;
      position:relative;
    }
    .chart canvas{ width:100%; height:100%; display:block; }
    .chartHint{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 10px;
      font-size: 13px;
      color: rgba(15,21,38,.70);
      font-weight: 900;
      letter-spacing:.2px;
      text-align:center;
      white-space:nowrap;
      pointer-events:none;
    }

    .empty{
      border:1px dashed rgba(15,21,38,.18);
      border-radius: 18px;
      padding: 18px;
      color: var(--muted);
      background: rgba(255,255,255,.72);
      margin-top: 10px;
    }
    .empty strong{ color: var(--text); }
    .empty p{ margin: 8px 0 0; font-size: 13px; line-height:1.45; }

    .banner{
      display:none;
      margin: 0 0 14px;
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(47,107,255,.18);
      background: rgba(255,255,255,.80);
      box-shadow: 0 18px 50px rgba(0,0,0,.10);
      color: var(--text);
    }
    .banner.show{ display:block; }
    .banner strong{ font-weight: 900; }
    .banner .small{ color: var(--muted); font-size: 12px; margin-top: 3px; }

    /* ========= UNO-STYLE DISTANCE CARDS ========= */
    .handWrap{
      margin-top: 12px;
      padding: 6px 2px 12px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-snap-type: x mandatory;
      display:flex;
      gap: 12px;
      align-items: stretch;
    }
    .handWrap::-webkit-scrollbar{ display:none; }

    .distCard{
      flex: 0 0 min(360px, 86vw);
      scroll-snap-align: start;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.70));
      box-shadow: var(--shadow2);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .distTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .distTitle{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .distTitle .big{
      font-weight: 950;
      font-size: 16px;
      line-height: 1.1;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .distTitle .small{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }

    .distStats{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 4px;
      flex: 0 0 auto;
    }
    .distStats .pb{
      font-weight: 950;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(47,107,255,.08);
      border: 1px solid rgba(47,107,255,.16);
      white-space:nowrap;
    }
    .distStats .count{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }

    .distList{
      border-radius: 14px;
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.88);
      padding: 8px;
      overflow-y: auto;
      max-height: 320px; /* vertical scroll inside card */
      -webkit-overflow-scrolling: touch;
    }

    .entryItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,21,38,.08);
      background: rgba(255,255,255,.92);
      margin-bottom: 8px;
    }
    .entryItem:last-child{ margin-bottom: 0; }

    .entryMain{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .entryMain .line1{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .entryMain .time{
      font-weight: 950;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,21,38,.04);
      border: 1px solid rgba(15,21,38,.08);
      white-space:nowrap;
    }
    .entryMain .meta{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }
    .entryMain .notes{
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 280px;
    }

    .entryActions{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:flex-end;
      justify-content:flex-start;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* ========= MODALS ========= */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 100;
      align-items:center;
      justify-content:center;
      padding: 20px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      max-height: calc(100vh - 70px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 20px;
      border: 1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      background: rgba(255,255,255,.92);
      padding-bottom: 10px;
      z-index: 2;
    }
    .modalTop h3{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      color: var(--text);
    }
    .modalTop p{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }
    .xbtn{
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(15,21,38,.04);
      color: var(--text);
      border-radius: 12px;
      width: 38px; height: 38px;
      cursor:pointer;
      font-weight: 900;
      flex: 0 0 auto;
    }

    .error{
      display:none;
      color: #7d1424;
      background: rgba(226,59,87,.12);
      border: 1px solid rgba(226,59,87,.25);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      margin-top: 10px;
    }
    .error.show{ display:block; }

    .modalActions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 12px;
      flex-wrap:wrap;
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.92);
      padding-top: 10px;
      z-index: 2;
    }

    .entryRows{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 8px;
    }
    .entryRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items:end;
      border: 1px solid rgba(15,21,38,.10);
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding: 10px;
    }
    .miniBtn{
      border:1px solid rgba(15,21,38,.12);
      background: rgba(255,255,255,.88);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      transition:.18s ease;
      white-space:nowrap;
    }
    .miniBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.96); }
    .miniBtnDanger{
      border:1px solid rgba(226,59,87,.22);
      background: rgba(226,59,87,.10);
    }

    .foot{
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12px;
      line-height:1.45;
    }

    @media (max-width: 560px){
      .brandText span{ display:none; }
      .rightTools{ justify-content:flex-start; }
      .selectWrap{ flex: 1 1 100%; min-width: 100%; }
      .btn{ flex: 1 1 auto; justify-content:center; }
      .entryRow{ grid-template-columns: 1fr; }
      .modal{ max-height: calc(100vh - 40px); }
      .chartHint{ white-space:normal; width: 90%; text-align:center; }
      .distList{ max-height: 52vh; }
    }

    @media (min-width: 561px){
      .appbarInner{ flex-wrap: nowrap; padding: 10px 18px; }
      .tabs{ padding: 4px; gap: 6px; }
      .tabBtn{ padding: 8px 12px; font-size: 13px; }
      .rightTools{ flex-wrap: nowrap; gap: 8px; }
      .btn{ padding: 9px 11px; border-radius: 13px; }
      .select{ padding: 9px 34px 9px 12px; border-radius: 13px; }
    }
  </style>
</head>

<body>
  <div class="appbar">
    <div class="appbarInner">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandText">
          <strong>PB VelocityBoard</strong>
          <span>Track ‚Ä¢ Improve ‚Ä¢ Celebrate</span>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="PB VelocityBoard Tabs">
        <button class="tabBtn active" data-tab="home">Home</button>
        <button class="tabBtn" data-tab="analytics">Analytics</button>
        <button class="tabBtn" data-tab="export">Export</button>
        <button class="tabBtn" data-tab="settings">Settings</button>
      </div>

      <div class="rightTools">
        <div class="selectWrap">
          <select id="athleteSelect" class="select" title="Select Athlete"></select>
        </div>
        <button class="btn" id="btnEditAthlete">Edit</button>
        <button class="btn btnPrimary" id="btnAddAthlete">+ Add Athlete</button>
        <button class="btn" id="btnAddEntry">+ Add Race</button>
        <button class="btn btnDanger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="pbBanner" class="banner">
      <strong>üéâ New PB!</strong>
      <div class="small" id="pbBannerText">Saved.</div>
    </div>

    <!-- HOME -->
    <section id="screenHome" class="screen active">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Quick View</div>
            <div class="sub">PB + distance view, and your ‚ÄúUNO-hand‚Äù race cards.</div>
          </div>
          <div class="pill" id="pillAthlete">No athlete selected</div>
        </div>

        <!-- PB + Distance Focus side by side -->
        <div class="kpis">
          <div class="kpi">
            <div class="label">PB (Selected Distance)</div>
            <div class="value" id="kpiPB">‚Äî</div>
            <div class="mini" id="kpiPBDistance">Pick a distance</div>
          </div>

          <div class="kpi">
            <div class="label">Distance Focus</div>
            <select id="distanceFilter" class="select2">
              <option value="ALL">All distances</option>
              <option value="111m">111m</option>
              <option value="222m">222m</option>
              <option value="333m">333m</option>
              <option value="400m">400m</option>
              <option value="500m">500m</option>
              <option value="800m">800m</option>
              <option value="1000m">1000m</option>
              <option value="1500m">1500m</option>
            </select>
            <div class="mini" id="pillCount" style="margin-top:6px; color:var(--muted); font-weight:900;">0 races</div>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="cardHeader" style="margin-top:6px;">
          <div>
            <div class="title" style="font-size:16px;">PB Summary</div>
            <div class="sub">Best time for each distance.</div>
          </div>
          <div class="pill" id="pillPBCount">0 PBs</div>
        </div>
        <div id="pbSummaryWrap"></div>

        <div style="height:12px;"></div>

        <div class="cardHeader">
          <div>
            <div class="title" style="font-size:16px;">Race Cards (by distance)</div>
            <div class="sub">Scroll left/right like UNO cards. Each card scrolls up/down for entries (latest on top).</div>
          </div>
        </div>

        <div id="cardsWrap" class="handWrap"></div>

        <div class="foot">Tip: Everything is saved on this device (local storage). Export JSON for backup.</div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="screenAnalytics" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Performance Snapshot</div>
            <div class="sub">Trend (Time vs Race Date) for the selected athlete and distance focus.</div>
          </div>
          <div class="pill" id="pillAnalytics">‚Äî</div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">PB (Selected Distance)</div>
            <div class="value" id="anPB">‚Äî</div>
            <div class="mini" id="anPBMeta">‚Äî</div>
          </div>

          <div class="kpi">
            <div class="label">Distance Focus</div>
            <select id="analyticsDistance" class="select2"></select>
            <div class="mini" id="anCount" style="margin-top:6px; color:var(--muted); font-weight:900;">‚Äî</div>
          </div>
        </div>

        <div class="chart">
          <div class="chartHint">Trend (Time vs Race Date)</div>
          <canvas id="trendCanvas" width="1200" height="420"></canvas>
        </div>

        <div class="foot">Use this chart to see progress over time. Filter by distance for a clean line.</div>
      </div>
    </section>

    <!-- EXPORT -->
    <section id="screenExport" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Export / Backup</div>
            <div class="sub">Download your data so you can move devices or share with a coach.</div>
          </div>
          <div class="pill" id="pillExport">‚Äî</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btnPrimary" id="btnExportJSON">Download JSON</button>
          <button class="btn" id="btnExportCSV">Download CSV (selected athlete)</button>
          <button class="btn" id="btnDownloadTemplate">‚¨áÔ∏è Download CSV Template</button>
        </div>

        <div class="empty" style="margin-top:12px;">
          <strong>CSV Import</strong>
          <p>Fill the template and upload it here to quickly add rows to the selected athlete.</p>
          <div class="field" style="margin-top:10px;">
            <label>Upload CSV</label>
            <input class="input" id="csvFile" type="file" accept=".csv" />
          </div>
          <div style="margin-top:10px;">
            <button class="btn btnPrimary" id="btnImportCSV">Import CSV into selected athlete</button>
          </div>
          <div id="importMsg" class="error"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="screenSettings" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="title">Settings</div>
            <div class="sub">Simple preferences.</div>
          </div>
          <div class="pill">Local Storage</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;" class="formGrid">
          <div class="field">
            <label>Default Distance Focus</label>
            <select id="defaultDistance" class="select2">
              <option value="ALL">All distances</option>
              <option value="111m">111m</option>
              <option value="222m">222m</option>
              <option value="333m">333m</option>
              <option value="400m">400m</option>
              <option value="500m">500m</option>
              <option value="800m">800m</option>
              <option value="1000m">1000m</option>
              <option value="1500m">1500m</option>
            </select>
          </div>

          <div class="field">
            <label>Time placeholder</label>
            <input id="timeHint" class="input" value="00:52.300" />
          </div>
        </div>

        <div class="empty" style="margin-top:12px;">
          <strong>Storage note</strong>
          <p>All data is stored on this device. To start fresh: Reset. To move devices: Export JSON.</p>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL: ADD ATHLETE -->
  <div class="modalOverlay" id="modalAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Athlete</h3>
          <p>Create an athlete profile. You can add races after that.</p>
        </div>
        <button class="xbtn" data-close="modalAthlete">‚úï</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" class="modalGrid">
        <div class="field">
          <label>Name</label>
          <input id="athName" class="input" placeholder="e.g., Samarveer" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="athYear" class="input" inputmode="numeric" placeholder="e.g., 2020" />
        </div>
      </div>

      <div id="athleteErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthlete">Save Athlete</button>
      </div>
    </div>
  </div>

  <!-- MODAL: EDIT ATHLETE -->
  <div class="modalOverlay" id="modalEditAthlete">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Edit Athlete</h3>
          <p>Update athlete name (and birth year). Entries stay the same.</p>
        </div>
        <button class="xbtn" data-close="modalEditAthlete">‚úï</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" class="modalGrid">
        <div class="field">
          <label>Name</label>
          <input id="editAthName" class="input" />
        </div>
        <div class="field">
          <label>Birth Year (optional)</label>
          <input id="editAthYear" class="input" inputmode="numeric" />
        </div>
      </div>

      <div id="editAthErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEditAthlete">Cancel</button>
        <button class="btn btnPrimary" id="saveAthleteEdits">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ADD ENTRY -->
  <div class="modalOverlay" id="modalEntry">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Add Race Entry</h3>
          <p>Same date + location can include multiple distances (400/500/800/1000 etc.).</p>
        </div>
        <button class="xbtn" data-close="modalEntry">‚úï</button>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" class="modalGrid">
        <div class="field">
          <label>Date</label>
          <input id="enDate" class="input" type="date" />
        </div>

        <div class="field">
          <label>Location</label>
          <input id="enLocation" class="input" placeholder="e.g., Scarborough" />
        </div>

        <div class="field" style="grid-column:1 / -1;">
          <label>Notes (optional)</label>
          <input id="enNotes" class="input" placeholder="e.g., Meet name, lane, fall, etc." />
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>Distances & Times</label>
        <div class="entryRows" id="entryRows"></div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="miniBtn" id="btnAddRow">+ Add another distance</button>
        </div>
      </div>

      <div id="entryErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalEntry">Cancel</button>
        <button class="btn btnPrimary" id="saveEntry">Save Entry</button>
      </div>
    </div>
  </div>

  <!-- MODAL: RESET -->
  <div class="modalOverlay" id="modalReset">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3>Reset</h3>
          <p>This removes your stored data on this device. Type <strong>RESET</strong> to confirm.</p>
        </div>
        <button class="xbtn" data-close="modalReset">‚úï</button>
      </div>

      <div class="field">
        <label>Type RESET</label>
        <input id="resetConfirm" class="input" placeholder="RESET" />
      </div>

      <div id="resetErr" class="error"></div>

      <div class="modalActions">
        <button class="btn" data-close="modalReset">Cancel</button>
        <button class="btn btnDanger" id="doReset">Reset Everything</button>
      </div>
    </div>
  </div>

  <script>
    const LS_KEY = "pb_velocityboard_v8_singlefile_cards";
    const LS_PREF = "pb_velocityboard_prefs_v8";

    const defaultState = { athletes: [], activeAthleteId: null };
    const defaultPrefs = { defaultDistance: "ALL", timeHint: "00:52.300" };

    let state = loadState();
    let prefs = loadPrefs();

    const tabBtns = [...document.querySelectorAll(".tabBtn")];
    const screens = {
      home: document.getElementById("screenHome"),
      analytics: document.getElementById("screenAnalytics"),
      export: document.getElementById("screenExport"),
      settings: document.getElementById("screenSettings")
    };

    const athleteSelect = document.getElementById("athleteSelect");
    const distanceFilter = document.getElementById("distanceFilter");
    const analyticsDistance = document.getElementById("analyticsDistance");

    const pbBanner = document.getElementById("pbBanner");
    const pbBannerText = document.getElementById("pbBannerText");

    const kpiPB = document.getElementById("kpiPB");
    const kpiPBDistance = document.getElementById("kpiPBDistance");
    const pillAthlete = document.getElementById("pillAthlete");
    const pillCount = document.getElementById("pillCount");
    const pillPBCount = document.getElementById("pillPBCount");
    const pbSummaryWrap = document.getElementById("pbSummaryWrap");
    const cardsWrap = document.getElementById("cardsWrap");

    const pillAnalytics = document.getElementById("pillAnalytics");
    const anPB = document.getElementById("anPB");
    const anPBMeta = document.getElementById("anPBMeta");
    const anCount = document.getElementById("anCount");

    const pillExport = document.getElementById("pillExport");
    const csvFile = document.getElementById("csvFile");
    const importMsg = document.getElementById("importMsg");

    const defaultDistance = document.getElementById("defaultDistance");
    const timeHint = document.getElementById("timeHint");

    const canvas = document.getElementById("trendCanvas");
    const ctx = canvas.getContext("2d");

    document.getElementById("btnAddAthlete").addEventListener("click", () => openModal("modalAthlete"));
    document.getElementById("btnEditAthlete").addEventListener("click", openEditAthlete);

    document.getElementById("btnAddEntry").addEventListener("click", () => {
      if(!getActiveAthlete()){
        flashBanner("Please add/select an athlete first.", false);
        openModal("modalAthlete");
        return;
      }
      openEntryModal();
    });

    document.getElementById("btnReset").addEventListener("click", () => openModal("modalReset"));

    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", () => closeModal(btn.getAttribute("data-close")));
    });
    document.querySelectorAll(".modalOverlay").forEach(ov => {
      ov.addEventListener("click", (e) => {
        if(e.target === ov) ov.classList.remove("show");
      });
    });

    document.getElementById("saveAthlete").addEventListener("click", saveAthlete);
    document.getElementById("saveAthleteEdits").addEventListener("click", saveAthleteEdits);
    document.getElementById("saveEntry").addEventListener("click", saveEntryMulti);
    document.getElementById("doReset").addEventListener("click", doResetAll);

    document.getElementById("btnExportJSON").addEventListener("click", exportJSON);
    document.getElementById("btnExportCSV").addEventListener("click", exportCSV);
    document.getElementById("btnDownloadTemplate").addEventListener("click", downloadTemplateCSV);
    document.getElementById("btnImportCSV").addEventListener("click", importCSVIntoSelectedAthlete);

    tabBtns.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

    athleteSelect.addEventListener("change", () => {
      state.activeAthleteId = athleteSelect.value || null;
      saveState();
      renderAll();
    });

    distanceFilter.addEventListener("change", () => {
      analyticsDistance.value = distanceFilter.value;
      renderAll();
    });

    analyticsDistance.addEventListener("change", () => {
      distanceFilter.value = analyticsDistance.value;
      renderAll();
    });

    defaultDistance.addEventListener("change", () => {
      prefs.defaultDistance = defaultDistance.value;
      savePrefs();
      distanceFilter.value = prefs.defaultDistance;
      analyticsDistance.value = prefs.defaultDistance;
      renderAll();
    });

    timeHint.addEventListener("input", () => {
      prefs.timeHint = timeHint.value.trim() || "00:52.300";
      savePrefs();
    });

    const entryRowsEl = document.getElementById("entryRows");
    document.getElementById("btnAddRow").addEventListener("click", () => addEntryRow());

    // Delete entry (delegation) for UNO cards
    cardsWrap.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-del-entry-id]");
      if(!btn) return;
      deleteEntry(btn.getAttribute("data-del-entry-id"));
    });

    // Keep page padding in sync with appbar height
    function syncAppbarHeight(){
      const appbar = document.querySelector(".appbar");
      if(!appbar) return;
      const h = appbar.offsetHeight || 84;
      document.documentElement.style.setProperty("--appbarH", h + "px");
    }
    window.addEventListener("resize", syncAppbarHeight);

    init();

    function init(){
      if(!state.athletes) state = structuredClone(defaultState);
      if(!prefs) prefs = structuredClone(defaultPrefs);

      defaultDistance.value = prefs.defaultDistance;
      timeHint.value = prefs.timeHint;
      distanceFilter.value = prefs.defaultDistance;

      // build analyticsDistance options from the same list
      analyticsDistance.innerHTML = distanceFilter.innerHTML;
      analyticsDistance.value = prefs.defaultDistance;

      renderAll();
      syncAppbarHeight();
    }

    function switchTab(tab){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
      Object.keys(screens).forEach(k => screens[k].classList.toggle("active", k === tab));
      renderAll();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openModal(id){
      clearErrors();
      document.getElementById(id).classList.add("show");
      document.body.style.overflow = "hidden";
      syncAppbarHeight();
    }
    function closeModal(id){
      document.getElementById(id).classList.remove("show");
      const anyOpen = [...document.querySelectorAll(".modalOverlay")].some(x => x.classList.contains("show"));
      if(!anyOpen) document.body.style.overflow = "";
      syncAppbarHeight();
    }

    function clearErrors(){
      ["athleteErr","entryErr","resetErr","importMsg","editAthErr"].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.classList.remove("show"); el.textContent=""; }
      });
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : structuredClone(defaultState);
      }catch(e){
        return structuredClone(defaultState);
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function loadPrefs(){
      try{
        const raw = localStorage.getItem(LS_PREF);
        return raw ? JSON.parse(raw) : structuredClone(defaultPrefs);
      }catch(e){
        return structuredClone(defaultPrefs);
      }
    }
    function savePrefs(){
      localStorage.setItem(LS_PREF, JSON.stringify(prefs));
    }

    function getActiveAthlete(){
      return state.athletes.find(a => a.id === state.activeAthleteId) || null;
    }
    function uid(){
      return "a_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function parseTimeToMs(t){
      if(!t) return null;
      t = (""+t).trim();
      if(/^\d+(\.\d{1,3})?$/.test(t)){
        const sec = Number(t);
        return Math.round(sec * 1000);
      }
      const m = t.match(/^(\d{1,2}):([0-5]\d)(?:\.(\d{1,3}))?$/);
      if(!m) return null;
      const mm = Number(m[1]);
      const ss = Number(m[2]);
      const ms = Number((m[3] || "0").padEnd(3,"0"));
      return (mm*60 + ss)*1000 + ms;
    }

    function msToTime(ms){
      if(ms == null || isNaN(ms)) return "‚Äî";
      const totalSec = Math.floor(ms/1000);
      const mm = Math.floor(totalSec/60);
      const ss = totalSec % 60;
      const msec = ms % 1000;
      return String(mm).padStart(2,"0")+":"+String(ss).padStart(2,"0")+"."+String(msec).padStart(3,"0");
    }

    function fmtDate(iso){
      if(!iso) return "‚Äî";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      }catch(e){ return iso; }
    }

    function sortByDateDesc(entries){
      return [...entries].sort((a,b)=> new Date(b.date) - new Date(a.date));
    }

    function mean(arr){
      if(!arr.length) return null;
      return arr.reduce((s,x)=>s+x,0)/arr.length;
    }

    function computePBMap(entries){
      const pb = {};
      for(const e of entries){
        const ms = parseTimeToMs(e.time);
        if(ms == null) continue;
        if(!pb[e.distance] || ms < pb[e.distance].ms){
          pb[e.distance] = { ...e, ms };
        }
      }
      return pb;
    }

    function showError(id, msg){
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add("show");
    }

    function flashBanner(msg, isPB){
      pbBannerText.textContent = msg;
      pbBanner.style.borderColor = isPB ? "rgba(200,139,0,.22)" : "rgba(47,107,255,.18)";
      pbBanner.style.background = "rgba(255,255,255,.80)";
      pbBanner.classList.add("show");
      clearTimeout(flashBanner._t);
      flashBanner._t = setTimeout(()=> pbBanner.classList.remove("show"), 4200);
    }

    function saveAthlete(){
      clearErrors();
      const name = document.getElementById("athName").value.trim();
      const year = document.getElementById("athYear").value.trim();

      if(!name){
        showError("athleteErr","Please enter a name.");
        return;
      }
      if(year && !/^\d{4}$/.test(year)){
        showError("athleteErr","Birth year should be 4 digits (e.g., 2014).");
        return;
      }

      const newAth = {
        id: uid(),
        name,
        birthYear: year || "",
        createdAt: new Date().toISOString(),
        entries: []
      };

      state.athletes.push(newAth);
      state.activeAthleteId = newAth.id;
      saveState();

      document.getElementById("athName").value = "";
      document.getElementById("athYear").value = "";
      closeModal("modalAthlete");

      flashBanner(`Athlete added: ${name}`, false);
      renderAll();
    }

    function openEditAthlete(){
      const ath = getActiveAthlete();
      if(!ath){
        flashBanner("No athlete selected.", false);
        return;
      }
      document.getElementById("editAthName").value = ath.name || "";
      document.getElementById("editAthYear").value = ath.birthYear || "";
      openModal("modalEditAthlete");
    }

    function saveAthleteEdits(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){
        showError("editAthErr","No athlete selected.");
        return;
      }

      const name = document.getElementById("editAthName").value.trim();
      const year = document.getElementById("editAthYear").value.trim();

      if(!name){
        showError("editAthErr","Please enter a name.");
        return;
      }
      if(year && !/^\d{4}$/.test(year)){
        showError("editAthErr","Birth year should be 4 digits (e.g., 2014).");
        return;
      }

      ath.name = name;
      ath.birthYear = year || "";
      saveState();
      closeModal("modalEditAthlete");

      flashBanner("Athlete updated.", false);
      renderAll();
    }

    function openEntryModal(){
      clearErrors();
      const dateEl = document.getElementById("enDate");
      dateEl.valueAsDate = new Date();

      document.getElementById("enLocation").value = "";
      document.getElementById("enNotes").value = "";

      entryRowsEl.innerHTML = "";
      addEntryRow("400m", "", true);
      openModal("modalEntry");
    }

    function addEntryRow(distance="500m", time="", isFirst=false){
      const row = document.createElement("div");
      row.className = "entryRow";

      row.innerHTML = `
        <div class="field">
          <label>Distance</label>
          <select class="select2 jsDist">
            <option value="111m">111m</option>
            <option value="222m">222m</option>
            <option value="333m">333m</option>
            <option value="400m">400m</option>
            <option value="500m">500m</option>
            <option value="800m">800m</option>
            <option value="1000m">1000m</option>
            <option value="1500m">1500m</option>
          </select>
        </div>

        <div class="field">
          <label>Time (mm:ss.mmm)</label>
          <input class="input jsTime" placeholder="${escapeHtml(prefs.timeHint || "00:52.300")}" value="${escapeHtml(time || "")}" />
        </div>

        <div style="display:flex; justify-content:flex-end;">
          <button class="miniBtn miniBtnDanger jsRemove" ${isFirst ? "disabled style='opacity:.45; cursor:not-allowed;'" : ""}>Remove</button>
        </div>
      `;

      entryRowsEl.appendChild(row);

      const distSel = row.querySelector(".jsDist");
      distSel.value = distance;

      const removeBtn = row.querySelector(".jsRemove");
      removeBtn.addEventListener("click", () => {
        if(removeBtn.disabled) return;
        row.remove();
      });
    }

    function saveEntryMulti(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){
        showError("entryErr","No athlete selected. Add/select an athlete first.");
        return;
      }

      const date = document.getElementById("enDate").value;
      const location = document.getElementById("enLocation").value.trim();
      const notes = document.getElementById("enNotes").value.trim();

      if(!date){
        showError("entryErr","Please select a date.");
        return;
      }
      if(!location){
        showError("entryErr","Please enter a location (e.g., Scarborough).");
        return;
      }

      const rows = [...entryRowsEl.querySelectorAll(".entryRow")];
      if(rows.length === 0){
        showError("entryErr","Please add at least one distance/time.");
        return;
      }

      const beforePBMap = computePBMap(ath.entries || []);
      let savedCount = 0;
      let pbMessages = [];

      for(const r of rows){
        const dist = r.querySelector(".jsDist").value;
        const timeStr = r.querySelector(".jsTime").value.trim();
        const ms = parseTimeToMs(timeStr);

        if(ms == null){
          showError("entryErr",`One or more times are invalid. Use mm:ss.mmm (example: ${prefs.timeHint}).`);
          return;
        }

        const beforePB = beforePBMap[dist]?.ms ?? null;

        const entry = {
          id: "e_" + Math.random().toString(16).slice(2) + Date.now().toString(16),
          date,
          distance: dist,
          time: timeStr,
          location,
          notes
        };

        ath.entries.push(entry);
        savedCount++;

        if(beforePB == null || ms < beforePB){
          const diff = beforePB == null ? null : (beforePB - ms);
          const msg = diff == null
            ? `First PB for ${dist}: ${msToTime(ms)}`
            : `${dist} improved by ${(diff/1000).toFixed(3)}s ‚Üí ${msToTime(ms)}`;
          pbMessages.push(msg);
        }
      }

      saveState();
      closeModal("modalEntry");

      if(pbMessages.length){
        flashBanner(`üéâ ${ath.name}: ${pbMessages[0]}${pbMessages.length>1 ? ` (+${pbMessages.length-1} more)` : ""}`, true);
      }else{
        flashBanner(`${savedCount} race entr${savedCount===1?"y":"ies"} saved for ${ath.name}.`, false);
      }

      renderAll();
    }

    function deleteEntry(entryId){
      const ath = getActiveAthlete();
      if(!ath) return;

      const entry = (ath.entries || []).find(e => e.id === entryId);
      if(!entry) return;

      const msg = `Delete this entry?\n\n${fmtDate(entry.date)} ‚Ä¢ ${entry.location || "‚Äî"} ‚Ä¢ ${entry.distance} ‚Ä¢ ${entry.time}`;
      if(!confirm(msg)) return;

      ath.entries = (ath.entries || []).filter(e => e.id !== entryId);
      saveState();
      flashBanner("Entry deleted.", false);
      renderAll();
    }

    function doResetAll(){
      clearErrors();
      const txt = document.getElementById("resetConfirm").value.trim();
      if(txt !== "RESET"){
        showError("resetErr","Please type RESET exactly to confirm.");
        return;
      }
      localStorage.removeItem(LS_KEY);
      state = structuredClone(defaultState);
      closeModal("modalReset");
      flashBanner("All data cleared on this device.", false);
      renderAll();
    }

    function renderAll(){
      renderAthleteSelect();
      renderHome();
      renderAnalytics();
      renderExport();
      syncAppbarHeight();
    }

    function renderAthleteSelect(){
      athleteSelect.innerHTML = "";

      if(state.athletes.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No athletes yet";
        athleteSelect.appendChild(opt);
        state.activeAthleteId = null;
        saveState();

        // also keep pills consistent
        pillAthlete.textContent = "No athlete selected";
        pillAnalytics.textContent = "No athlete";
        return;
      }

      if(!state.activeAthleteId || !state.athletes.some(a => a.id === state.activeAthleteId)){
        state.activeAthleteId = state.athletes[0].id;
        saveState();
      }

      for(const a of state.athletes){
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = a.name + (a.birthYear ? ` (${a.birthYear})` : "");
        athleteSelect.appendChild(opt);
      }
      athleteSelect.value = state.activeAthleteId;
    }

    function renderHome(){
      const ath = getActiveAthlete();
      const dist = distanceFilter.value;

      if(!ath){
        pillAthlete.textContent = "No athlete selected";
        pillCount.textContent = "0 races";
        pillPBCount.textContent = "0 PBs";
        kpiPB.textContent = "‚Äî";
        kpiPBDistance.textContent = "Pick a distance";
        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No athlete selected</strong>
            <p>Add an athlete and start entering races.</p>
          </div>
        `;
        cardsWrap.innerHTML = `
          <div class="empty" style="min-width: min(520px, 86vw);">
            <strong>No cards yet</strong>
            <p>Add races to see distance cards here.</p>
          </div>
        `;
        return;
      }

      pillAthlete.textContent = ath.name + (ath.birthYear ? ` ‚Ä¢ ${ath.birthYear}` : "");
      const entriesAll = sortByDateDesc(ath.entries || []);
      pillCount.textContent = `${entriesAll.length} races`;

      const pbMap = computePBMap(entriesAll);
      const pbCount = Object.keys(pbMap).length;
      pillPBCount.textContent = `${pbCount} PBs`;

      // PB KPI (selected distance)
      if(dist !== "ALL"){
        const pb = pbMap[dist] ? pbMap[dist].ms : null;
        kpiPB.textContent = pb != null ? msToTime(pb) : "‚Äî";
        kpiPBDistance.textContent = pb != null ? `${dist} best` : `No PB for ${dist}`;
      }else{
        const allPBs = Object.values(pbMap).map(x => x.ms);
        const best = allPBs.length ? Math.min(...allPBs) : null;
        kpiPB.textContent = best != null ? msToTime(best) : "‚Äî";
        kpiPBDistance.textContent = best != null ? "Fastest PB (any distance)" : "No PBs yet";
      }

      // PB Summary table
      if(pbCount === 0){
        pbSummaryWrap.innerHTML = `
          <div class="empty">
            <strong>No PBs yet</strong>
            <p>Add race entries and PBs will appear automatically for each distance.</p>
          </div>
        `;
      }else{
        const distances = Object.keys(pbMap).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
        pbSummaryWrap.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Distance</th>
                <th>PB</th>
                <th>Date</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody>
              ${distances.map(d=>{
                const pb = pbMap[d];
                return `
                  <tr>
                    <td><span class="badge">${d}</span></td>
                    <td><b>${msToTime(pb.ms)}</b></td>
                    <td>${fmtDate(pb.date)}</td>
                    <td>${escapeHtml((pb.location || "").trim() || "‚Äî")}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;
      }

      // Build UNO cards grouped by distance
      const scopedEntries = (dist === "ALL") ? entriesAll : entriesAll.filter(e => e.distance === dist);

      if(scopedEntries.length === 0){
        cardsWrap.innerHTML = `
          <div class="empty" style="min-width: min(520px, 86vw);">
            <strong>No entries</strong>
            <p>${dist === "ALL" ? "Add races to see cards by distance." : `No entries for ${dist}.`}</p>
          </div>
        `;
        return;
      }

      // group by distance
      const groups = {};
      for(const e of scopedEntries){
        const key = e.distance || "‚Äî";
        (groups[key] ||= []).push(e);
      }

      const groupKeys = Object.keys(groups).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));

      cardsWrap.innerHTML = groupKeys.map(dKey => {
        const list = sortByDateDesc(groups[dKey]);
        const pbForDist = pbMap[dKey]?.ms ?? null;
        const pbLabel = pbForDist != null ? `PB ${msToTime(pbForDist)}` : "No PB";
        const countLabel = `${list.length} entr${list.length===1?"y":"ies"}`;

        const itemsHtml = list.map(e=>{
          const ms = parseTimeToMs(e.time);
          const isPB = pbMap[e.distance] && ms != null && ms === pbMap[e.distance].ms;
          const badge = isPB
            ? `<span class="badge badgePB">üèÖ PB</span>`
            : `<span class="badge badgeOK">Saved</span>`;

          return `
            <div class="entryItem">
              <div class="entryMain">
                <div class="line1">
                  <span class="time">${escapeHtml(e.time)}</span>
                  ${badge}
                </div>
                <div class="meta">${fmtDate(e.date)} ‚Ä¢ ${escapeHtml((e.location||"").trim() || "‚Äî")}</div>
                <div class="notes">${e.notes ? escapeHtml(e.notes) : "‚Äî"}</div>
              </div>
              <div class="entryActions">
                <button class="iconBtn iconBtnDanger" title="Delete entry" data-del-entry-id="${e.id}">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join("");

        return `
          <div class="distCard">
            <div class="distTop">
              <div class="distTitle">
                <div class="big"><span class="badge">${escapeHtml(dKey)}</span> Entries</div>
                <div class="small">Latest first (by date)</div>
              </div>
              <div class="distStats">
                <div class="pb">${pbLabel}</div>
                <div class="count">${countLabel}</div>
              </div>
            </div>
            <div class="distList">
              ${itemsHtml}
            </div>
          </div>
        `;
      }).join("");
    }

    function renderAnalytics(){
      const ath = getActiveAthlete();
      const dist = analyticsDistance.value;

      if(!ath){
        pillAnalytics.textContent = "No athlete";
        anPB.textContent = "‚Äî";
        anPBMeta.textContent = "‚Äî";
        anCount.textContent = "‚Äî";
        drawChart([], dist);
        return;
      }

      pillAnalytics.textContent = ath.name + (ath.birthYear ? ` ‚Ä¢ ${ath.birthYear}` : "");

      const entriesAll = ath.entries || [];
      const pbMap = computePBMap(entriesAll);

      const scoped = (dist === "ALL") ? entriesAll : entriesAll.filter(e => e.distance === dist);
      anCount.textContent = `${scoped.length} races in view`;

      if(dist !== "ALL"){
        const pb = pbMap[dist]?.ms ?? null;
        anPB.textContent = pb != null ? msToTime(pb) : "‚Äî";
        anPBMeta.textContent = pb != null ? `${dist} best` : `No PB for ${dist}`;
      }else{
        const allPBs = Object.values(pbMap).map(x => x.ms);
        const best = allPBs.length ? Math.min(...allPBs) : null;
        anPB.textContent = best != null ? msToTime(best) : "‚Äî";
        anPBMeta.textContent = best != null ? "Fastest PB (any distance)" : "No PBs yet";
      }

      drawChart(sortByDateDesc(scoped), dist);
    }

    function renderExport(){
      const ath = getActiveAthlete();
      pillExport.textContent = ath ? `Selected: ${ath.name}` : "No athlete";
    }

    function drawChart(entries, dist){
      const data = [...entries]
        .filter(e => parseTimeToMs(e.time)!=null)
        .sort((a,b)=> new Date(a.date)-new Date(b.date));

      const points = data.map(e => ({
        x: new Date(e.date).getTime(),
        y: parseTimeToMs(e.time)
      }));

      ctx.clearRect(0,0,canvas.width,canvas.height);

      const labelCol = "rgba(15,21,38,.70)";
      const gridCol  = "rgba(15,21,38,.10)";

      if(points.length < 2){
        ctx.fillStyle = labelCol;
        ctx.font = "800 26px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
        ctx.fillText("Add race entries to see trend", 50, 210);
        ctx.fillStyle = "rgba(15,21,38,.55)";
        ctx.font = "700 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
        ctx.fillText(dist === "ALL" ? "Tip: choose a distance for a cleaner line." : `Distance: ${dist}`, 50, 245);
        return;
      }

      const padL = 70, padR=30, padT=28, padB=56;
      const W = canvas.width - padL - padR;
      const H = canvas.height - padT - padB;

      const xs = points.map(p=>p.x);
      const ys = points.map(p=>p.y);

      const minX = Math.min(...xs);
      const maxX = Math.max(...xs);

      let minY = Math.min(...ys);
      let maxY = Math.max(...ys);

      const padY = Math.max(120, (maxY-minY)*0.12);
      minY = minY - padY;
      maxY = maxY + padY;

      ctx.strokeStyle = gridCol;
      ctx.lineWidth = 1;

      const gridCount = 5;
      for(let i=0;i<=gridCount;i++){
        const y = padT + (H/gridCount)*i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL+W, y);
        ctx.stroke();
      }

      ctx.fillStyle = labelCol;
      ctx.font = "800 15px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
      for(let i=0;i<=gridCount;i++){
        const y = padT + (H/gridCount)*i;
        const val = maxY - ( (maxY-minY)/gridCount )*i;
        ctx.fillText(msToTime(Math.round(val)), 14, y+5);
      }

      ctx.fillStyle = labelCol;
      ctx.font = "800 15px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial";
      ctx.fillText(fmtDate(new Date(minX).toISOString().slice(0,10)), padL, canvas.height-18);
      const endLabel = fmtDate(new Date(maxX).toISOString().slice(0,10));
      const endWidth = ctx.measureText(endLabel).width;
      ctx.fillText(endLabel, padL+W-endWidth, canvas.height-18);

      const toX = (x)=> padL + ((x-minX)/(maxX-minX))*W;
      const toY = (y)=> padT + ((maxY-y)/(maxY-minY))*H;

      const grad = ctx.createLinearGradient(padL,0,padL+W,0);
      grad.addColorStop(0, "rgba(47,107,255,.95)");
      grad.addColorStop(1, "rgba(43,183,255,.95)");

      ctx.strokeStyle = grad;
      ctx.lineWidth = 4;
      ctx.beginPath();
      points.forEach((p,idx)=>{
        const x = toX(p.x);
        const y = toY(p.y);
        if(idx===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      points.forEach((p)=>{
        const x = toX(p.x);
        const y = toY(p.y);
        ctx.fillStyle = "rgba(255,255,255,.98)";
        ctx.beginPath();
        ctx.arc(x,y,5,0,Math.PI*2);
        ctx.fill();

        ctx.strokeStyle = "rgba(47,107,255,.35)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x,y,5,0,Math.PI*2);
        ctx.stroke();
      });
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify({ state, prefs }, null, 2)], { type:"application/json" });
      downloadBlob(blob, "PB-VelocityBoard-backup.json");
      flashBanner("JSON backup downloaded.", false);
    }

    function exportCSV(){
      const ath = getActiveAthlete();
      if(!ath){
        flashBanner("No athlete selected.", false);
        return;
      }
      const rows = [["Athlete","BirthYear","Date","Location","Distance","Time","Notes"]];
      for(const e of sortByDateDesc(ath.entries || [])){
        rows.push([ath.name, ath.birthYear || "", e.date, e.location || "", e.distance, e.time, (e.notes||"")]);
      }
      const csv = rows.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type:"text/csv" });
      downloadBlob(blob, `PB-${ath.name.replaceAll(" ","_")}.csv`);
      flashBanner("CSV downloaded.", false);
    }

    function downloadTemplateCSV(){
      const sample = [
        ["Athlete","BirthYear","Date","Location","Distance","Time","Notes"],
        ["Alex","2015","2025-11-29","Kingston","400m","00:52.300","Sample row - replace with your data (optional)"]
      ];
      const csv = sample.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type:"text/csv" });
      downloadBlob(blob, "PB-VelocityBoard-Template.csv");
      flashBanner("Template downloaded.", false);
    }

    function importCSVIntoSelectedAthlete(){
      clearErrors();
      const ath = getActiveAthlete();
      if(!ath){
        showError("importMsg","Please select an athlete first (CSV rows will be added to the selected athlete).");
        return;
      }
      const file = csvFile.files && csvFile.files[0];
      if(!file){
        showError("importMsg","Please choose a CSV file first.");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        try{
          const text = String(reader.result || "");
          const rows = parseCSV(text);
          if(rows.length < 2){
            showError("importMsg","CSV looks empty. Please use the template.");
            return;
          }

          const header = rows[0].map(h => h.trim().toLowerCase());
          const idx = (name) => header.indexOf(name.toLowerCase());

          for(const k of ["date","location","distance","time"]){
            if(idx(k) === -1){
              showError("importMsg",`Missing column "${k}". Please use the template.`);
              return;
            }
          }

          let added = 0;
          for(let i=1;i<rows.length;i++){
            const r = rows[i];
            if(!r || r.every(c => !String(c||"").trim())) continue;

            const date = (r[idx("date")]||"").trim();
            const location = (r[idx("location")]||"").trim();
            const distance = (r[idx("distance")]||"").trim();
            const time = (r[idx("time")]||"").trim();
            const notes = idx("notes") >= 0 ? (r[idx("notes")]||"").trim() : "";

            if(!date || !location || !distance || !time) continue;
            if(parseTimeToMs(time) == null) continue;

            ath.entries.push({
              id: "e_" + Math.random().toString(16).slice(2) + Date.now().toString(16),
              date,
              location,
              distance,
              time,
              notes
            });
            added++;
          }

          saveState();
          flashBanner(`CSV import complete: ${added} row(s) added to ${ath.name}.`, false);
          renderAll();

        }catch(e){
          showError("importMsg","Could not import CSV. Please use the template format.");
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if(ch === '"' ){
          if(inQuotes && next === '"'){
            cur += '"';
            i++;
          }else{
            inQuotes = !inQuotes;
          }
          continue;
        }

        if(!inQuotes && ch === ','){
          row.push(cur);
          cur = "";
          continue;
        }

        if(!inQuotes && (ch === '\n' || ch === '\r')){
          if(ch === '\r' && next === '\n') i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }

        cur += ch;
      }

      row.push(cur);
      rows.push(row);

      while(rows.length && rows[rows.length-1].every(c => !String(c||"").trim())) rows.pop();
      return rows;
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
